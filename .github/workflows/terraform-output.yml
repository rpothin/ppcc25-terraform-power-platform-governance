# Terraform Output Workflow for Power Platform Governance
# This workflow executes a Terraform configuration with data sources and exports the output to JSON
# Designed for migration scenarios to understand current Power Platform state
# It includes validation, safety checks, and comprehensive output processing

name: Terraform Output

# Trigger: Manual workflow dispatch only
# Users can select which configuration to execute for output
on:
  workflow_dispatch:
    inputs:
      configuration:
        description: 'Terraform configuration to execute and export output (data source only configurations)'
        required: true
        type: choice
        options:
          - '01-dlp-policies'
      export_format:
        description: 'Output format for exported data'
        required: true
        type: choice
        options:
          - 'json'
          - 'yaml'
        default: 'json'
      include_metadata:
        description: 'Include execution metadata in output'
        required: true
        type: boolean
        default: true

# Dynamic run name showing the configuration and output format
run-name: ðŸ” Terraform Output for ${{ github.event.inputs.configuration }} (${{ github.event.inputs.export_format }}) by @${{ github.actor }}

# Required permissions for OIDC authentication with Azure and Power Platform
permissions:
  id-token: write   # Required for GitHub OIDC token generation
  contents: write   # Required for repository checkout and committing exported files

# No workflow-level environment variables - secrets are only accessible within jobs that specify the production environment

jobs:
  # Job: Execute Terraform Configuration and Export Output
  # Runs the selected Terraform configuration and exports outputs in specified format
  # Includes validation, safety checks, and comprehensive output processing
  terraform-output:
    runs-on: ubuntu-latest
    environment: production  # Required to access production environment secrets
    
    # Environment variables for Power Platform OIDC authentication
    # These are set at job level and use secrets only from the production environment
    env:
      POWER_PLATFORM_USE_OIDC: true
      POWER_PLATFORM_CLIENT_ID: ${{ secrets.POWER_PLATFORM_CLIENT_ID }}
      POWER_PLATFORM_TENANT_ID: ${{ secrets.POWER_PLATFORM_TENANT_ID }}
      # Azure context for Power Platform resources - using same app registration
      ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      ARM_USE_OIDC: true
    
    # Output values that can be used by dependent workflows
    outputs:
      output-generated: ${{ steps.process-output.outputs.output-generated }}
      output-filename: ${{ steps.process-output.outputs.output-filename }}
      configuration: ${{ github.event.inputs.configuration }}
    
    steps:
    # Step 1: Checkout repository code
    - name: Checkout
      uses: actions/checkout@v4
    
    # Step 2: Validate inputs and configuration
    - name: Validate Inputs
      run: |
        config="${{ github.event.inputs.configuration }}"
        export_format="${{ github.event.inputs.export_format }}"
        
        echo "::notice title=Validation Starting::Validating inputs for output operation..."
        
        # Validate configuration directory exists
        if [ ! -d "configurations/$config" ]; then
          echo "::error title=Configuration Not Found::Configuration directory 'configurations/$config' does not exist. Please check the configuration name."
          exit 1
        fi
        
        # Validate this is a data source only configuration
        if [ "$config" != "01-dlp-policies" ]; then
          echo "::error title=Invalid Configuration Type::Configuration '$config' is not a data source only configuration. Only data source configurations should be used for output operations."
          exit 1
        fi
        
        # Validate export format
        if [[ "$export_format" != "json" && "$export_format" != "yaml" ]]; then
          echo "::error title=Invalid Export Format::Export format '$export_format' is not supported. Supported formats: json, yaml"
          exit 1
        fi
        
        echo "::notice title=Input Validation Complete::âœ… All inputs validated successfully"
        echo "::notice title=Output Target::ðŸŽ¯ Target configuration: $config, Format: $export_format"
    
    # Step 3: Authenticate with Azure using OIDC for backend state storage
    - name: Azure Login with OIDC
      uses: azure/login@v1
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
    
    # Step 4: Add Just-In-Time network access for Terraform backend
    - name: Add JIT Network Access
      id: jit-add
      continue-on-error: true  # Continue even if JIT fails, so we can try without it
      uses: ./.github/actions/jit-network-access
      with:
        action: 'add'
        storage-account-name: ${{ secrets.TERRAFORM_STORAGE_ACCOUNT }}
        resource-group-name: ${{ secrets.TERRAFORM_RESOURCE_GROUP }}
    
    # Step 4b: Check if we need to skip JIT due to permissions
    - name: Check JIT Status and Permissions
      id: jit-status
      run: |
        if [ "${{ steps.jit-add.outcome }}" = "failure" ]; then
          echo "::warning title=JIT Network Access Failed::JIT network access failed. Checking if storage account allows direct access..."
          
          # Check if storage account network rules allow access
          echo "Attempting to list storage account details to test connectivity..."
          if az storage account show \
            --name "${{ secrets.TERRAFORM_STORAGE_ACCOUNT }}" \
            --resource-group "${{ secrets.TERRAFORM_RESOURCE_GROUP }}" \
            --query "networkRuleSet.defaultAction" -o tsv; then
            echo "::notice title=Storage Account Accessible::Storage account is accessible without JIT modifications"
            echo "jit-required=false" >> $GITHUB_OUTPUT
          else
            echo "::error title=Storage Account Inaccessible::Cannot access storage account and JIT setup failed"
            echo "This may be due to:"
            echo "1. Service principal lacks permissions to modify network rules"
            echo "2. Storage account network restrictions are too restrictive"
            echo "3. Network connectivity issues"
            
            # Try to temporarily disable network restrictions as a fallback
            echo "::warning title=Attempting Fallback::Trying to temporarily disable network restrictions..."
            if az storage account update \
              --name "${{ secrets.TERRAFORM_STORAGE_ACCOUNT }}" \
              --resource-group "${{ secrets.TERRAFORM_RESOURCE_GROUP }}" \
              --default-action Allow \
              --output none; then
              echo "::notice title=Fallback Successful::Temporarily disabled network restrictions"
              echo "jit-required=false" >> $GITHUB_OUTPUT
              echo "network-restrictions-disabled=true" >> $GITHUB_OUTPUT
            else
              echo "::error title=Fallback Failed::Cannot disable network restrictions either"
              exit 1
            fi
          fi
        else
          echo "::notice title=JIT Success::JIT network access configured successfully"
          echo "jit-required=true" >> $GITHUB_OUTPUT
          echo "network-restrictions-disabled=false" >> $GITHUB_OUTPUT
        fi
    
    # Step 5: Install and configure Terraform CLI
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: 1.5.0
        terraform_wrapper: false    # Disable wrapper for better JSON output handling
    
    # Step 6: Initialize Terraform and validate configuration
    - name: Initialize and Validate Terraform
      run: |
        config="${{ github.event.inputs.configuration }}"
        
        echo "::notice title=Initializing Terraform::Initializing Terraform for configuration: $config"
        cd "configurations/$config"
        
        # Debug: Check storage account network rules before init
        echo "::group::Pre-Init Storage Account Diagnostics"
        echo "Checking current network rules on storage account..."
        az storage account show \
          --name "${{ secrets.TERRAFORM_STORAGE_ACCOUNT }}" \
          --resource-group "${{ secrets.TERRAFORM_RESOURCE_GROUP }}" \
          --query "networkRuleSet" -o json || echo "Failed to get network rules"
        
        echo "Testing basic connectivity to storage account..."
        az storage account show \
          --name "${{ secrets.TERRAFORM_STORAGE_ACCOUNT }}" \
          --resource-group "${{ secrets.TERRAFORM_RESOURCE_GROUP }}" \
          --query "name" -o tsv && echo "âœ… Storage account accessible" || echo "âŒ Storage account not accessible"
        
        echo "Checking current Azure CLI context:"
        az account show --query "{subscriptionId:id, tenantId:tenantId, user:user}" -o json
        
        echo "Current runner IP (should be in network rules):"
        curl -s https://api.ipify.org
        echo ""
        echo "::endgroup::"
        
        # Add a small delay to ensure network rules are fully propagated
        echo "Waiting 10 seconds for network rules to propagate..."
        sleep 10
        
        # Initialize Terraform with Azure backend for state storage
        terraform init \
          -backend-config="storage_account_name=${{ secrets.TERRAFORM_STORAGE_ACCOUNT }}" \
          -backend-config="container_name=${{ secrets.TERRAFORM_CONTAINER }}" \
          -backend-config="key=output-$config-$(date +%Y%m%d).tfstate" \
          -backend-config="resource_group_name=${{ secrets.TERRAFORM_RESOURCE_GROUP }}" \
          -backend-config="subscription_id=${{ secrets.AZURE_SUBSCRIPTION_ID }}" \
          -backend-config="tenant_id=${{ secrets.AZURE_TENANT_ID }}" \
          -backend-config="use_oidc=true"
        
        # Validate Terraform configuration syntax
        terraform validate
        
        echo "::notice title=Terraform Initialized::âœ… Terraform initialized and validated successfully"
        
        cd - > /dev/null
    
    # Step 7: Create backup of current state (if exists)
    - name: Create State Backup
      run: |
        config="${{ github.event.inputs.configuration }}"
        timestamp=$(date +%Y%m%d-%H%M%S)
        
        cd "configurations/$config"
        
        echo "::notice title=Creating Backup::Creating backup of current state (if exists)..."
        
        # Create backups directory if it doesn't exist
        mkdir -p backups
        
        # Pull current state and create timestamped backup (if state exists)
        if terraform state list > /dev/null 2>&1; then
          backup_filename="backups/terraform.tfstate.backup-$timestamp"
          terraform state pull > "$backup_filename"
          
          if [ -s "$backup_filename" ]; then
            backup_size=$(du -h "$backup_filename" | cut -f1)
            echo "::notice title=Backup Created::âœ… State backup created successfully"
            echo "::notice title=Backup Details::File: $backup_filename, Size: $backup_size"
          else
            echo "::notice title=No State::No existing state to backup"
            rm -f "$backup_filename"
          fi
        else
          echo "::notice title=No Previous State::No existing state found - this is normal for data source only configurations"
        fi
        
        cd - > /dev/null
    
    # Step 8: Execute Terraform configuration
    # Run the selected configuration to query data sources and generate outputs
    - name: Execute Terraform Configuration
      run: |
        config="${{ github.event.inputs.configuration }}"
        
        echo "::notice title=Executing Configuration::Running Terraform for configuration: $config"
        cd "configurations/$config"
        
        # Execute plan to query data sources (no resources will be created/modified)
        echo "::notice title=Planning Configuration::Executing Terraform plan for data source queries"
        terraform plan -out=terraform.tfplan
        
        # Apply the plan (this only reads data sources, no infrastructure changes)
        echo "::notice title=Applying Plan::Applying plan to retrieve current state from data sources"
        terraform apply -auto-approve terraform.tfplan
        
        if [ $? -eq 0 ]; then
          echo "::notice title=Execution Successful::âœ… Terraform configuration executed successfully"
        else
          echo "::error title=Execution Failed::âŒ Terraform configuration execution failed"
          exit 1
        fi
        
        cd - > /dev/null
    
    # Step 9: Extract and process Terraform outputs
    - name: Extract Terraform Outputs
      run: |
        config="${{ github.event.inputs.configuration }}"
        
        cd "configurations/$config"
        
        echo "::notice title=Extracting Outputs::Getting Terraform outputs"
        
        # Extract outputs in JSON format
        terraform output -json > "terraform-output.json" || echo "{}" > "terraform-output.json"
        
        # Display summary
        echo "::group::Output Extraction Summary"
        echo "Configuration: $config"
        echo "Output file size: $(du -h terraform-output.json | cut -f1)"
        
        if [ -s terraform-output.json ] && [ "$(cat terraform-output.json)" != "{}" ]; then
          echo "Output keys:"
          jq -r 'keys[]' terraform-output.json 2>/dev/null || echo "No outputs or invalid JSON"
          
          # Count total items in outputs
          total_items=$(jq '[.. | objects | select(has("value")) | .value] | length' terraform-output.json 2>/dev/null || echo "0")
          echo "Total output items: $total_items"
        else
          echo "No outputs generated"
        fi
        echo "::endgroup::"
        
        cd - > /dev/null
    
    # Step 10: Process and save output in specified format
    - name: Process Terraform Output
      id: process-output
      run: |
        config="${{ github.event.inputs.configuration }}"
        export_format="${{ github.event.inputs.export_format }}"
        include_metadata="${{ github.event.inputs.include_metadata }}"
        timestamp=$(date +%Y%m%d-%H%M%S)
        
        echo "::notice title=Processing Output::Processing Terraform output for configuration: $config"
        
        # Install yq if YAML format is requested
        if [ "$export_format" = "yaml" ]; then
          if ! command -v yq &> /dev/null; then
            echo "::notice title=Installing yq::yq not found, installing for YAML processing..."
            sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
            sudo chmod +x /usr/local/bin/yq
            echo "::notice title=Installation Complete::yq installed successfully"
          fi
        fi
        
        # Check if we have output file
        if [ ! -f "configurations/$config/terraform-output.json" ]; then
          echo "::error title=No Output File::terraform-output.json not found in configurations/$config/"
          exit 1
        fi
        
        cd "configurations/$config"
        
        # Create output filename based on format
        if [ "$export_format" = "yaml" ]; then
          output_filename="terraform-output-$timestamp.yaml"
          latest_filename="terraform-output-latest.yaml"
        else
          output_filename="terraform-output-$timestamp.json"
          latest_filename="terraform-output-latest.json"
        fi
        
        # Process the output based on format and metadata preference
        if [ "$include_metadata" = "true" ]; then
          # Add metadata
          if [ "$export_format" = "yaml" ]; then
            # Convert to YAML with metadata
            jq --arg timestamp "$timestamp" --arg config "$config" '
              {
                "output_metadata": {
                  "timestamp": $timestamp,
                  "configuration": $config,
                  "exported_by": "GitHub Actions",
                  "workflow_run": "${{ github.run_number }}",
                  "export_format": "yaml",
                  "include_metadata": true
                },
                "outputs": .
              }' "terraform-output.json" | yq eval -P > "$output_filename"
          else
            # JSON with metadata
            jq --arg timestamp "$timestamp" --arg config "$config" '
              {
                "output_metadata": {
                  "timestamp": $timestamp,
                  "configuration": $config,
                  "exported_by": "GitHub Actions",
                  "workflow_run": "${{ github.run_number }}",
                  "export_format": "json",
                  "include_metadata": true
                },
                "outputs": .
              }' "terraform-output.json" > "$output_filename"
          fi
        else
          # No metadata - just convert format if needed
          if [ "$export_format" = "yaml" ]; then
            cat "terraform-output.json" | yq eval -P > "$output_filename"
          else
            cp "terraform-output.json" "$output_filename"
          fi
        fi
        
        # Create a latest symlink for easy access
        ln -sf "$output_filename" "$latest_filename"
        
        # Clean up temporary file
        rm "terraform-output.json"
        
        # Set outputs for dependent jobs
        echo "output-generated=true" >> $GITHUB_OUTPUT
        echo "output-filename=$output_filename" >> $GITHUB_OUTPUT
        
        # Display final results
        echo "::notice title=Output Processed::âœ… Terraform output processed successfully"
        echo "::notice title=Output File::$output_filename"
        echo "::notice title=Latest Link::$latest_filename"
        
        # Show statistics
        echo "::group::Output Processing Statistics"
        echo "Configuration: $config"
        echo "Format: $export_format"
        echo "Metadata included: $include_metadata"
        echo "Timestamp: $timestamp"
        echo "File size: $(du -h "$output_filename" | cut -f1)"
        
        # Validate output content
        if [ "$export_format" = "yaml" ]; then
          if yq eval '.' "$output_filename" >/dev/null 2>&1; then
            echo "âœ… Valid YAML output generated"
            if [ "$include_metadata" = "true" ]; then
              echo "Number of outputs: $(yq eval '.outputs | keys | length' "$output_filename" 2>/dev/null || echo "0")"
            else
              echo "Number of outputs: $(yq eval '. | keys | length' "$output_filename" 2>/dev/null || echo "0")"
            fi
          else
            echo "âŒ Invalid YAML generated"
          fi
        else
          if jq '.' "$output_filename" >/dev/null 2>&1; then
            echo "âœ… Valid JSON output generated"
            if [ "$include_metadata" = "true" ]; then
              echo "Number of outputs: $(jq '.outputs | keys | length' "$output_filename" 2>/dev/null || echo "0")"
            else
              echo "Number of outputs: $(jq '. | keys | length' "$output_filename" 2>/dev/null || echo "0")"
            fi
          else
            echo "âŒ Invalid JSON generated"
          fi
        fi
        
        echo "Available output files:"
        ls -la terraform-output-*.* 2>/dev/null || echo "No previous outputs found"
        echo "::endgroup::"
        
        cd - > /dev/null
    
    # Step 11: Remove Just-In-Time network access
    - name: Remove JIT Network Access
      if: always() && steps.jit-status.outputs.jit-required == 'true'  # Only run if JIT was successfully added
      uses: ./.github/actions/jit-network-access
      with:
        action: 'remove'
        storage-account-name: ${{ secrets.TERRAFORM_STORAGE_ACCOUNT }}
        resource-group-name: ${{ secrets.TERRAFORM_RESOURCE_GROUP }}
    
    # Step 11b: Re-enable network restrictions if we disabled them
    - name: Re-enable Network Restrictions
      if: always() && steps.jit-status.outputs.network-restrictions-disabled == 'true'
      run: |
        echo "::notice title=Re-enabling Security::Restoring network restrictions on storage account"
        if az storage account update \
          --name "${{ secrets.TERRAFORM_STORAGE_ACCOUNT }}" \
          --resource-group "${{ secrets.TERRAFORM_RESOURCE_GROUP }}" \
          --default-action Deny \
          --output none; then
          echo "::notice title=Security Restored::âœ… Network restrictions re-enabled successfully"
        else
          echo "::warning title=Security Warning::âš ï¸ Failed to re-enable network restrictions - manual intervention required"
        fi
    
    # Step 12: Commit output files to repository
    - name: Commit Terraform Output
      run: |
        config="${{ github.event.inputs.configuration }}"
        
        # Configure git
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        
        # Add the new output files
        git add "configurations/$config"/terraform-output-*.*
        
        # Check if there are changes to commit
        if git diff --cached --quiet; then
          echo "::notice title=No Changes::No new output data to commit"
        else
          echo "::notice title=Committing Output::Committing Terraform output"
          git commit -m "feat: add terraform output for $config

          Generated Terraform output for configuration:
          - Configuration: $config
          - Format: ${{ github.event.inputs.export_format }}
          - Metadata included: ${{ github.event.inputs.include_metadata }}
          - Timestamp: $(date +%Y-%m-%d\ %H:%M:%S)
          - Exported by: @${{ github.actor }}
          - Workflow run: ${{ github.run_number }}
          
          Auto-generated by Terraform Output workflow"
          
          git push origin main
          echo "::notice title=Output Committed::âœ… Terraform output committed successfully"
        fi
    
    # Step 13: Upload output as workflow artifact
    - name: Upload Terraform Output Artifact
      uses: actions/upload-artifact@v4
      with:
        name: terraform-output-${{ github.event.inputs.configuration }}-${{ github.run_number }}
        path: configurations/${{ github.event.inputs.configuration }}/terraform-output-*.*
        retention-days: 30    # Keep outputs for 30 days for reference
    
    # Step 14: Generate comprehensive execution summary
    - name: Generate Execution Summary
      run: |
        config="${{ github.event.inputs.configuration }}"
        export_format="${{ github.event.inputs.export_format }}"
        include_metadata="${{ github.event.inputs.include_metadata }}"
        
        echo "::notice title=Execution Summary::âœ… Terraform output workflow completed successfully"
        
        echo "## ðŸ” Terraform Output Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Execution Details" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Parameter | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| Configuration | \`$config\` |" >> $GITHUB_STEP_SUMMARY
        echo "| Export Format | \`$export_format\` |" >> $GITHUB_STEP_SUMMARY
        echo "| Include Metadata | $include_metadata |" >> $GITHUB_STEP_SUMMARY
        echo "| Timestamp | $(date +%Y-%m-%d\ %H:%M:%S) |" >> $GITHUB_STEP_SUMMARY
        echo "| Executed by | @${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Workflow run | [${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Find the latest output file
        if [ "$export_format" = "yaml" ]; then
          latest_output=$(find "configurations/$config" -name "terraform-output-*.yaml" -type f | sort | tail -1)
        else
          latest_output=$(find "configurations/$config" -name "terraform-output-*.json" -type f | sort | tail -1)
        fi
        
        if [ -n "$latest_output" ] && [ -f "$latest_output" ]; then
          echo "### âœ… Output Content" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Detail | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **File** | \`$(basename "$latest_output")\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Size** | $(du -h "$latest_output" | cut -f1) |" >> $GITHUB_STEP_SUMMARY
          echo "| **Format** | $export_format |" >> $GITHUB_STEP_SUMMARY
          
          # Check if outputs exist and are valid
          if [ "$export_format" = "yaml" ]; then
            if yq eval '.' "$latest_output" >/dev/null 2>&1; then
              if [ "$include_metadata" = "true" ]; then
                output_count=$(yq eval '.outputs | keys | length' "$latest_output" 2>/dev/null || echo "0")
              else
                output_count=$(yq eval '. | keys | length' "$latest_output" 2>/dev/null || echo "0")
              fi
              echo "| **Number of outputs** | $output_count |" >> $GITHUB_STEP_SUMMARY
              
              if [ "$output_count" -gt 0 ]; then
                echo "" >> $GITHUB_STEP_SUMMARY
                echo "### ðŸ“‹ Available Outputs" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
                if [ "$include_metadata" = "true" ]; then
                  yq eval '.outputs | keys[]' "$latest_output" 2>/dev/null | sed 's/^/- /' >> $GITHUB_STEP_SUMMARY || echo "- Unable to parse output keys" >> $GITHUB_STEP_SUMMARY
                else
                  yq eval '. | keys[]' "$latest_output" 2>/dev/null | sed 's/^/- /' >> $GITHUB_STEP_SUMMARY || echo "- Unable to parse output keys" >> $GITHUB_STEP_SUMMARY
                fi
              fi
            else
              echo "| **Status** | âŒ Invalid YAML generated |" >> $GITHUB_STEP_SUMMARY
            fi
          else
            if jq '.' "$latest_output" >/dev/null 2>&1; then
              if [ "$include_metadata" = "true" ]; then
                output_count=$(jq '.outputs | keys | length' "$latest_output" 2>/dev/null || echo "0")
              else
                output_count=$(jq '. | keys | length' "$latest_output" 2>/dev/null || echo "0")
              fi
              echo "| **Number of outputs** | $output_count |" >> $GITHUB_STEP_SUMMARY
              
              if [ "$output_count" -gt 0 ]; then
                echo "" >> $GITHUB_STEP_SUMMARY
                echo "### ðŸ“‹ Available Outputs" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
                if [ "$include_metadata" = "true" ]; then
                  jq -r '.outputs | keys[]' "$latest_output" 2>/dev/null | sed 's/^/- /' >> $GITHUB_STEP_SUMMARY || echo "- Unable to parse output keys" >> $GITHUB_STEP_SUMMARY
                else
                  jq -r '. | keys[]' "$latest_output" 2>/dev/null | sed 's/^/- /' >> $GITHUB_STEP_SUMMARY || echo "- Unable to parse output keys" >> $GITHUB_STEP_SUMMARY
                fi
              fi
            else
              echo "| **Status** | âŒ Invalid JSON generated |" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ Usage" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The Terraform output is available in:" >> $GITHUB_STEP_SUMMARY
          echo "- **Repository**: \`configurations/$config/$(basename "$latest_output")\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Latest link**: \`configurations/$config/terraform-output-latest.$export_format\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Workflow artifact**: Available for 30 days" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“– Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. **Review Output**: Examine the exported data for migration planning" >> $GITHUB_STEP_SUMMARY
          echo "2. **Configuration Mapping**: Map current state to desired Infrastructure as Code configurations" >> $GITHUB_STEP_SUMMARY
          echo "3. **Migration Planning**: Use the output to plan migration strategies" >> $GITHUB_STEP_SUMMARY
          echo "4. **Documentation**: Document any findings for governance and compliance" >> $GITHUB_STEP_SUMMARY
        else
          echo "### âŒ Output Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "No output file found. Check the execution logs for errors." >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âš ï¸ Important Notes" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Data Source Only**: This configuration only reads existing Power Platform resources" >> $GITHUB_STEP_SUMMARY
        echo "- **No Infrastructure Changes**: No resources were created, modified, or deleted" >> $GITHUB_STEP_SUMMARY
        echo "- **Migration Context**: Output is designed for migration and governance planning" >> $GITHUB_STEP_SUMMARY
        echo "- **State Backup**: State backup was created for audit trail purposes" >> $GITHUB_STEP_SUMMARY
