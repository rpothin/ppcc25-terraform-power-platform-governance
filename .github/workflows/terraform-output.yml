# Terraform Output Workflow for Power Platform Governance
# This workflow executes a Terraform configuration with data sources and exports the output to JSON
# Designed for migration scenarios to understand current Power Platform state
# It includes validation, safety checks, and comprehensive output processing

name: Terraform Output

# Trigger: Manual workflow dispatch only
# Users can select which configuration to execute for output
on:
  workflow_dispatch:
    inputs:
      configuration:
        description: 'Terraform configuration to execute and export output (data source only configurations)'
        required: true
        type: choice
        options:
          - '01-dlp-policies'
      export_format:
        description: 'Output format for exported data'
        required: true
        type: choice
        options:
          - 'json'
          - 'yaml'
        default: 'json'
      include_metadata:
        description: 'Include execution metadata in output'
        required: true
        type: boolean
        default: true

# Dynamic run name showing the configuration and output format
run-name: ðŸ” Terraform Output for ${{ github.event.inputs.configuration }} (${{ github.event.inputs.export_format }}) by @${{ github.actor }}

# Required permissions for OIDC authentication with Azure and Power Platform
permissions:
  id-token: write   # Required for GitHub OIDC token generation
  contents: write   # Required for repository checkout and committing exported files

# No workflow-level environment variables - secrets are only accessible within jobs that specify the production environment

jobs:
  # Job: Execute Terraform Configuration and Export Output
  # Runs the selected Terraform configuration and exports outputs in specified format
  # Includes validation, safety checks, and comprehensive output processing
  terraform-output:
    runs-on: ubuntu-latest
    environment: production  # Required to access production environment secrets
    
    # Environment variables for Power Platform OIDC authentication
    # These are set at job level and use secrets only from the production environment
    env:
      POWER_PLATFORM_USE_OIDC: true
      POWER_PLATFORM_CLIENT_ID: ${{ secrets.POWER_PLATFORM_CLIENT_ID }}
      POWER_PLATFORM_TENANT_ID: ${{ secrets.POWER_PLATFORM_TENANT_ID }}
      # Azure context for Power Platform resources - using same app registration
      ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      ARM_USE_OIDC: true
    
    # Output values that can be used by dependent workflows
    outputs:
      output-generated: ${{ steps.process-output.outputs.output-generated }}
      output-filename: ${{ steps.process-output.outputs.output-filename }}
      configuration: ${{ github.event.inputs.configuration }}
      # Execution metadata for workflow tracking and AVM compliance
      output-metadata: ${{ steps.process-output.outputs.output-metadata }}
    
    steps:
    # Step 1: Checkout repository code
    - name: Checkout Repository for Output Generation
      uses: actions/checkout@v4
    
    # Step 2: Validate inputs and configuration
    - name: Validate Output Parameters
      run: |
        config="${{ github.event.inputs.configuration }}"
        export_format="${{ github.event.inputs.export_format }}"
        
        echo "::notice title=Validation Starting::Validating inputs for output operation..."
        
        # Validate configuration directory exists
        if [ ! -d "configurations/$config" ]; then
          echo "::error title=Configuration Not Found::Directory 'configurations/$config' missing"
          exit 1
        fi
        
        # Validate export format
        if [[ "$export_format" != "json" && "$export_format" != "yaml" ]]; then
          echo "::error title=Invalid Export Format::Unsupported format '$export_format'"
          exit 1
        fi
        
        echo "::notice title=Input Validation Complete::âœ… All inputs validated successfully"
        echo "::notice title=Output Target::ðŸŽ¯ Target configuration: $config, Format: $export_format"
    
    # Step 3: Authenticate with Azure using OIDC for backend state storage
    - name: Azure Login with OIDC
      uses: azure/login@v2
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
    
    # Step 4: Add Just-In-Time network access for Terraform backend
    - name: Add JIT Network Access
      id: jit-add
      uses: ./.github/actions/jit-network-access
      with:
        action: 'add'
        storage-account-name: ${{ secrets.TERRAFORM_STORAGE_ACCOUNT }}
        resource-group-name: ${{ secrets.TERRAFORM_RESOURCE_GROUP }}
    
    # Step 5: Setup yq for YAML processing (if needed)
    - name: Setup yq
      if: github.event.inputs.export_format == 'yaml'
      uses: mikefarah/yq@v4.46.1
    
    # Step 6: Install and configure Terraform CLI
    - name: Setup Terraform CLI for Output Generation
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: 1.5.0
        terraform_wrapper: false    # Disable wrapper for better JSON output handling
    
    # Step 7: Initialize Terraform and validate configuration
    - name: Initialize and Validate Terraform
      run: |
        config="${{ github.event.inputs.configuration }}"
        
        echo "::notice title=Initializing Terraform::Initializing Terraform for configuration: $config"
        cd "configurations/$config"
        
        # Add a small delay to ensure network rules are fully propagated
        echo "Waiting 10 seconds for network rules to propagate..."
        sleep 10
        
        # Initialize Terraform with Azure backend for state storage
        terraform init \
          -backend-config="storage_account_name=${{ secrets.TERRAFORM_STORAGE_ACCOUNT }}" \
          -backend-config="container_name=${{ secrets.TERRAFORM_CONTAINER }}" \
          -backend-config="key=output-$config-$(date +%Y%m%d).tfstate" \
          -backend-config="resource_group_name=${{ secrets.TERRAFORM_RESOURCE_GROUP }}" \
          -backend-config="subscription_id=${{ secrets.AZURE_SUBSCRIPTION_ID }}" \
          -backend-config="tenant_id=${{ secrets.AZURE_TENANT_ID }}" \
          -backend-config="use_oidc=true"
        
        # Validate Terraform configuration syntax
        terraform validate
        
        echo "::notice title=Terraform Initialized::âœ… Terraform initialized and validated successfully"
        
        cd - > /dev/null
    
    # Step 8: Create backup of current state (if exists)
    - name: Create State Backup for Output Generation
      run: |
        config="${{ github.event.inputs.configuration }}"
        
        cd "configurations/$config"
        
        echo "::notice title=Creating Backup::Creating backup of current state (if exists)..."
        
        # Simple state backup for audit trail
        if terraform state list > /dev/null 2>&1; then
          mkdir -p backups
          terraform state pull > "backups/terraform.tfstate.backup-$(date +%Y%m%d-%H%M%S)"
          echo "::notice title=Backup Created::âœ… State backup created for audit trail"
        else
          echo "::notice title=No Previous State::No existing state found - this is normal for data source only configurations"
        fi
        
        cd - > /dev/null
    
    # Step 9: Execute Terraform configuration
    # Run the selected configuration to query data sources and generate outputs
    - name: Execute Terraform Configuration
      run: |
        config="${{ github.event.inputs.configuration }}"
        
        echo "::notice title=Executing Configuration::Running Terraform for configuration: $config"
        cd "configurations/$config"
        
        # Execute plan to query data sources (no resources will be created/modified)
        echo "::notice title=Planning Configuration::Executing Terraform plan for data source queries"
        terraform plan -out=terraform.tfplan
        
        # Apply the plan (this only reads data sources, no infrastructure changes)
        echo "::notice title=Applying Plan::Applying plan to retrieve current state from data sources"
        terraform apply -auto-approve terraform.tfplan
        
        if [ $? -eq 0 ]; then
          echo "::notice title=Execution Successful::âœ… Terraform configuration executed successfully"
        else
          echo "::error title=Terraform Failed::Configuration execution failed"
          exit 1
        fi
        
        cd - > /dev/null
    
    # Step 10: Extract and Process Terraform Output (Consolidated)
    - name: Extract and Process Terraform Output
      id: process-output
      run: |
        config="${{ github.event.inputs.configuration }}"
        export_format="${{ github.event.inputs.export_format }}"
        include_metadata="${{ github.event.inputs.include_metadata }}"
        timestamp=$(date +%Y%m%d-%H%M%S)
        
        echo "::notice title=Processing Output::Extracting and processing Terraform output for configuration: $config"
        cd "configurations/$config"
        
        # Generate comprehensive execution metadata for AVM compliance
        current_timestamp=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
        terraform_version=$(terraform --version | head -1 | sed 's/Terraform v//')
        
        # Create comprehensive metadata object for output operation
        output_metadata_json=$(cat <<EOF
{
  "generated_at": "$current_timestamp",
  "workflow_run": "${{ github.run_number }}",
  "workflow_id": "${{ github.run_id }}",
  "generated_by": "${{ github.actor }}",
  "terraform_version": "$terraform_version",
  "workflow_version": "1.0.0",
  "configuration": "$config",
  "repository": "${{ github.repository }}",
  "ref": "${{ github.ref }}",
  "sha": "${{ github.sha }}",
  "event": "${{ github.event_name }}",
  "runner_os": "${{ runner.os }}",
  "runner_arch": "${{ runner.arch }}",
  "operation": "output",
  "export_format": "$export_format",
  "include_metadata": $include_metadata
}
EOF
        )
        
        echo "output-metadata<<EOF" >> $GITHUB_OUTPUT
        echo "$output_metadata_json" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
        echo "::notice title=Metadata Generated::ðŸ“Š Output metadata created for AVM compliance"
        
        # Extract outputs and determine final filename
        echo "::notice title=Extracting Outputs::Getting Terraform outputs"
        terraform output -json > "terraform-output-raw.json" || echo "{}" > "terraform-output-raw.json"
        
        if [ "$export_format" = "yaml" ]; then
          output_filename="terraform-output.yaml"
        else
          output_filename="terraform-output.json"
        fi
        
        # Process based on format and metadata preference
        if [ "$include_metadata" = "true" ]; then
          # Add comprehensive metadata and convert format in one operation
          if [ "$export_format" = "yaml" ]; then
            # Create JSON with comprehensive metadata first, then convert to YAML
            if jq --version >/dev/null 2>&1 && yq --version >/dev/null 2>&1; then
              echo "$output_metadata_json" | jq --slurpfile outputs terraform-output-raw.json '. + {
                "outputs": $outputs[0]
              }' | yq -P > "$output_filename"
              echo "::notice title=YAML with Metadata::âœ… Successfully created YAML with comprehensive metadata"
            else
              echo "::error title=Tools Not Available::jq or yq command not found"
              exit 1
            fi
          else
            echo "$output_metadata_json" | jq --slurpfile outputs terraform-output-raw.json '. + {
              "outputs": $outputs[0]
            }' > "$output_filename"
            echo "::notice title=JSON with Metadata::âœ… Successfully created JSON with comprehensive metadata"
          fi
          
          # Create separate metadata file for artifact
          echo "$output_metadata_json" > "output-metadata.json"
        else
          # Direct format conversion without metadata
          if [ "$export_format" = "yaml" ]; then
            # Test yq command and provide fallback
            if yq --version >/dev/null 2>&1; then
              cat "terraform-output-raw.json" | yq -P > "$output_filename"
              echo "::notice title=YAML Conversion::âœ… Successfully converted JSON to YAML using yq"
            else
              echo "::error title=YQ Not Available::yq command not found, cannot convert to YAML"
              exit 1
            fi
          else
            cp "terraform-output-raw.json" "$output_filename"
          fi
        fi
        
        # Verify output file was created and set outputs
        if [ -f "$output_filename" ]; then
          echo "output-generated=true" >> $GITHUB_OUTPUT
          echo "output-filename=$output_filename" >> $GITHUB_OUTPUT
          echo "::notice title=Output Complete::âœ… Output processed successfully: $output_filename"
        else
          echo "::error title=Output Failed::Unable to create $output_filename"
          exit 1
        fi
        
        # Cleanup temporary file
        rm -f "terraform-output-raw.json"
        cd - > /dev/null
    
    # Step 11: Remove Just-In-Time network access
    - name: Remove JIT Network Access
      if: always()
      uses: ./.github/actions/jit-network-access
      with:
        action: 'remove'
        storage-account-name: ${{ secrets.TERRAFORM_STORAGE_ACCOUNT }}
        resource-group-name: ${{ secrets.TERRAFORM_RESOURCE_GROUP }}
    
    # Step 12: Commit output files to repository
    - name: Commit Terraform Output
      run: |
        config="${{ github.event.inputs.configuration }}"
        export_format="${{ github.event.inputs.export_format }}"
        
        # Configure git
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        
        # Determine the expected output filename (matching Step 10 logic)
        if [ "$export_format" = "yaml" ]; then
          expected_file="configurations/$config/terraform-output.yaml"
        else
          expected_file="configurations/$config/terraform-output.json"
        fi
        
        # Add the specific output file (trusting Step 9 validation)
        echo "::notice title=Adding File::Adding $expected_file to git"
        git add "$expected_file"
        
        # Check if there are changes to commit
        if git diff --cached --quiet; then
          echo "::notice title=No Changes::No new output data to commit (file content unchanged)"
        else
          echo "::notice title=Committing Output::Committing Terraform output"
          
          # Create commit message
          commit_msg="feat: update terraform output for $config

          Updated Terraform output for configuration:
          - Configuration: $config
          - Format: $export_format
          - Metadata included: ${{ github.event.inputs.include_metadata }}
          - Timestamp: $(date +%Y-%m-%d\ %H:%M:%S)
          - Exported by: @${{ github.actor }}
          - Workflow run: ${{ github.run_number }}

          Auto-generated by Terraform Output workflow"
          
          git commit -m "$commit_msg"
          git push origin main
          echo "::notice title=Output Committed::âœ… Terraform output committed successfully"
        fi
    
    # Step 13: Upload output as workflow artifact
    - name: Upload Terraform Output Artifact
      uses: actions/upload-artifact@v4
      with:
        name: terraform-output-${{ github.event.inputs.configuration }}-${{ github.run_number }}
        path: |
          configurations/${{ github.event.inputs.configuration }}/terraform-output.json
          configurations/${{ github.event.inputs.configuration }}/terraform-output.yaml
          configurations/${{ github.event.inputs.configuration }}/output-metadata.json
        retention-days: 30    # Keep outputs for 30 days for reference
        description: 'Exported Terraform output data from ${{ github.event.inputs.configuration }} in ${{ github.event.inputs.export_format }} format - contains resource information for integration and reference with execution metadata'
        if-no-files-found: ignore  # Don't fail if only one format exists
    
    # Step 14: Generate comprehensive execution summary
    - name: Generate Execution Summary
      run: |
        config="${{ github.event.inputs.configuration }}"
        export_format="${{ github.event.inputs.export_format }}"
        include_metadata="${{ github.event.inputs.include_metadata }}"
        
        echo "::notice title=Execution Summary::âœ… Terraform output workflow completed successfully"
        
        echo "## ðŸ” Terraform Output Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Execution Details" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Parameter | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| Configuration | \`$config\` |" >> $GITHUB_STEP_SUMMARY
        echo "| Export Format | \`$export_format\` |" >> $GITHUB_STEP_SUMMARY
        echo "| Include Metadata | $include_metadata |" >> $GITHUB_STEP_SUMMARY
        echo "| Timestamp | $(date +%Y-%m-%d\ %H:%M:%S) |" >> $GITHUB_STEP_SUMMARY
        echo "| Executed by | @${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Workflow run | [${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Use output file information from Step 10
        if [ "$export_format" = "yaml" ]; then
          latest_output="configurations/$config/terraform-output.yaml"
        else
          latest_output="configurations/$config/terraform-output.json"
        fi
        
        # Generate output content section (trusting Step 10 validation)
        if [ -f "$latest_output" ]; then
          echo "### âœ… Output Content" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Detail | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **File** | \`$(basename "$latest_output")\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Size** | $(du -h "$latest_output" | cut -f1) |" >> $GITHUB_STEP_SUMMARY
          echo "| **Format** | $export_format |" >> $GITHUB_STEP_SUMMARY
          
          # Check if outputs exist and are valid
          if [ "$export_format" = "yaml" ]; then
            if yq eval '.' "$latest_output" >/dev/null 2>&1; then
              if [ "$include_metadata" = "true" ]; then
                output_count=$(yq eval '.outputs | keys | length' "$latest_output" 2>/dev/null || echo "0")
              else
                output_count=$(yq eval '. | keys | length' "$latest_output" 2>/dev/null || echo "0")
              fi
              echo "| **Number of outputs** | $output_count |" >> $GITHUB_STEP_SUMMARY
              
              if [ "$output_count" -gt 0 ]; then
                echo "" >> $GITHUB_STEP_SUMMARY
                echo "### ðŸ“‹ Available Outputs" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
                if [ "$include_metadata" = "true" ]; then
                  yq eval '.outputs | keys[]' "$latest_output" 2>/dev/null | sed 's/^/- /' >> $GITHUB_STEP_SUMMARY || echo "- Unable to parse output keys" >> $GITHUB_STEP_SUMMARY
                else
                  yq eval '. | keys[]' "$latest_output" 2>/dev/null | sed 's/^/- /' >> $GITHUB_STEP_SUMMARY || echo "- Unable to parse output keys" >> $GITHUB_STEP_SUMMARY
                fi
              fi
            else
              echo "| **Status** | âŒ Invalid YAML generated |" >> $GITHUB_STEP_SUMMARY
            fi
          else
            if jq '.' "$latest_output" >/dev/null 2>&1; then
              if [ "$include_metadata" = "true" ]; then
                output_count=$(jq '.outputs | keys | length' "$latest_output" 2>/dev/null || echo "0")
              else
                output_count=$(jq '. | keys | length' "$latest_output" 2>/dev/null || echo "0")
              fi
              echo "| **Number of outputs** | $output_count |" >> $GITHUB_STEP_SUMMARY
              
              if [ "$output_count" -gt 0 ]; then
                echo "" >> $GITHUB_STEP_SUMMARY
                echo "### ðŸ“‹ Available Outputs" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
                if [ "$include_metadata" = "true" ]; then
                  jq -r '.outputs | keys[]' "$latest_output" 2>/dev/null | sed 's/^/- /' >> $GITHUB_STEP_SUMMARY || echo "- Unable to parse output keys" >> $GITHUB_STEP_SUMMARY
                else
                  jq -r '. | keys[]' "$latest_output" 2>/dev/null | sed 's/^/- /' >> $GITHUB_STEP_SUMMARY || echo "- Unable to parse output keys" >> $GITHUB_STEP_SUMMARY
                fi
              fi
            else
              echo "| **Status** | âŒ Invalid JSON generated |" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ Usage" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The Terraform output is available in:" >> $GITHUB_STEP_SUMMARY
          echo "- **Repository**: \`configurations/$config/$(basename "$latest_output")\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Workflow artifact**: Available for 30 days" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“– Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. **Review Output**: Examine the exported data for migration planning" >> $GITHUB_STEP_SUMMARY
          echo "2. **Configuration Mapping**: Map current state to desired Infrastructure as Code configurations" >> $GITHUB_STEP_SUMMARY
          echo "3. **Migration Planning**: Use the output to plan migration strategies" >> $GITHUB_STEP_SUMMARY
          echo "4. **Documentation**: Document any findings for governance and compliance" >> $GITHUB_STEP_SUMMARY
        else
          echo "### âŒ Output Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "No output file found. This should not happen if Step 10 completed successfully." >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âš ï¸ Important Notes" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Data Source Only**: This configuration only reads existing Power Platform resources" >> $GITHUB_STEP_SUMMARY
        echo "- **No Infrastructure Changes**: No resources were created, modified, or deleted" >> $GITHUB_STEP_SUMMARY
        echo "- **Migration Context**: Output is designed for migration and governance planning" >> $GITHUB_STEP_SUMMARY
        echo "- **State Backup**: State backup was created for audit trail purposes" >> $GITHUB_STEP_SUMMARY
