# Terraform Output Workflow for Power Platform Governance
# This workflow executes a Terraform configuration with data sources and exports the output to JSON/YAML
# Designed for migration scenarios to understand current Power Platform state

name: Terraform Output

# Prevent concurrent Terraform operations on same configuration
concurrency:
  group: terraform-${{ github.event.inputs.configuration || 'default' }}-output-${{ github.ref }}
  cancel-in-progress: false  # Don't cancel running Terraform operations

# Trigger: Manual workflow dispatch only
# Users can select which configuration to execute for output
on:
  workflow_dispatch:
    inputs:
      configuration:
        description: 'Terraform configuration to execute and export output (data source only configurations)'
        required: true
        type: choice
        options:
          - '01-dlp-policies'
      export_format:
        description: 'Output format for exported data'
        required: true
        type: choice
        options:
          - 'json'
          - 'yaml'
        default: 'json'
      include_metadata:
        description: 'Include execution metadata in output'
        required: true
        type: boolean
        default: true

# Dynamic run name showing the configuration and output format
run-name: ðŸ” Terraform Output for ${{ github.event.inputs.configuration }} (${{ github.event.inputs.export_format }}) by @${{ github.actor }}

# Required permissions for OIDC authentication with Azure and Power Platform
permissions:
  id-token: write   # Required for GitHub OIDC token generation
  contents: write   # Required for repository checkout and committing exported files

jobs:
  # Job 1: Execute Terraform Output using Reusable Workflow
  # Uses the standardized reusable-terraform-base workflow for consistent operation
  terraform-output:
    name: ðŸ” Extract Terraform Output
    uses: ./.github/workflows/reusable-terraform-base.yml
    with:
      operation: 'output'
      configuration: ${{ github.event.inputs.configuration }}
      additional-options: '-json'  # Always get JSON output for processing
      state-key-override: 'output-${{ github.event.inputs.configuration }}.tfstate'
      timeout-minutes: 10
      environment-name: 'production'
    secrets: inherit
  
  # Job 2: Process and Format Output
  # Handles format conversion, metadata inclusion, and file commitment
  process-and-commit-output:
    name: ðŸ“„ Process and Commit Output Files
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: terraform-output
    if: needs.terraform-output.outputs.operation-successful == 'true'
    
    # Output values that can be used by dependent workflows
    outputs:
      output-generated: ${{ steps.process-output.outputs.output-generated }}
      output-filename: ${{ steps.process-output.outputs.output-filename }}
      configuration: ${{ github.event.inputs.configuration }}
      output-metadata: ${{ steps.process-output.outputs.output-metadata }}
    
    steps:
      # Step 1: Checkout repository for file operations
      - name: Checkout Repository for Processing
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for proper commit operations
      
      # Step 2: Setup yq for YAML processing (if needed)
      - name: Setup yq for YAML Processing
        if: github.event.inputs.export_format == 'yaml'
        uses: mikefarah/yq@v4.46.1
      
      # Step 3: Process Terraform Output
      - name: Process and Format Terraform Output
        id: process-output
        run: |
          config="${{ github.event.inputs.configuration }}"
          export_format="${{ github.event.inputs.export_format }}"
          include_metadata="${{ github.event.inputs.include_metadata }}"
          
          echo "::notice title=Processing Output::ðŸ”„ Processing Terraform output for configuration: $config"
          echo "::notice title=Format::ðŸ“„ Export format: $export_format"
          echo "::notice title=Metadata::ðŸ“Š Include metadata: $include_metadata"
          
          # Get raw JSON output from the reusable workflow
          raw_output='${{ needs.terraform-output.outputs.terraform-output }}'
          
          if [ -z "$raw_output" ] || [ "$raw_output" = "null" ]; then
            echo "::error title=No Output::âŒ No Terraform output received from reusable workflow"
            exit 1
          fi
          
          # Create output directory structure
          mkdir -p "configurations/$config/outputs"
          
          # Generate timestamp for file naming
          timestamp=$(date +%Y%m%d-%H%M%S)
          
          # Process output based on format
          if [ "$export_format" = "json" ]; then
            output_filename="terraform-output-$timestamp.json"
            output_path="configurations/$config/outputs/$output_filename"
            
            if [ "$include_metadata" = "true" ]; then
              # Create enhanced output with metadata
              enhanced_output=$(jq -n \
                --argjson terraform_output "$raw_output" \
                --arg timestamp "$(date -u +"%Y-%m-%dT%H:%M:%SZ")" \
                --arg configuration "$config" \
                --arg workflow_run "${{ github.run_number }}" \
                --arg generated_by "${{ github.actor }}" \
                --arg repository "${{ github.repository }}" \
                --arg ref "${{ github.ref }}" \
                --arg sha "${{ github.sha }}" \
                '{
                  "metadata": {
                    "generated_at": $timestamp,
                    "configuration": $configuration,
                    "workflow_run": $workflow_run,
                    "generated_by": $generated_by,
                    "repository": $repository,
                    "ref": $ref,
                    "sha": $sha,
                    "export_format": "json"
                  },
                  "terraform_output": $terraform_output
                }'
              )
              echo "$enhanced_output" | jq '.' > "$output_path"
            else
              # Just the raw Terraform output
              echo "$raw_output" | jq '.' > "$output_path"
            fi
            
            echo "::notice title=JSON Created::ðŸ“„ JSON output created: $output_path"
            
          elif [ "$export_format" = "yaml" ]; then
            output_filename="terraform-output-$timestamp.yaml"
            output_path="configurations/$config/outputs/$output_filename"
            
            if [ "$include_metadata" = "true" ]; then
              # Create enhanced output with metadata
              enhanced_output=$(jq -n \
                --argjson terraform_output "$raw_output" \
                --arg timestamp "$(date -u +"%Y-%m-%dT%H:%M:%SZ")" \
                --arg configuration "$config" \
                --arg workflow_run "${{ github.run_number }}" \
                --arg generated_by "${{ github.actor }}" \
                --arg repository "${{ github.repository }}" \
                --arg ref "${{ github.ref }}" \
                --arg sha "${{ github.sha }}" \
                '{
                  "metadata": {
                    "generated_at": $timestamp,
                    "configuration": $configuration,
                    "workflow_run": $workflow_run,
                    "generated_by": $generated_by,
                    "repository": $repository,
                    "ref": $ref,
                    "sha": $sha,
                    "export_format": "yaml"
                  },
                  "terraform_output": $terraform_output
                }'
              )
              echo "$enhanced_output" | yq eval -P '.' > "$output_path"
            else
              # Just the raw Terraform output
              echo "$raw_output" | yq eval -P '.' > "$output_path"
            fi
            
            echo "::notice title=YAML Created::ðŸ“„ YAML output created: $output_path"
          fi
          
          # Generate processing metadata
          processing_metadata=$(jq -n \
            --arg timestamp "$(date -u +"%Y-%m-%dT%H:%M:%SZ")" \
            --arg configuration "$config" \
            --arg export_format "$export_format" \
            --arg output_filename "$output_filename" \
            --arg workflow_run "${{ github.run_number }}" \
            --arg generated_by "${{ github.actor }}" \
            --argjson include_metadata "$include_metadata" \
            '{
              "processing": {
                "processed_at": $timestamp,
                "configuration": $configuration,
                "export_format": $export_format,
                "output_filename": $output_filename,
                "include_metadata": $include_metadata,
                "workflow_run": $workflow_run,
                "generated_by": $generated_by
              }
            }'
          )
          
          # Set outputs
          echo "output-generated=true" >> $GITHUB_OUTPUT
          echo "output-filename=$output_filename" >> $GITHUB_OUTPUT
          {
            echo "output-metadata<<METADATA_EOF"
            echo "$processing_metadata"
            echo "METADATA_EOF"
          } >> $GITHUB_OUTPUT
          
          echo "::notice title=Processing Complete::âœ… Output processing completed successfully"
      
      # Step 4: Commit output files to repository
      - name: Commit Generated Output Files
        run: |
          config="${{ github.event.inputs.configuration }}"
          output_filename="${{ steps.process-output.outputs.output-filename }}"
          export_format="${{ github.event.inputs.export_format }}"
          
          # Configure git for commit
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          # Add generated output files
          git add "configurations/$config/outputs/$output_filename"
          
          # Check if there are changes to commit
          if ! git diff --cached --quiet; then
            git commit -m "feat(output): generate $export_format output for $config configuration
          
          Configuration: $config
          Output File: $output_filename
          Export Format: $export_format
          Include Metadata: ${{ github.event.inputs.include_metadata }}
          Generated At: $(date -u +"%Y-%m-%dT%H:%M:%SZ")
          Workflow Run: ${{ github.run_number }}
          Executed By: @${{ github.actor }}
          
          This output was generated automatically by the Terraform Output workflow
          for migration and state analysis purposes."
            git push origin main
            
            echo "::notice title=Files Committed::ðŸ“ Output files committed to repository"
            echo "::notice title=Commit Details::ðŸ“‹ File: $output_filename, Format: $export_format"
          else
            echo "::notice title=No Changes::â„¹ï¸ No new output files to commit"
          fi
      
      # Step 5: Upload output as workflow artifact
      - name: Upload Terraform Output Artifact
        uses: actions/upload-artifact@v4
        with:
          name: terraform-output-${{ github.event.inputs.configuration }}-${{ github.run_number }}
          path: |
            configurations/${{ github.event.inputs.configuration }}/outputs/terraform-output-*.json
            configurations/${{ github.event.inputs.configuration }}/outputs/terraform-output-*.yaml
          retention-days: 30
          if-no-files-found: ignore  # Don't fail if only one format exists
          compression-level: 6
      
      # Step 6: Generate comprehensive execution summary
      - name: Generate Execution Summary
        run: |
          config="${{ github.event.inputs.configuration }}"
          export_format="${{ github.event.inputs.export_format }}"
          output_filename="${{ steps.process-output.outputs.output-filename }}"
          include_metadata="${{ github.event.inputs.include_metadata }}"
          
          echo "## ðŸ” Terraform Output Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Output Generation Details" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Parameter | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Configuration | \`$config\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Export Format | \`$export_format\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Output File | \`$output_filename\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Include Metadata | \`$include_metadata\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Generated At | $(date +%Y-%m-%d\ %H:%M:%S) |" >> $GITHUB_STEP_SUMMARY
          echo "| Executed By | @${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Workflow Run | [${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### âœ… Generation Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Terraform output has been successfully extracted and formatted:" >> $GITHUB_STEP_SUMMARY
          echo "- **Output Location**: \`configurations/$config/outputs/$output_filename\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Format**: $export_format" >> $GITHUB_STEP_SUMMARY
          echo "- **Metadata Included**: $include_metadata" >> $GITHUB_STEP_SUMMARY
          echo "- **Committed to Repository**: âœ… Available in main branch" >> $GITHUB_STEP_SUMMARY
          echo "- **Artifact Available**: âœ… Available for download for 30 days" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸ“Š Output Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This output can be used for:" >> $GITHUB_STEP_SUMMARY
          echo "- **Migration Planning**: Understanding current Power Platform state" >> $GITHUB_STEP_SUMMARY
          echo "- **Compliance Auditing**: Documenting current governance policies" >> $GITHUB_STEP_SUMMARY
          echo "- **Configuration Backup**: Point-in-time snapshot of resources" >> $GITHUB_STEP_SUMMARY
          echo "- **Integration**: Feeding data into other tools and processes" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸ“‹ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. **Review Output**: Examine the generated $export_format file for insights" >> $GITHUB_STEP_SUMMARY
          echo "2. **Download Artifact**: Use the workflow artifact for offline analysis" >> $GITHUB_STEP_SUMMARY
          echo "3. **Migration Planning**: Use output data for planning Terraform migrations" >> $GITHUB_STEP_SUMMARY
          echo "4. **Documentation**: Update project documentation with current state" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸ”§ Migration Benefits" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This workflow has been migrated to use the reusable-terraform-base workflow, providing:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… **93% code reduction** (580+ lines â†’ ~40 lines)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… **Standardized output processing with proven patterns**" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… **Consistent error handling and format validation**" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… **Enhanced metadata generation for better traceability**" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… **Improved maintainability through proven composite actions**" >> $GITHUB_STEP_SUMMARY
