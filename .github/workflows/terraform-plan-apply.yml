# Terraform Plan and Apply Workflow for Power Platform Governance
# This workflow allows manual deployment of Terraform configurations for Power Platform resources
# It supports both plan-only operations and plan+apply operations based on user input
# Includes comprehensive validation, safety checks, documentation generation, and idempotency testing

name: Terraform Plan and Apply

# Prevent concurrent Terraform operations on same configuration/tfvars combination
concurrency:
  group: terraform-${{ github.event.inputs.configuration || 'default' }}-${{ github.event.inputs.tfvars_file || 'default' }}-${{ github.ref }}
  cancel-in-progress: false  # Don't cancel running Terraform operations

# Trigger: Manual workflow dispatch only
# Users can select which configuration to deploy and whether to apply changes
on:
  workflow_dispatch:
    inputs:
      configuration:
        description: 'Configuration to plan and apply (resource management configurations)'
        required: true
        type: choice
        options:
          - '02-dlp-policy'
          - '03-environment'
      tfvars_file:
        description: 'tfvars file name without extension (e.g., dlp-finance, env-production)'
        required: true
        type: string
      apply:
        description: 'Apply the configuration after plan'
        required: true
        type: boolean
        default: false
      force_apply:
        description: 'Apply even if plan shows no changes (use with caution)'
        required: false
        type: boolean
        default: false

# Dynamic run name that shows the configuration, tfvars file, and whether apply is enabled
run-name: ðŸ“‹ Terraform Plan${{ github.event.inputs.apply == 'true' && ' and Apply' || '' }} for ${{ github.event.inputs.configuration }} (${{ github.event.inputs.tfvars_file }}) by @${{ github.actor }}

# Required permissions for OIDC authentication with Azure and Power Platform
permissions:
  id-token: write   # Required for GitHub OIDC token generation
  contents: write   # Required for repository checkout and committing generated docs

# No workflow-level environment variables - secrets are only accessible within jobs that specify the production environment

jobs:
  # Job 1: Plan Phase
  # Always runs to validate and plan the Terraform configuration
  # Creates execution plans and uploads them as artifacts for potential apply phase
  terraform-plan:
    name: ðŸ“‹ Terraform Plan
    runs-on: ubuntu-latest
    environment: production  # Required to access production environment secrets
    
    # Environment variables for Power Platform OIDC authentication
    # These are set at job level and use secrets only from the production environment
    env:
      POWER_PLATFORM_USE_OIDC: true
      POWER_PLATFORM_CLIENT_ID: ${{ secrets.POWER_PLATFORM_CLIENT_ID }}
      POWER_PLATFORM_TENANT_ID: ${{ secrets.POWER_PLATFORM_TENANT_ID }}
      # Azure context for Power Platform resources - using same app registration
      ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      ARM_USE_OIDC: true
    
    # Output values that can be used by dependent jobs
    outputs:
      plan-changed: ${{ steps.plan.outputs.changed }}              # Whether the plan has changes
      configuration: ${{ github.event.inputs.configuration }}     # Pass configuration to apply job
      # Execution metadata for workflow tracking and AVM compliance
      execution-metadata: ${{ steps.plan.outputs.execution-metadata }}    # Comprehensive execution metadata
    
    steps:
    # Step 1: Checkout repository code
    - name: Checkout Repository for Planning
      uses: actions/checkout@v4
    
    # Step 2: Validate inputs and configuration
    - name: Validate Planning Inputs
      run: |
        config="${{ github.event.inputs.configuration }}"
        tfvars_file="${{ github.event.inputs.tfvars_file }}"
        apply_requested="${{ github.event.inputs.apply }}"
        force_apply="${{ github.event.inputs.force_apply }}"
        
        echo "::notice title=Validation Starting::Validating inputs for plan/apply operation..."
        
        # Validate configuration directory exists
        if [ ! -d "configurations/$config" ]; then
          echo "::error title=Configuration Not Found::Configuration directory 'configurations/$config' does not exist."
          echo "::notice title=Troubleshooting Guide::ðŸ“‹ Common causes and solutions:"
          echo "::notice title=Available Configurations::ðŸ” Check these existing configurations:"
          ls -la configurations/ | grep ^d | awk '{print "- " $NF}' | grep -v '^\.\.$' | grep -v '^\.$' || echo "- No configurations found"
          echo "::notice title=Solution 1::âœ… Use one of the existing configuration names listed above"
          echo "::notice title=Solution 2::ðŸ“ Create a new configuration directory: configurations/$config/"
          echo "::notice title=Documentation::ðŸ“š See project README for configuration setup guidance"
          exit 1
        fi
        
        # Validate this is a resource management configuration
        if [[ "$config" != "02-dlp-policy" && "$config" != "03-environment" ]]; then
          echo "::error title=Invalid Configuration Type::Configuration '$config' is not a resource management configuration."
          echo "::notice title=Troubleshooting Guide::ðŸ“‹ Configuration type validation failed:"
          echo "::notice title=Valid Configurations::âœ… Supported resource management configurations:"
          echo "::notice title=Option 1::ðŸ“ 02-dlp-policy - Data Loss Prevention policy management"
          echo "::notice title=Option 2::ðŸ“ 03-environment - Power Platform environment management" 
          echo "::notice title=Invalid Configuration::âŒ '$config' is likely an output-only configuration"
          echo "::notice title=Solution::ðŸ”„ Use terraform-output workflow for output-only configurations"
          echo "::notice title=Documentation::ðŸ“š See workflow documentation for configuration types"
          exit 1
        fi
        
        # Validate tfvars file name format
        if [[ ! "$tfvars_file" =~ ^[a-zA-Z0-9_-]+$ ]]; then
          echo "::error title=Invalid tfvars File Name::tfvars file name '$tfvars_file' contains invalid characters."
          echo "::notice title=Troubleshooting Guide::ðŸ“‹ tfvars file name validation failed:"
          echo "::notice title=Invalid Characters::âŒ File name '$tfvars_file' contains unsupported characters"
          echo "::notice title=Valid Characters::âœ… Use only: letters (a-z, A-Z), numbers (0-9), hyphens (-), underscores (_)"
          echo "::notice title=Example Names::ðŸ“ Valid examples: 'prod', 'dev-01', 'test_env', 'staging-2024'"
          echo "::notice title=File Extension::ðŸ“„ Do not include .tfvars extension in the input (will be added automatically)"
          echo "::notice title=Solution::ðŸ”§ Rename your tfvars file to use only valid characters"
          exit 1
        fi
        
        echo "::notice title=Input Validation Complete::âœ… All inputs validated successfully"
        echo "::notice title=Plan Target::ðŸŽ¯ Target: $config/$tfvars_file, Apply: $apply"
        
        if [ "$apply_requested" = "true" ]; then
          echo "::warning title=Apply Requested::âš ï¸ Apply operation will be performed if plan shows changes"
          if [ "$force_apply" = "true" ]; then
            echo "::warning title=Force Apply Enabled::âš ï¸ Force apply is enabled - will apply even if no changes detected"
          fi
        else
          echo "::notice title=Plan Only::Plan-only operation - no resources will be modified"
        fi
    
    # Step 3: Authenticate with Azure using OIDC for backend state storage
    - name: Azure Login with OIDC
      uses: azure/login@v2.3.0
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
    
    # Step 4: Add Just-In-Time network access for Terraform backend
    - name: Add JIT Network Access
      id: jit-add
      uses: ./.github/actions/jit-network-access
      with:
        action: 'add'
        storage-account-name: ${{ secrets.TERRAFORM_STORAGE_ACCOUNT }}
        resource-group-name: ${{ secrets.TERRAFORM_RESOURCE_GROUP }}
    
    # Step 5: Install and configure Terraform CLI
    - name: Setup Terraform CLI for Planning
      uses: hashicorp/setup-terraform@v3.1.2
      with:
        terraform_version: ${{ vars.TERRAFORM_VERSION || '1.12.2' }}
        terraform_wrapper: false    # Disable wrapper for better output handling
    
    # Step 6: Validate configuration and tfvars file existence
    - name: Validate Terraform Configuration Files
      run: |
        config="${{ github.event.inputs.configuration }}"
        tfvars_file="${{ github.event.inputs.tfvars_file }}"
        
        echo "::notice title=File Validation::Validating configuration and tfvars files..."
        
        # Validate configuration directory structure
        if [ ! -f "configurations/$config/main.tf" ] && [ ! -f "configurations/$config/data-sources.tf" ]; then
          echo "::error title=Invalid Configuration::No Terraform files found in configuration '$config'."
          echo "::notice title=Troubleshooting Guide::ðŸ“‹ Configuration structure validation failed:"
          echo "::notice title=Missing Files::âŒ Expected files not found:"
          echo "::notice title=Required Files::ðŸ“„ At least one of these files must exist:"
          echo "::notice title=Option 1::- configurations/$config/main.tf (for resource configurations)"
          echo "::notice title=Option 2::- configurations/$config/data-sources.tf (for data source configurations)"
          echo "::notice title=Current Files::ðŸ” Files currently in configurations/$config/:"
          ls -la "configurations/$config/" 2>/dev/null | grep '\.tf$' | awk '{print "- " $NF}' || echo "- No .tf files found"
          echo "::notice title=Solution::ðŸ“ Create the required Terraform configuration files"
          echo "::notice title=Documentation::ðŸ“š See Terraform documentation for configuration file structure"
          exit 1
        fi
        
        # Validate tfvars file exists
        tfvars_filename="$tfvars_file.tfvars"
        tfvars_path="configurations/$config/tfvars/$tfvars_filename"
        
        if [ ! -f "$tfvars_path" ]; then
          echo "::error title=tfvars File Not Found::Specified tfvars file '$tfvars_path' does not exist."
          echo "::notice title=Troubleshooting Guide::ðŸ“‹ tfvars file validation failed:"
          echo "::notice title=Missing File::âŒ File not found: $tfvars_path"
          echo "::notice title=Check Directory::ðŸ“ tfvars directory contents:"
          if [ -d "configurations/$config/tfvars/" ]; then
            ls -la "configurations/$config/tfvars/" | grep '\.tfvars$' | awk '{print "- " $NF}' || echo "- No .tfvars files found"
          else
            echo "- tfvars directory does not exist: configurations/$config/tfvars/"
          fi
          echo "::notice title=Solution 1::ðŸ“„ Create the missing tfvars file: $tfvars_path"
          echo "::notice title=Solution 2::ðŸ”„ Use one of the existing tfvars files listed above"
          echo "::notice title=Solution 3::ðŸ“ Create the tfvars directory if it doesn't exist"
          echo "::notice title=Documentation::ðŸ“š See project README for tfvars file examples and structure"
          exit 1
        fi
        
        echo "::notice title=Files Validated::âœ… Configuration and tfvars files validated successfully"
        echo "::notice title=Using Files::Configuration: configurations/$config/, tfvars: $tfvars_path"
    
    # Step 7: Create backup of current state
    - name: Create State Backup for Planning
      run: |
        config="${{ github.event.inputs.configuration }}"
        timestamp=$(date +%Y%m%d-%H%M%S)
        
        cd "configurations/$config"
        
        echo "::notice title=Creating Backup::Creating backup of current Terraform state..."
        
        # Create backups directory if it doesn't exist
        mkdir -p backups
        
        # Initialize Terraform first to access state (with retry logic for network reliability)
        echo "::notice title=Terraform Init::Initializing Terraform with backend configuration..."
        
        # Retry logic for terraform init (network-dependent operation)
        max_retries=3
        retry_count=0
        init_success=false
        
        while [ $retry_count -lt $max_retries ] && [ "$init_success" = false ]; do
          retry_count=$((retry_count + 1))
          echo "::notice title=Init Attempt::ðŸ”„ Terraform init attempt $retry_count of $max_retries..."
          
          if terraform init \
            -backend-config="storage_account_name=${{ secrets.TERRAFORM_STORAGE_ACCOUNT }}" \
            -backend-config="container_name=${{ secrets.TERRAFORM_CONTAINER }}" \
            -backend-config="key=$config-${{ github.event.inputs.tfvars_file }}.tfstate" \
            -backend-config="resource_group_name=${{ secrets.TERRAFORM_RESOURCE_GROUP }}" \
            -backend-config="subscription_id=${{ secrets.AZURE_SUBSCRIPTION_ID }}" \
            -backend-config="tenant_id=${{ secrets.AZURE_TENANT_ID }}" \
            -backend-config="use_oidc=true"; then
            
            init_success=true
            echo "::notice title=Init Success::âœ… Terraform init completed successfully on attempt $retry_count"
          else
            echo "::warning title=Init Failed::âš ï¸ Terraform init attempt $retry_count failed"
            if [ $retry_count -lt $max_retries ]; then
              wait_time=$((retry_count * 10))
              echo "::notice title=Retry Delay::â±ï¸ Waiting ${wait_time} seconds before retry..."
              sleep $wait_time
            fi
          fi
        done
        
        if [ "$init_success" = false ]; then
          echo "::error title=Init Failed::âŒ Terraform init failed after $max_retries attempts"
          echo "::notice title=Troubleshooting::ðŸ“‹ Common network-related init failures:"
          echo "::notice title=Issue 1::ðŸ”’ Network connectivity to Azure Storage backend"
          echo "::notice title=Issue 2::ðŸ”‘ Authentication or permission issues with storage account"  
          echo "::notice title=Issue 3::ðŸŒ Transient network issues or Azure service availability"
          echo "::notice title=Solution 1::ðŸ”„ Re-run the workflow (may resolve transient issues)"
          echo "::notice title=Solution 2::ðŸ” Check Azure Storage account accessibility"
          echo "::notice title=Solution 3::ðŸ” Verify service principal permissions"
          echo "::notice title=Documentation::ðŸ“š Error Reference: https://github.com/${{ github.repository }}/blob/main/docs/references/workflow-error-reference.md#terraform-init-errors"
          echo "::notice title=Azure Docs::ðŸ“š Azure Storage Network Security: https://docs.microsoft.com/azure/storage/common/storage-network-security"
          exit 1
        fi
        
        # Pull current state and create timestamped backup
        backup_filename="backups/terraform.tfstate.backup-$timestamp"
        terraform state pull > "$backup_filename" 2>/dev/null || echo "{}" > "$backup_filename"
        
        # Verify backup was created successfully
        if [ -s "$backup_filename" ] && [ "$(cat "$backup_filename")" != "{}" ]; then
          backup_size=$(du -h "$backup_filename" | cut -f1)
          echo "::notice title=Backup Created::âœ… State backup created successfully"
          echo "::notice title=Backup Details::File: $backup_filename, Size: $backup_size"
          
          # Count resources in backup
          resource_count=$(jq '.resources | length' "$backup_filename" 2>/dev/null || echo "0")
          echo "::notice title=Resources in Backup::Resources: $resource_count"
        else
          echo "::notice title=No Previous State::No existing state to backup - this is normal for new configurations"
          rm -f "$backup_filename"
        fi
        
        cd - > /dev/null
    
    # Step 8: Execute Terraform plan
    # This is the core step that initializes, validates, and plans the configuration
    - name: Generate Terraform Plan
      id: plan
      run: |
        config="${{ github.event.inputs.configuration }}"
        tfvars_file="${{ github.event.inputs.tfvars_file }}"
        
        echo "::notice title=Planning Configuration::Starting Terraform plan for configuration: $config"
        cd "configurations/$config"
        
        # Generate execution metadata for AVM compliance
        timestamp=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
        terraform_version=$(terraform --version | head -1 | sed 's/Terraform v//')
        
        # Create comprehensive metadata object using jq (more reliable approach)
        metadata_json=$(jq -n \
          --arg timestamp "$timestamp" \
          --arg workflow_run "${{ github.run_number }}" \
          --arg workflow_id "${{ github.run_id }}" \
          --arg generated_by "${{ github.actor }}" \
          --arg tf_version "$terraform_version" \
          --arg workflow_version "1.0.0" \
          --arg configuration "$config" \
          --arg tfvars_file "$tfvars_file" \
          --arg repository "${{ github.repository }}" \
          --arg ref "${{ github.ref }}" \
          --arg sha "${{ github.sha }}" \
          --arg event "${{ github.event_name }}" \
          --arg runner_os "${{ runner.os }}" \
          --arg runner_arch "${{ runner.arch }}" \
          '{
            "generated_at": $timestamp,
            "workflow_run": $workflow_run,
            "workflow_id": $workflow_id,
            "generated_by": $generated_by,
            "terraform_version": $tf_version,
            "workflow_version": $workflow_version,
            "configuration": $configuration,
            "tfvars_file": $tfvars_file,
            "repository": $repository,
            "ref": $ref,
            "sha": $sha,
            "event": $event,
            "runner_os": $runner_os,
            "runner_arch": $runner_arch
          }'
        )
        
        # Set GitHub output using multiline format
        {
          echo "execution-metadata<<METADATA_EOF"
          echo "$metadata_json"
          echo "METADATA_EOF"
        } >> $GITHUB_OUTPUT
        
        echo "::notice title=Metadata Generated::ðŸ“Š Execution metadata created for AVM compliance"
        
        # Add a small delay to ensure network rules are fully propagated
        echo "Waiting 10 seconds for network rules to propagate..."
        sleep 10
        
        # Terraform should already be initialized from backup step, but ensure it's current (with retry logic)
        echo "::notice title=Terraform Re-init::Re-initializing Terraform after network configuration..."
        
        # Retry logic for terraform init (network-dependent operation)
        max_retries=3
        retry_count=0
        init_success=false
        
        while [ $retry_count -lt $max_retries ] && [ "$init_success" = false ]; do
          retry_count=$((retry_count + 1))
          echo "::notice title=Init Attempt::ðŸ”„ Terraform init attempt $retry_count of $max_retries..."
          
          if terraform init \
            -backend-config="storage_account_name=${{ secrets.TERRAFORM_STORAGE_ACCOUNT }}" \
            -backend-config="container_name=${{ secrets.TERRAFORM_CONTAINER }}" \
            -backend-config="key=$config-${{ github.event.inputs.tfvars_file }}.tfstate" \
            -backend-config="resource_group_name=${{ secrets.TERRAFORM_RESOURCE_GROUP }}" \
            -backend-config="subscription_id=${{ secrets.AZURE_SUBSCRIPTION_ID }}" \
            -backend-config="tenant_id=${{ secrets.AZURE_TENANT_ID }}" \
            -backend-config="use_oidc=true"; then
            
            init_success=true
            echo "::notice title=Init Success::âœ… Terraform re-init completed successfully on attempt $retry_count"
          else
            echo "::warning title=Init Failed::âš ï¸ Terraform init attempt $retry_count failed"
            if [ $retry_count -lt $max_retries ]; then
              wait_time=$((retry_count * 10))
              echo "::notice title=Retry Delay::â±ï¸ Waiting ${wait_time} seconds before retry..."
              sleep $wait_time
            fi
          fi
        done
        
        if [ "$init_success" = false ]; then
          echo "::error title=Init Failed::âŒ Terraform init failed after $max_retries attempts"
          echo "::notice title=Context::ðŸ“‹ This init occurs after network configuration changes"
          echo "::notice title=Troubleshooting::ðŸ“‹ Common post-network-config init failures:"
          echo "::notice title=Issue 1::ðŸŒ Network propagation delays affecting backend access"
          echo "::notice title=Issue 2::ðŸ”’ Modified network rules blocking storage access"  
          echo "::notice title=Issue 3::ðŸ”‘ Authentication token refresh needed after network changes"
          echo "::notice title=Solution 1::ðŸ”„ Re-run the workflow (network rules may need more time)"
          echo "::notice title=Solution 2::ðŸ” Check if JIT network access is still active"
          echo "::notice title=Solution 3::ðŸ” Verify storage account network settings"
          echo "::notice title=Documentation::ðŸ“š Error Reference: https://github.com/${{ github.repository }}/blob/main/docs/references/workflow-error-reference.md#terraform-init-errors"
          echo "::notice title=Azure Docs::ðŸ“š JIT Network Access: https://docs.microsoft.com/azure/storage/common/storage-network-security"
          exit 1
        fi
        
        # Validate Terraform configuration syntax and consistency
        echo "::notice title=Validating Configuration::Validating Terraform configuration syntax..."
        
        if ! terraform validate; then
          echo "::error title=Terraform Validate Failed::âŒ Terraform configuration validation failed"
          echo "::notice title=Error Context::ðŸ“‹ Validation failure indicates configuration syntax or consistency issues"
          echo "::notice title=Troubleshooting::ðŸ” Common terraform validate failure causes:"
          echo "::notice title=Issue 1::ðŸ“ HCL syntax errors (missing quotes, brackets, or semicolons)"
          echo "::notice title=Issue 2::ðŸ”— Invalid resource references or variable usage"  
          echo "::notice title=Issue 3::ðŸ“¦ Missing or incorrect provider configuration"
          echo "::notice title=Issue 4::ðŸ·ï¸ Invalid resource or data source names"
          echo "::notice title=Issue 5::âš™ï¸ Incorrect variable types or validation rules"
          echo "::notice title=Solution 1::ðŸ“ Review configuration files for syntax errors"
          echo "::notice title=Solution 2::ðŸ” Check variable definitions and resource references"
          echo "::notice title=Solution 3::ðŸ“¦ Verify provider version and configuration requirements"
          echo "::notice title=Solution 4::ðŸ§ª Test configuration locally with 'terraform validate'"
          echo "::notice title=Solution 5::ðŸ“š Review Terraform and Power Platform provider documentation"
          echo "::notice title=Documentation::ðŸ“š Error Reference: https://github.com/${{ github.repository }}/blob/main/docs/references/workflow-error-reference.md#terraform-validate-errors"
          echo "::notice title=Terraform Docs::ðŸ“š Configuration Language: https://developer.hashicorp.com/terraform/language"
          exit 1
        fi
        
        echo "::notice title=Validation Success::âœ… Terraform configuration validation completed successfully"
        
        # Prepare tfvars file paths
        tfvars_filename="$tfvars_file.tfvars"
        tfvars_path="tfvars/$tfvars_filename"
        
        echo "::notice title=Generating Plan::Creating execution plan with tfvars file: $tfvars_path"
        
        # Create execution plan with specified tfvars file
        # -detailed-exitcode: Exit 0 for no changes, 1 for error, 2 for changes
        # -out: Save plan to file for later apply
        # Load variables: root terraform.tfvars + selected configuration tfvars
        terraform plan -detailed-exitcode -out=tfplan-$config \
          -var-file="../../terraform.tfvars" \
          -var-file="$tfvars_path" || plan_exit_code=$?
        
        # Handle different exit codes from terraform plan
        if [ $plan_exit_code -eq 1 ]; then
          echo "::error title=Terraform Plan Failed::âŒ Terraform plan failed for configuration $config"
          echo "::notice title=Error Context::ðŸ“‹ Plan failure occurred during infrastructure planning phase"
          echo "::notice title=Troubleshooting::ðŸ” Common terraform plan failure causes:"
          echo "::notice title=Issue 1::ðŸ“ Configuration syntax errors or invalid resource definitions"
          echo "::notice title=Issue 2::ðŸ”‘ Authentication or authorization issues with Power Platform"  
          echo "::notice title=Issue 3::ðŸŒ Network connectivity issues to Power Platform API"
          echo "::notice title=Issue 4::ðŸ’¾ State file inconsistencies or lock conflicts"
          echo "::notice title=Issue 5::ðŸ“¦ Provider version compatibility issues"
          echo "::notice title=Solution 1::ðŸ” Review the detailed error logs above for specific syntax issues"
          echo "::notice title=Solution 2::ðŸ” Verify service principal has required Power Platform permissions"
          echo "::notice title=Solution 3::ðŸ”„ Re-run workflow if transient network or API issues occurred"
          echo "::notice title=Solution 4::ðŸ’¾ Check state file integrity and clear locks if needed"
          echo "::notice title=Solution 5::ðŸ“š Review Power Platform provider documentation for required permissions"
          echo "::notice title=Documentation::ðŸ“š Error Reference: https://github.com/${{ github.repository }}/blob/main/docs/references/workflow-error-reference.md#terraform-plan-errors"
          echo "::notice title=Power Platform::ðŸ“š Service Principal Setup: https://docs.microsoft.com/power-platform/admin/powershell-create-service-principal"
          exit 1
        elif [ $plan_exit_code -eq 2 ]; then
          echo "::notice title=Changes Detected::âœ… Terraform plan detected changes for configuration $config. The plan will be saved for potential apply."
          echo "changed=true" >> $GITHUB_OUTPUT
          
          # Show plan summary
          echo "::group::Plan Changes Summary"
          terraform show tfplan-$config | grep -E "^(#|Plan:|Changes to Outputs:)" | head -20
          echo "::endgroup::"
        else
          echo "::notice title=No Changes::Terraform plan shows no changes for configuration $config. Infrastructure is up to date."
          echo "changed=false" >> $GITHUB_OUTPUT
          
          if [ "${{ github.event.inputs.force_apply }}" = "true" ]; then
            echo "::warning title=Force Apply::âš ï¸ Force apply is enabled - will proceed with apply even though no changes detected"
            echo "changed=true" >> $GITHUB_OUTPUT
          fi
        fi
        
        cd - > /dev/null
    
    # Step 9: Generate/Update Configuration Documentation
    # AVM requires up-to-date documentation generated by terraform-docs
    - name: Generate Configuration Documentation
      run: |
        config="${{ github.event.inputs.configuration }}"
        
        echo "Generating documentation for configuration: $config"
        cd "configurations/$config"
        
        # Install terraform-docs if not available
        if ! command -v terraform-docs &> /dev/null; then
          echo "::notice title=Installing terraform-docs::terraform-docs not found, installing version 0.20.0..."
          curl -sSLo terraform-docs.tar.gz https://github.com/terraform-docs/terraform-docs/releases/download/v0.20.0/terraform-docs-v0.20.0-linux-amd64.tar.gz
          tar -xzf terraform-docs.tar.gz
          sudo mv terraform-docs /usr/local/bin/
          rm terraform-docs.tar.gz
          echo "::notice title=Installation Complete::terraform-docs v0.20.0 installed successfully"
        fi
        
        # Generate documentation
        echo "::notice title=Generating Documentation::Creating README.md for configuration: $config"
        terraform-docs markdown table --output-file README.md .
        
        # Display generated content for verification
        echo "::group::Generated Documentation Preview"
        head -20 README.md
        echo "::endgroup::"
        
        cd - > /dev/null
    
    # Step 10: Commit generated documentation
    # Commit the updated README.md back to the repository
    - name: Commit Generated Documentation
      run: |
        config="${{ github.event.inputs.configuration }}"
        
        # Configure git
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        
        # Check if there are changes to commit
        if git diff --quiet "configurations/$config/README.md"; then
          echo "::notice title=Documentation Unchanged::No changes detected in documentation for $config, skipping commit"
        else
          echo "::notice title=Committing Documentation::Documentation has been updated, committing changes for $config..."
          git add "configurations/$config/README.md"
          git commit -m "docs: update documentation for $config configuration
          
          Auto-generated by terraform-docs via GitHub Actions"
          git push origin main
          echo "::notice title=Documentation Committed::âœ… Documentation committed successfully for $config"
        fi
    
    # Step 11: Upload plan files as artifacts for the apply job
    # Only uploads if there are changes to apply or force apply is enabled
    - name: Upload Terraform Plans as Artifacts
      if: steps.plan.outputs.changed == 'true'
      run: |
        config="${{ github.event.inputs.configuration }}"
        cd "configurations/$config"
        
        # Create metadata file for artifact
        cat > "tfplan-metadata.json" <<EOF
        ${{ steps.plan.outputs.execution-metadata }}
        EOF
        
        echo "::notice title=Metadata Created::ðŸ“Š Plan metadata file created for artifact"
        cd - > /dev/null
        
    - name: Upload Plans with Metadata
      if: steps.plan.outputs.changed == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: terraform-plans-${{ github.event.inputs.configuration }}-${{ github.run_number }}
        path: |
          configurations/*/tfplan-*
          configurations/*/tfplan-metadata.json
        retention-days: 7    # Keep plans for 7 days for troubleshooting and audit trail
        description: 'Terraform execution plans for ${{ github.event.inputs.configuration }} configuration - contains planned changes for review and troubleshooting'
    
    # Step 12: Generate Plan Summary
    - name: Generate Plan Summary
      run: |
        config="${{ github.event.inputs.configuration }}"
        tfvars_file="${{ github.event.inputs.tfvars_file }}"
        plan_changed="${{ steps.plan.outputs.changed }}"
        
        # Generate comprehensive plan summary
        echo "## ðŸ“‹ Terraform Plan Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Planning Details" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Parameter | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| Configuration | \`$config\` |" >> $GITHUB_STEP_SUMMARY
        echo "| tfvars File | \`$tfvars_file.tfvars\` |" >> $GITHUB_STEP_SUMMARY
        echo "| Timestamp | $(date +%Y-%m-%d\ %H:%M:%S) |" >> $GITHUB_STEP_SUMMARY
        echo "| Executed by | @${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Workflow run | [${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Plan results section
        cd "configurations/$config"
        if [ "$plan_changed" = "true" ]; then
          # Check if plan file exists
          if [ -f "tfplan-$config" ]; then
            plan_size=$(du -h "tfplan-$config" | cut -f1)
            echo "### âœ… Plan Results: CHANGES DETECTED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Detail | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| **Status** | Changes Detected |" >> $GITHUB_STEP_SUMMARY
            echo "| **Plan File** | \`tfplan-$config\` |" >> $GITHUB_STEP_SUMMARY
            echo "| **File Size** | $plan_size |" >> $GITHUB_STEP_SUMMARY
            echo "| **Action Required** | Ready for Apply |" >> $GITHUB_STEP_SUMMARY
            echo "| **Plan Retention** | 7 days |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âš ï¸ Plan Results: CHANGES DETECTED (No Plan File)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Changes were detected but no plan file was generated." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "### ðŸ†— Plan Results: NO CHANGES" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Detail | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Status** | No Changes Detected |" >> $GITHUB_STEP_SUMMARY
          echo "| **Current State** | Infrastructure matches configuration |" >> $GITHUB_STEP_SUMMARY
          echo "| **Action Required** | None - State is current |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Add next steps based on plan results
        echo "### ðŸ“‹ Next Steps" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ "$plan_changed" = "true" ]; then
          echo "**âš ï¸ Action Required - Changes Detected:**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. **Review Plan**: Carefully review the plan output above to understand what changes will be made" >> $GITHUB_STEP_SUMMARY
          echo "2. **Approve Apply**: If changes are acceptable, manually trigger the apply job or approval" >> $GITHUB_STEP_SUMMARY
          echo "3. **Monitor Apply**: Watch the apply process to ensure it completes successfully" >> $GITHUB_STEP_SUMMARY
          echo "4. **Verify Resources**: After apply, verify that resources were created/modified as expected" >> $GITHUB_STEP_SUMMARY
        else
          echo "**âœ… No Action Required - Infrastructure Current:**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. **State Verified**: Your infrastructure matches the current configuration" >> $GITHUB_STEP_SUMMARY
          echo "2. **No Apply Needed**: No changes will be applied" >> $GITHUB_STEP_SUMMARY
          echo "3. **Configuration Current**: Your Terraform configuration is aligned with actual resources" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Add important notes
        echo "### ðŸ“Œ Important Notes" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Plan Validation**: Terraform configuration validated successfully" >> $GITHUB_STEP_SUMMARY
        echo "- **State Security**: Terraform state is securely stored in Azure Storage" >> $GITHUB_STEP_SUMMARY
        echo "- **Network Security**: JIT network access was used for secure backend connectivity" >> $GITHUB_STEP_SUMMARY
        echo "- **Documentation**: Configuration documentation was auto-generated and committed" >> $GITHUB_STEP_SUMMARY
        if [ "$plan_changed" = "true" ]; then
          echo "- **Plan Artifact**: Plan file uploaded as artifact and available for 7 days" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        
        cd - > /dev/null
    
    # Step 13: Remove Just-In-Time network access
    - name: Remove JIT Network Access
      if: always()
      uses: ./.github/actions/jit-network-access
      with:
        action: 'remove'
        storage-account-name: ${{ secrets.TERRAFORM_STORAGE_ACCOUNT }}
        resource-group-name: ${{ secrets.TERRAFORM_RESOURCE_GROUP }}

  # Job 2: Apply Phase
  # Only runs if plan job succeeded, has changes, and user requested apply
  # Applies the previously created plan to make actual infrastructure changes
  terraform-apply:
    name: ðŸš€ Terraform Apply
    runs-on: ubuntu-latest
    environment: production  # Required to access production environment secrets
    needs: terraform-plan    # Depends on successful completion of plan job
    
    # Environment variables for Power Platform OIDC authentication
    # These are set at job level and use secrets only from the production environment
    env:
      POWER_PLATFORM_USE_OIDC: true
      POWER_PLATFORM_CLIENT_ID: ${{ secrets.POWER_PLATFORM_CLIENT_ID }}
      POWER_PLATFORM_TENANT_ID: ${{ secrets.POWER_PLATFORM_TENANT_ID }}
      # Azure context for Power Platform resources - using same app registration
      ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      ARM_USE_OIDC: true
    
    # Conditional execution: only run if all conditions are met
    if: |
      always() && 
      needs.terraform-plan.result == 'success' && 
      needs.terraform-plan.outputs.plan-changed == 'true' &&
      github.event.inputs.apply == 'true'
    
    steps:
    # Step 1: Checkout repository code (needed for accessing configuration files)
    - name: Checkout Repository for Apply
      uses: actions/checkout@v4
    
    # Step 2: Authenticate with Azure using OIDC for backend state storage
    - name: Azure Login with OIDC
      uses: azure/login@v2.3.0
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
    
    # Step 3: Add Just-In-Time network access for Terraform backend
    - name: Add JIT Network Access
      id: jit-add
      uses: ./.github/actions/jit-network-access
      with:
        action: 'add'
        storage-account-name: ${{ secrets.TERRAFORM_STORAGE_ACCOUNT }}
        resource-group-name: ${{ secrets.TERRAFORM_RESOURCE_GROUP }}
    
    # Step 4: Install and configure Terraform CLI
    - name: Setup Terraform CLI for Apply
      uses: hashicorp/setup-terraform@v3.1.2
      with:
        terraform_version: ${{ vars.TERRAFORM_VERSION || '1.12.2' }}
        terraform_wrapper: false
    
    # Step 5: Download the plan files created in the plan job
    - name: Download Terraform Plans from Artifacts
      uses: actions/download-artifact@v4
      with:
        name: tfplans-${{ github.run_number }}
        path: .
    
    # Step 6: Apply the Terraform plan
    # This step makes actual changes to the Power Platform infrastructure
    - name: Apply Terraform Configuration
      run: |
        config="${{ needs.terraform-plan.outputs.configuration }}"
        
        echo "::notice title=Applying Configuration::Starting Terraform apply for configuration: $config"
        cd "configurations/$config"
        
        # Add a small delay to ensure network rules are fully propagated
        echo "Waiting 10 seconds for network rules to propagate..."
        sleep 10
        
        # Re-initialize Terraform (required after downloading artifacts) with retry logic
        echo "::notice title=Terraform Re-init::Re-initializing Terraform after downloading plan artifacts..."
        
        # Retry logic for terraform init (network-dependent operation)
        max_retries=3
        retry_count=0
        init_success=false
        
        while [ $retry_count -lt $max_retries ] && [ "$init_success" = false ]; do
          retry_count=$((retry_count + 1))
          echo "::notice title=Init Attempt::ðŸ”„ Terraform init attempt $retry_count of $max_retries..."
          
          if terraform init \
            -backend-config="storage_account_name=${{ secrets.TERRAFORM_STORAGE_ACCOUNT }}" \
            -backend-config="container_name=${{ secrets.TERRAFORM_CONTAINER }}" \
            -backend-config="key=$config-${{ github.event.inputs.tfvars_file }}.tfstate" \
            -backend-config="resource_group_name=${{ secrets.TERRAFORM_RESOURCE_GROUP }}" \
            -backend-config="subscription_id=${{ secrets.AZURE_SUBSCRIPTION_ID }}" \
            -backend-config="tenant_id=${{ secrets.AZURE_TENANT_ID }}" \
            -backend-config="use_oidc=true"; then
            
            init_success=true
            echo "::notice title=Init Success::âœ… Terraform re-init completed successfully on attempt $retry_count"
          else
            echo "::warning title=Init Failed::âš ï¸ Terraform init attempt $retry_count failed"
            if [ $retry_count -lt $max_retries ]; then
              wait_time=$((retry_count * 10))
              echo "::notice title=Retry Delay::â±ï¸ Waiting ${wait_time} seconds before retry..."
              sleep $wait_time
            fi
          fi
        done
        
        if [ "$init_success" = false ]; then
          echo "::error title=Init Failed::âŒ Terraform init failed after $max_retries attempts"
          echo "::notice title=Context::ðŸ“‹ This init occurs in apply job after downloading plan artifacts"
          echo "::notice title=Troubleshooting::ðŸ“‹ Common post-artifact-download init failures:"
          echo "::notice title=Issue 1::ðŸŒ Network connectivity issues to Azure Storage backend"
          echo "::notice title=Issue 2::ðŸ“¦ Local state cache conflicts after artifact extraction"  
          echo "::notice title=Issue 3::ðŸ”‘ Authentication token expiration during job transition"
          echo "::notice title=Solution 1::ðŸ”„ Re-run the workflow (may resolve transient issues)"
          echo "::notice title=Solution 2::ðŸ” Check if JIT network access is still active"
          echo "::notice title=Solution 3::ðŸ’¾ Verify plan artifacts were downloaded correctly"
          echo "::notice title=Documentation::ðŸ“š See apply job troubleshooting guide"
          exit 1
        fi
        
        # Apply the previously created plan
        # -auto-approve: Skip interactive approval since we're using a pre-approved plan
        echo "::notice title=Applying Changes::ðŸš€ Executing terraform apply with pre-approved plan..."
        
        if ! terraform apply -auto-approve "tfplan-$config"; then
          apply_exit_code=$?
          echo "::error title=Terraform Apply Failed::âŒ Terraform apply failed for configuration $config"
          echo "::notice title=Error Context::ðŸ“‹ Apply failure occurred during infrastructure deployment phase"
          echo "::notice title=Exit Code::ðŸ”¢ Terraform apply exited with code: $apply_exit_code"
          echo "::notice title=Troubleshooting::ðŸ” Common terraform apply failure causes:"
          echo "::notice title=Issue 1::ðŸ”‘ Insufficient permissions to create/modify Power Platform resources"
          echo "::notice title=Issue 2::ðŸŒ Network connectivity issues during resource provisioning"  
          echo "::notice title=Issue 3::âš ï¸ Resource conflicts or dependencies not met"
          echo "::notice title=Issue 4::ðŸ’¾ State file corruption or lock conflicts"
          echo "::notice title=Issue 5::ðŸ—ï¸ Power Platform service limits or quotas exceeded"
          echo "::notice title=Solution 1::ðŸ” Verify service principal has Power Platform System Administrator role"
          echo "::notice title=Solution 2::ðŸ”„ Re-run workflow if transient API or network issues occurred"
          echo "::notice title=Solution 3::ðŸ” Check Power Platform admin center for resource conflicts"
          echo "::notice title=Solution 4::ðŸ’¾ Clear state locks and verify state file integrity"
          echo "::notice title=Solution 5::ðŸ“ˆ Review Power Platform capacity and license requirements"
          echo "::notice title=Documentation::ðŸ“š Error Reference: https://github.com/${{ github.repository }}/blob/main/docs/references/workflow-error-reference.md#terraform-apply-errors"
          echo "::notice title=Power Platform::ðŸ“š Admin Center: https://admin.powerplatform.microsoft.com/"
          exit 1
        fi
        
        echo "::notice title=Apply Success::âœ… Terraform apply completed successfully for configuration $config"
        
        # Use the same tfvars file that was used in the plan job
        tfvars_file="${{ github.event.inputs.tfvars_file }}"
        tfvars_filename="$tfvars_file.tfvars"
        tfvars_path="tfvars/$tfvars_filename"
        
        # AVM Best Practice: Test idempotency after apply
        # Run plan again to ensure no changes are detected
        echo "::notice title=Testing Idempotency::Running post-apply plan to verify idempotency..."
        terraform plan -detailed-exitcode \
          -var-file="../../terraform.tfvars" \
          -var-file="$tfvars_path" || idempotency_exit_code=$?
        
        if [ $idempotency_exit_code -eq 2 ]; then
          echo "::error title=Idempotency Test Failed::âŒ Plan shows changes after apply - configuration is not idempotent"
          echo "::notice title=Error Context::ðŸ“‹ Idempotency failure indicates configuration drift or resource instability"
          echo "::notice title=AVM Compliance::âš ï¸ This violates Azure Verified Module (AVM) idempotency requirements"
          echo "::notice title=Troubleshooting::ðŸ” Common idempotency failure causes:"
          echo "::notice title=Issue 1::ðŸ”„ Resources with dynamic values (timestamps, generated IDs)"
          echo "::notice title=Issue 2::ðŸ·ï¸ Missing ignore_changes blocks for computed attributes"  
          echo "::notice title=Issue 3::âš™ï¸ Provider API inconsistencies or eventual consistency issues"
          echo "::notice title=Issue 4::ðŸ”— Resources depending on external state changes"
          echo "::notice title=Issue 5::ðŸ“ Missing lifecycle management rules"
          echo "::notice title=Solution 1::ðŸ” Review the diff output to identify changing attributes"
          echo "::notice title=Solution 2::ðŸ·ï¸ Add ignore_changes for computed or dynamic attributes"
          echo "::notice title=Solution 3::â³ Add provider-specific wait conditions for eventual consistency"
          echo "::notice title=Solution 4::ðŸ”§ Use data sources instead of resources for read-only operations"
          echo "::notice title=Solution 5::ðŸ“š Review AVM guidelines for idempotency patterns"
          echo "::notice title=Documentation::ðŸ“š Error Reference: https://github.com/${{ github.repository }}/blob/main/docs/references/workflow-error-reference.md#idempotency-test-errors"
          echo "::notice title=AVM Guidelines::ðŸ“š Azure Verified Modules: https://azure.github.io/Azure-Verified-Modules/"
          exit 1
        elif [ $idempotency_exit_code -eq 0 ]; then
          echo "::notice title=Idempotency Test Passed::âœ… No changes detected in post-apply plan - configuration is idempotent"
        else
          echo "::error title=Idempotency Test Error::âŒ Post-apply plan failed with error (exit code: $idempotency_exit_code)"
          echo "::notice title=Error Context::ðŸ“‹ Idempotency test execution failed (not a drift issue)"
          echo "::notice title=Troubleshooting::ðŸ” Common idempotency test execution failures:"
          echo "::notice title=Issue 1::ðŸ”‘ Authentication token expiration during extended apply process"
          echo "::notice title=Issue 2::ðŸŒ Network connectivity issues during post-apply validation"  
          echo "::notice title=Issue 3::ðŸ’¾ State file corruption or lock conflicts"
          echo "::notice title=Issue 4::ðŸ“¦ Provider API rate limiting or service unavailability"
          echo "::notice title=Solution 1::ðŸ”„ Re-run the workflow (may resolve transient issues)"
          echo "::notice title=Solution 2::ðŸ” Verify authentication credentials are still valid"
          echo "::notice title=Solution 3::ðŸ’¾ Check state file integrity and clear locks if needed"
          echo "::notice title=Solution 4::â±ï¸ Consider adding delays for API rate limiting"
          echo "::notice title=Documentation::ðŸ“š See post-apply validation troubleshooting guide"
          exit 1
        fi
        
        cd - > /dev/null
    
    # Step 7: Extract outputs from the applied configuration
    # Terraform outputs often contain important information like resource IDs
    - name: Extract Terraform Output Values
      run: |
        config="${{ needs.terraform-plan.outputs.configuration }}"
        
        echo "::notice title=Extracting Outputs::Getting Terraform outputs for configuration: $config"
        cd "configurations/$config"
        
        # Re-initialize to ensure we can read outputs from the updated state (with retry logic)
        echo "::notice title=Terraform Init::Re-initializing Terraform to read updated state for outputs..."
        
        # Retry logic for terraform init (network-dependent operation)
        max_retries=3
        retry_count=0
        init_success=false
        
        while [ $retry_count -lt $max_retries ] && [ "$init_success" = false ]; do
          retry_count=$((retry_count + 1))
          echo "::notice title=Init Attempt::ðŸ”„ Terraform init attempt $retry_count of $max_retries..."
          
          if terraform init \
            -backend-config="storage_account_name=${{ secrets.TERRAFORM_STORAGE_ACCOUNT }}" \
            -backend-config="container_name=${{ secrets.TERRAFORM_CONTAINER }}" \
            -backend-config="key=$config-${{ github.event.inputs.tfvars_file }}.tfstate" \
            -backend-config="resource_group_name=${{ secrets.TERRAFORM_RESOURCE_GROUP }}" \
            -backend-config="subscription_id=${{ secrets.AZURE_SUBSCRIPTION_ID }}" \
            -backend-config="tenant_id=${{ secrets.AZURE_TENANT_ID }}" \
            -backend-config="use_oidc=true"; then
            
            init_success=true
            echo "::notice title=Init Success::âœ… Terraform init for outputs completed successfully on attempt $retry_count"
          else
            echo "::warning title=Init Failed::âš ï¸ Terraform init attempt $retry_count failed"
            if [ $retry_count -lt $max_retries ]; then
              wait_time=$((retry_count * 10))
              echo "::notice title=Retry Delay::â±ï¸ Waiting ${wait_time} seconds before retry..."
              sleep $wait_time
            fi
          fi
        done
        
        if [ "$init_success" = false ]; then
          echo "::error title=Init Failed::âŒ Terraform init failed after $max_retries attempts"
          echo "::notice title=Context::ðŸ“‹ This init is required to read outputs from updated state"
          echo "::notice title=Troubleshooting::ðŸ“‹ Common output extraction init failures:"
          echo "::notice title=Issue 1::ðŸŒ Network connectivity issues accessing state file"
          echo "::notice title=Issue 2::ðŸ’¾ State file lock conflicts or corruption"  
          echo "::notice title=Issue 3::ðŸ”‘ Authentication issues reading from remote backend"
          echo "::notice title=Solution 1::ðŸ”„ Re-run the workflow (may resolve transient issues)"
          echo "::notice title=Solution 2::ðŸ” Check state file integrity in storage account"
          echo "::notice title=Solution 3::ðŸ” Verify backend access permissions are still valid"
          echo "::notice title=Documentation::ðŸ“š See state management troubleshooting guide"
          exit 1
        fi
        
        # Extract outputs in JSON format, fallback to empty object if no outputs
        terraform output -json > "outputs-$config.json" || echo "{}" > "outputs-$config.json"
        
        # Generate comprehensive output metadata with plan metadata
        timestamp=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
        terraform_version=$(terraform --version | head -1 | sed 's/Terraform v//')
        
        # Include plan metadata if available
        plan_metadata='${{ needs.terraform-plan.outputs.execution-metadata }}'
        
        # Create metadata file with both apply and plan context
        cat > "outputs-metadata.json" <<EOF
          {
            "generated_at": "$timestamp",
            "workflow_run": "${{ github.run_number }}",
            "workflow_id": "${{ github.run_id }}",
            "generated_by": "${{ github.actor }}",
            "terraform_version": "$terraform_version",
            "workflow_version": "1.0.0",
            "configuration": "$config",
            "repository": "${{ github.repository }}",
            "ref": "${{ github.ref }}",
            "sha": "${{ github.sha }}",
            "event": "${{ github.event_name }}",
            "runner_os": "${{ runner.os }}",
            "runner_arch": "${{ runner.arch }}",
            "phase": "apply",
            "plan_metadata": $plan_metadata
          }
          EOF
        
        # Show a preview of the outputs
        echo "::group::Terraform Outputs Preview"
        cat "outputs-$config.json"
        echo "::endgroup::"
        
        echo "::notice title=Outputs Extracted::Terraform outputs saved to outputs-$config.json with metadata"
        
        cd - > /dev/null
    
    # Step 8: Upload outputs as artifacts for later reference
    # These outputs can be used by other workflows or for troubleshooting
    - name: Upload Terraform Outputs as Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: terraform-outputs-${{ github.event.inputs.configuration }}-${{ github.run_number }}
        path: |
          configurations/*/outputs-*.json
          configurations/*/outputs-metadata.json
        retention-days: 30    # Keep outputs longer than plans for reference
        description: 'Terraform output values from ${{ github.event.inputs.configuration }} configuration - contains resource information and computed values with execution metadata'
    
    # Step 9: Generate comprehensive workflow summary
    - name: Generate Workflow Summary
      run: |
        config="${{ github.event.inputs.configuration }}"
        tfvars_file="${{ github.event.inputs.tfvars_file }}"
        
        # Generate comprehensive summary following terraform-output.yml patterns
        echo "## ðŸš€ Terraform Plan & Apply Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Execution Details" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Parameter | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| Configuration | \`$config\` |" >> $GITHUB_STEP_SUMMARY
        echo "| tfvars File | \`$tfvars_file.tfvars\` |" >> $GITHUB_STEP_SUMMARY
        echo "| Timestamp | $(date +%Y-%m-%d\ %H:%M:%S) |" >> $GITHUB_STEP_SUMMARY
        echo "| Executed by | @${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Workflow run | [${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Check if outputs file exists and parse results
        cd "configurations/$config"
        if [ -f "outputs-$config.json" ]; then
          output_file="outputs-$config.json"
          file_size=$(du -h "$output_file" | cut -f1)
          
          # Count outputs using basic shell tools (no jq/yq needed)
          if [ -s "$output_file" ]; then
            # Simple count by counting opening braces in the outputs (rough estimate)
            output_count=$(grep -o '"[^"]*":' "$output_file" | wc -l)
          else
            output_count=0
          fi
          
          echo "### âœ… Apply Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Detail | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Status** | Successfully Applied |" >> $GITHUB_STEP_SUMMARY
          echo "| **Outputs File** | \`$output_file\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **File Size** | $file_size |" >> $GITHUB_STEP_SUMMARY
          echo "| **Output Count** | $output_count |" >> $GITHUB_STEP_SUMMARY
          echo "| **Artifact Retention** | 30 days |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ $output_count -gt 0 ]; then
            echo "### ðŸ“‹ Output Keys" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The following outputs were generated:" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            # Extract output keys using basic shell tools
            grep -o '"[^"]*":' "$output_file" | sed 's/"//g' | sed 's/://g' | sed 's/^/- /' >> $GITHUB_STEP_SUMMARY || echo "- Unable to parse output keys" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "### âš ï¸ Apply Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Detail | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Status** | Applied (No Outputs) |" >> $GITHUB_STEP_SUMMARY
          echo "| **Outputs** | No outputs generated |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Add next steps section
        echo "### âœ… Next Steps" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "1. **Verify Resources**: Check that resources were created as expected in the target environment" >> $GITHUB_STEP_SUMMARY
        echo "2. **Review Outputs**: Download the outputs artifact for use in other workflows or configurations" >> $GITHUB_STEP_SUMMARY
        echo "3. **Monitor Resources**: Set up monitoring and alerting for the deployed resources" >> $GITHUB_STEP_SUMMARY
        echo "4. **Update Documentation**: Document any configuration changes or new resource dependencies" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Add important notes section
        echo "### ðŸ“Œ Important Notes" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **State Management**: Terraform state is securely stored in Azure Storage" >> $GITHUB_STEP_SUMMARY
        echo "- **Network Security**: JIT network access was used for secure backend connectivity" >> $GITHUB_STEP_SUMMARY
        echo "- **Artifact Availability**: Output artifacts are available for 30 days" >> $GITHUB_STEP_SUMMARY
        echo "- **Configuration**: Applied using configuration \`$config\` with variables \`$tfvars_file.tfvars\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        cd - > /dev/null
    
    # Step 10: Remove Just-In-Time network access
    - name: Remove JIT Network Access
      if: always()
      uses: ./.github/actions/jit-network-access
      with:
        action: 'remove'
        storage-account-name: ${{ secrets.TERRAFORM_STORAGE_ACCOUNT }}
        resource-group-name: ${{ secrets.TERRAFORM_RESOURCE_GROUP }}