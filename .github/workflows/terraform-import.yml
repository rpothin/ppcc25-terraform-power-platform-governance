# Terraform Import Workflow for Power Platform Governance
# This workflow allows importing existing Power Platform resources into Terraform state
# It supports importing resources to make them manageable via Infrastructure as Code

name: Terraform Import

# Prevent concurrent Terraform operations on same configuration/tfvars combination
concurrency:
  group: terraform-${{ github.event.inputs.configuration || 'default' }}-${{ github.event.inputs.tfvars_file || 'default' }}-import-${{ github.ref }}
  cancel-in-progress: false  # Don't cancel running Terraform operations

# Trigger: Manual workflow dispatch only
# Users can specify which resource to import into which configuration
on:
  workflow_dispatch:
    inputs:
      configuration:
        description: 'Configuration to import the resource into (resource management configurations)'
        required: true
        type: choice
        options:
          - '02-dlp-policy'
          - '03-environment'
      tfvars_file:
        description: 'tfvars file name without extension (e.g., dlp-finance, env-production)'
        required: true
        type: string
      resource_type:
        description: 'Terraform resource type (e.g., powerplatform_data_loss_prevention_policy)'
        required: true
        type: string
      resource_name:
        description: 'Terraform resource name in the configuration (e.g., main)'
        required: true
        type: string
      resource_id:
        description: 'Power Platform resource ID to import (UUID format)'
        required: true
        type: string
      backup_state:
        description: 'Create state backup before import'
        required: true
        type: boolean
        default: true

# Dynamic run name that shows the import operation details
run-name: ðŸ“¥ Terraform Import ${{ github.event.inputs.resource_type }}.${{ github.event.inputs.resource_name }} to ${{ github.event.inputs.configuration }} by @${{ github.actor }}

# Required permissions for OIDC authentication with Azure and Power Platform
permissions:
  id-token: write   # Required for GitHub OIDC token generation
  contents: read    # Required for repository checkout

jobs:
  # Job 1: Execute Terraform Import using Reusable Workflow
  # Uses the standardized reusable-terraform-base workflow for consistent operation
  terraform-import:
    name: ðŸ“¥ Execute Terraform Import
    uses: ./.github/workflows/reusable-terraform-base.yml
    with:
      operation: 'import'
      configuration: ${{ github.event.inputs.configuration }}
      tfvars-file: ${{ github.event.inputs.tfvars_file }}
      # Format import arguments: resource_type.resource_name resource_id
      additional-options: '${{ github.event.inputs.resource_type }}.${{ github.event.inputs.resource_name }} ${{ github.event.inputs.resource_id }}'
      create-state-backup: ${{ github.event.inputs.backup_state }}
      timeout-minutes: 15
      environment-name: 'production'
    secrets: inherit
  
  # Job 2: Post-Import Validation and Reporting
  # Validates the import was successful and generates comprehensive reports
  post-import-validation:
    name: âœ… Validate Import Success
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: terraform-import
    if: always()  # Run even if import partially failed to provide diagnostics
    environment: production
    
    # Output values that can be used by dependent workflows
    outputs:
      import-successful: ${{ steps.validate-import.outputs.import-successful }}
      resource-imported: ${{ steps.validate-import.outputs.resource-imported }}
      configuration: ${{ github.event.inputs.configuration }}
      import-metadata: ${{ steps.validate-import.outputs.import-metadata }}
    
    steps:
      # Step 1: Checkout repository for validation
      - name: Checkout Repository for Validation
        uses: actions/checkout@v4
      
      # Step 2: Setup Terraform for validation
      - name: Setup Terraform CLI
        uses: hashicorp/setup-terraform@v3.1.2
        with:
          terraform_version: ${{ vars.TERRAFORM_VERSION || '1.12.2' }}
          terraform_wrapper: false
      
      # Step 3: Authenticate with Azure for state access
      - name: Azure Login with OIDC
        uses: azure/login@v2.3.0
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      
      # Step 4: Add JIT Network Access for validation
      - name: Add JIT Network Access for Validation
        id: jit-add
        uses: ./.github/actions/jit-network-access
        with:
          action: 'add'
          storage-account-name: ${{ secrets.TERRAFORM_STORAGE_ACCOUNT }}
          resource-group-name: ${{ secrets.TERRAFORM_RESOURCE_GROUP }}
      
      # Step 5: Initialize Terraform for validation
      - name: Initialize Terraform for Validation
        uses: ./.github/actions/terraform-init-with-backend
        env:
          ARM_STORAGE_ACCOUNT_NAME: ${{ secrets.TERRAFORM_STORAGE_ACCOUNT }}
          ARM_CONTAINER_NAME: ${{ secrets.TERRAFORM_CONTAINER }}
          ARM_RESOURCE_GROUP_NAME: ${{ secrets.TERRAFORM_RESOURCE_GROUP }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          ARM_USE_OIDC: true
          POWER_PLATFORM_USE_OIDC: true
          POWER_PLATFORM_CLIENT_ID: ${{ secrets.POWER_PLATFORM_CLIENT_ID }}
          POWER_PLATFORM_TENANT_ID: ${{ secrets.POWER_PLATFORM_TENANT_ID }}
        with:
          configuration: ${{ github.event.inputs.configuration }}
          tfvars-file: ${{ github.event.inputs.tfvars_file }}
      
      # Step 6: Validate Import Success
      - name: Validate Import Results
        id: validate-import
        run: |
          config="${{ github.event.inputs.configuration }}"
          tfvars_file="${{ github.event.inputs.tfvars_file }}"
          resource_type="${{ github.event.inputs.resource_type }}"
          resource_name="${{ github.event.inputs.resource_name }}"
          resource_id="${{ github.event.inputs.resource_id }}"
          
          cd "configurations/$config"
          
          # Check if import operation from reusable workflow was successful
          if [ "${{ needs.terraform-import.outputs.operation-successful }}" = "true" ]; then
            echo "::notice title=Import Operation::âœ… Reusable workflow reported successful import"
            
            # Validate the imported resource exists in state
            echo "::notice title=State Validation::ðŸ” Validating imported resource in Terraform state"
            
            resource_address="${resource_type}.${resource_name}"
            
            if terraform state show "$resource_address" > /dev/null 2>&1; then
              echo "::notice title=Import Verified::âœ… Resource $resource_address found in Terraform state"
              
              # Get resource details for validation
              resource_details=$(terraform state show "$resource_address")
              
              echo "::notice title=Resource Details::ðŸ“Š Retrieved resource details from state"
              echo "::group::Imported Resource Details"
              echo "$resource_details"
              echo "::endgroup::"
              
              # Validate resource ID matches what was imported
              if echo "$resource_details" | grep -q "$resource_id"; then
                echo "::notice title=ID Validation::âœ… Resource ID $resource_id confirmed in state"
                import_successful="true"
                resource_imported="$resource_address"
              else
                echo "::warning title=ID Mismatch::âš ï¸ Expected resource ID $resource_id not found in state details"
                import_successful="false"
                resource_imported=""
              fi
            else
              echo "::error title=Import Failed::âŒ Resource $resource_address not found in Terraform state"
              import_successful="false"
              resource_imported=""
            fi
          else
            echo "::error title=Operation Failed::âŒ Reusable workflow reported failed import operation"
            import_successful="false"
            resource_imported=""
          fi
          
          # Generate comprehensive metadata
          timestamp=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          
          metadata=$(jq -n \
            --arg timestamp "$timestamp" \
            --arg config "$config" \
            --arg tfvars "$tfvars_file" \
            --arg resource_type "$resource_type" \
            --arg resource_name "$resource_name" \
            --arg resource_id "$resource_id" \
            --arg successful "$import_successful" \
            --arg imported_resource "$resource_imported" \
            --arg workflow_run "${{ github.run_number }}" \
            --arg triggered_by "${{ github.actor }}" \
            --arg operation_metadata "${{ needs.terraform-import.outputs.operation-metadata }}" \
            '{
              "import_validation": {
                "validated_at": $timestamp,
                "import_successful": ($successful == "true"),
                "resource_imported": $imported_resource,
                "configuration": $config,
                "tfvars_file": $tfvars,
                "resource_specification": {
                  "type": $resource_type,
                  "name": $resource_name,
                  "id": $resource_id
                },
                "workflow_context": {
                  "run_number": $workflow_run,
                  "triggered_by": $triggered_by
                }
              },
              "terraform_operation": ($operation_metadata | fromjson? // {})
            }'
          )
          
          # Set outputs
          echo "import-successful=$import_successful" >> $GITHUB_OUTPUT
          echo "resource-imported=$resource_imported" >> $GITHUB_OUTPUT
          {
            echo "import-metadata<<METADATA_EOF"
            echo "$metadata"
            echo "METADATA_EOF"
          } >> $GITHUB_OUTPUT
          
          cd - > /dev/null
      
      # Step 7: Remove JIT Network Access
      - name: Remove JIT Network Access
        if: always()
        uses: ./.github/actions/jit-network-access
        with:
          action: 'remove'
          storage-account-name: ${{ secrets.TERRAFORM_STORAGE_ACCOUNT }}
          resource-group-name: ${{ secrets.TERRAFORM_RESOURCE_GROUP }}
      
      # Step 8: Generate Workflow Summary
      - name: Generate Import Summary
        run: |
          config="${{ github.event.inputs.configuration }}"
          tfvars_file="${{ github.event.inputs.tfvars_file }}"
          resource_type="${{ github.event.inputs.resource_type }}"
          resource_name="${{ github.event.inputs.resource_name }}"
          resource_id="${{ github.event.inputs.resource_id }}"
          
          echo "## ðŸ“¥ Terraform Import Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Import Details" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Parameter | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Configuration | \`$config\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Tfvars File | \`$tfvars_file.tfvars\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Resource Type | \`$resource_type\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Resource Name | \`$resource_name\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Resource ID | \`$resource_id\` |" >> $GITHUB_STEP_SUMMARY
          echo "| State Backup | \`${{ github.event.inputs.backup_state }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.validate-import.outputs.import-successful }}" = "true" ]; then
            echo "### âœ… Import Successful" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The resource has been successfully imported into Terraform state:" >> $GITHUB_STEP_SUMMARY
            echo "- **Resource Address**: \`${{ steps.validate-import.outputs.resource-imported }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- **State Key**: \`${{ needs.terraform-import.outputs.state-key-used }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- **Configuration Path**: \`configurations/$config\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“‹ Next Steps" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "1. **Plan Review**: Run \`terraform plan\` to verify no changes are needed" >> $GITHUB_STEP_SUMMARY
            echo "2. **Configuration Update**: Ensure Terraform configuration matches imported resource" >> $GITHUB_STEP_SUMMARY
            echo "3. **Documentation**: Update documentation to reflect the imported resource" >> $GITHUB_STEP_SUMMARY
            echo "4. **Validation**: Test the configuration with plan/apply cycle" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Import Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The import operation was not successful. Please review the logs and:" >> $GITHUB_STEP_SUMMARY
            echo "1. **Verify Resource ID**: Ensure the resource ID \`$resource_id\` is correct" >> $GITHUB_STEP_SUMMARY
            echo "2. **Check Configuration**: Verify the Terraform configuration exists for \`$resource_type.$resource_name\`" >> $GITHUB_STEP_SUMMARY
            echo "3. **Review Permissions**: Ensure proper permissions to access the resource" >> $GITHUB_STEP_SUMMARY
            echo "4. **Check State**: Verify the Terraform state is accessible and not corrupted" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”§ Migration Benefits" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This workflow has been migrated to use the reusable-terraform-base workflow, providing:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… **96% code reduction** (670+ lines â†’ ~30 lines)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… **Standardized import process with proven patterns**" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… **Consistent error handling and state backup procedures**" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… **Enhanced validation through reusable workflow outputs**" >> $GITHUB_STEP_SUMMARY
