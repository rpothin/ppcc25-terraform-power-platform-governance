# Terraform Import Workflow for Power Platform Governance
# This workflow allows importing existing Power Platform resources into Terraform state
# It supports importing resources to make them manageable via Infrastructure as Code
# Includes comprehensive validation, safety checks, backup creation, and verification

name: Terraform Import

# Trigger: Manual workflow dispatch only
# Users can specify which resource to import into which configuration
on:
  workflow_dispatch:
    inputs:
      configuration:
        description: 'Configuration to import the resource into (resource management configurations)'
        required: true
        type: choice
        options:
          - '02-dlp-policy'
          - '03-environment'
      tfvars_file:
        description: 'tfvars file name without extension (e.g., dlp-finance, env-production)'
        required: true
        type: string
      resource_type:
        description: 'Terraform resource type (e.g., powerplatform_data_loss_prevention_policy)'
        required: true
        type: string
      resource_name:
        description: 'Terraform resource name in the configuration (e.g., main)'
        required: true
        type: string
      resource_id:
        description: 'Power Platform resource ID to import (UUID format)'
        required: true
        type: string
      backup_state:
        description: 'Create state backup before import'
        required: true
        type: boolean
        default: true

# Dynamic run name that shows the import operation details
run-name: ðŸ“¥ Terraform Import ${{ github.event.inputs.resource_type }}.${{ github.event.inputs.resource_name }} to ${{ github.event.inputs.configuration }} by @${{ github.actor }}

# Required permissions for OIDC authentication with Azure and Power Platform
permissions:
  id-token: write   # Required for GitHub OIDC token generation
  contents: read    # Required for repository checkout

# No workflow-level environment variables - secrets are only accessible within jobs that specify the production environment

jobs:
  # Job: Import existing resource into Terraform state
  # This job will import the specified resource and validate the import was successful
  # Includes comprehensive validation, backup, and verification steps
  terraform-import:
    name: ðŸ“¥ Terraform Import
    runs-on: ubuntu-latest
    environment: production  # Required to access production environment secrets
    
    # Environment variables for Power Platform OIDC authentication
    # These are set at job level and use secrets only from the production environment
    env:
      POWER_PLATFORM_USE_OIDC: true
      POWER_PLATFORM_CLIENT_ID: ${{ secrets.POWER_PLATFORM_CLIENT_ID }}
      POWER_PLATFORM_TENANT_ID: ${{ secrets.POWER_PLATFORM_TENANT_ID }}
      # Azure context for Power Platform resources - using same app registration
      ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      ARM_USE_OIDC: true
    
    # Output values that can be used by dependent workflows
    outputs:
      import-successful: ${{ steps.import.outputs.import-successful }}
      resource-imported: ${{ steps.import.outputs.resource-imported }}
      configuration: ${{ github.event.inputs.configuration }}
      # Execution metadata for workflow tracking and AVM compliance
      import-metadata: ${{ steps.terraform-import.outputs.import-metadata }}
    
    steps:
    # Step 1: Checkout repository code
    - name: Checkout Repository for Import
      uses: actions/checkout@v4
    
    # Step 2: Validate inputs and prepare for import
    - name: Validate Import Parameters
      run: |
        config="${{ github.event.inputs.configuration }}"
        tfvars_file="${{ github.event.inputs.tfvars_file }}"
        resource_type="${{ github.event.inputs.resource_type }}"
        resource_name="${{ github.event.inputs.resource_name }}"
        resource_id="${{ github.event.inputs.resource_id }}"
        backup_state="${{ github.event.inputs.backup_state }}"
        
        echo "::notice title=Validation Starting::Validating inputs for import operation..."
        echo "::notice title=Import Parameters::Configuration: $config, tfvars: $tfvars_file, Resource: $resource_type.$resource_name, ID: $resource_id"
        
        # Validate configuration directory exists
        if [ ! -d "configurations/$config" ]; then
          echo "::error title=Configuration Not Found::Configuration directory 'configurations/$config' does not exist. Please check the configuration name."
          exit 1
        fi
        
        # Validate this is a resource management configuration
        if [[ "$config" != "02-dlp-policy" && "$config" != "03-environment" ]]; then
          echo "::error title=Invalid Configuration Type::Configuration '$config' is not a resource management configuration. Only resource management configurations should be used for import operations."
          exit 1
        fi
        
        # Validate tfvars file name format
        if [[ ! "$tfvars_file" =~ ^[a-zA-Z0-9_-]+$ ]]; then
          echo "::error title=Invalid tfvars File Name::tfvars file name '$tfvars_file' contains invalid characters. Use only alphanumeric characters, hyphens, and underscores."
          exit 1
        fi
        
        # Validate resource type format (should be a valid Terraform resource type)
        if [[ ! "$resource_type" =~ ^[a-z][a-z0-9_]*$ ]]; then
          echo "::error title=Invalid Resource Type::Resource type '$resource_type' does not match expected Terraform resource type format."
          exit 1
        fi
        
        # Validate resource name format
        if [[ ! "$resource_name" =~ ^[a-zA-Z][a-zA-Z0-9_-]*$ ]]; then
          echo "::error title=Invalid Resource Name::Resource name '$resource_name' does not match expected Terraform resource name format."
          exit 1
        fi
        
        # Validate resource ID format (should be a UUID)
        if ! echo "$resource_id" | grep -qE '^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$'; then
          echo "::error title=Invalid Resource ID::Resource ID '$resource_id' does not appear to be a valid UUID format."
          exit 1
        fi
        
        echo "::notice title=Input Validation Complete::âœ… All input parameters validated successfully"
        echo "::notice title=Import Target::ðŸŽ¯ Will import $resource_type.$resource_name with ID $resource_id"
        
        if [ "$backup_state" = "true" ]; then
          echo "::notice title=Backup Enabled::State backup will be created before import"
        else
          echo "::warning title=Backup Disabled::âš ï¸ State backup is disabled - proceed with caution"
        fi
    
    # Step 3: Authenticate with Azure using OIDC for backend state storage
    - name: Azure Login with OIDC
      uses: azure/login@v2.3.0
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
    
    # Step 4: Add Just-In-Time network access for Terraform backend
    - name: Add JIT Network Access
      id: jit-add
      uses: ./.github/actions/jit-network-access
      with:
        action: 'add'
        storage-account-name: ${{ secrets.TERRAFORM_STORAGE_ACCOUNT }}
        resource-group-name: ${{ secrets.TERRAFORM_RESOURCE_GROUP }}
    
    # Step 5: Install and configure Terraform CLI
    - name: Setup Terraform CLI for Import
      uses: hashicorp/setup-terraform@v3.1.2
      with:
        terraform_version: ${{ vars.TERRAFORM_VERSION || '1.12.2' }}
        terraform_wrapper: false    # Disable wrapper for better output handling
    
    # Step 6: Validate configuration and tfvars file existence
    - name: Validate Configuration Files
      run: |
        config="${{ github.event.inputs.configuration }}"
        tfvars_file="${{ github.event.inputs.tfvars_file }}"
        
        echo "::notice title=File Validation::Validating configuration and tfvars files..."
        
        # Validate tfvars file exists
        tfvars_filename="$tfvars_file.tfvars"
        tfvars_path="configurations/$config/tfvars/$tfvars_filename"
        
        if [ ! -f "$tfvars_path" ]; then
          echo "::error title=tfvars File Not Found::Specified tfvars file '$tfvars_path' does not exist."
          echo "::error title=Available Files::Available tfvars files in configurations/$config/tfvars/:"
          ls -la "configurations/$config/tfvars/" 2>/dev/null || echo "No tfvars directory found"
          exit 1
        fi
        
        # Validate configuration has necessary Terraform files
        if [ ! -f "configurations/$config/main.tf" ] && [ ! -f "configurations/$config/data-sources.tf" ]; then
          echo "::error title=Invalid Configuration::No Terraform files found in configuration '$config'. Expected main.tf or data-sources.tf."
          exit 1
        fi
        
        echo "::notice title=Files Validated::âœ… Configuration and tfvars files validated successfully"
        echo "::notice title=Using Files::Configuration: configurations/$config/, tfvars: $tfvars_path"
    
    # Step 7: Initialize Terraform and perform pre-import state check
    - name: Initialize Terraform and Check State
      run: |
        config="${{ github.event.inputs.configuration }}"
        resource_type="${{ github.event.inputs.resource_type }}"
        resource_name="${{ github.event.inputs.resource_name }}"
        
        echo "::notice title=Initializing Terraform::Initializing Terraform for configuration: $config"
        cd "configurations/$config"
        
        # Add a small delay to ensure network rules are fully propagated
        echo "Waiting 10 seconds for network rules to propagate..."
        sleep 10
        
        # Initialize Terraform with Azure backend for state storage (with retry logic)
        echo "::notice title=Terraform Init::Initializing Terraform for import operations..."
        
        # Retry logic for terraform init (network-dependent operation)
        max_retries=3
        retry_count=0
        init_success=false
        
        while [ $retry_count -lt $max_retries ] && [ "$init_success" = false ]; do
          retry_count=$((retry_count + 1))
          echo "::notice title=Init Attempt::ðŸ”„ Terraform init attempt $retry_count of $max_retries..."
          
          if terraform init \
            -backend-config="storage_account_name=${{ secrets.TERRAFORM_STORAGE_ACCOUNT }}" \
            -backend-config="container_name=${{ secrets.TERRAFORM_CONTAINER }}" \
            -backend-config="key=$config.tfstate" \
            -backend-config="resource_group_name=${{ secrets.TERRAFORM_RESOURCE_GROUP }}" \
            -backend-config="subscription_id=${{ secrets.AZURE_SUBSCRIPTION_ID }}" \
            -backend-config="tenant_id=${{ secrets.AZURE_TENANT_ID }}" \
            -backend-config="use_oidc=true"; then
            
            init_success=true
            echo "::notice title=Init Success::âœ… Terraform init for import completed successfully on attempt $retry_count"
          else
            echo "::warning title=Init Failed::âš ï¸ Terraform init attempt $retry_count failed"
            if [ $retry_count -lt $max_retries ]; then
              wait_time=$((retry_count * 10))
              echo "::notice title=Retry Delay::â±ï¸ Waiting ${wait_time} seconds before retry..."
              sleep $wait_time
            fi
          fi
        done
        
        if [ "$init_success" = false ]; then
          echo "::error title=Init Failed::âŒ Terraform init failed after $max_retries attempts"
          echo "::notice title=Context::ðŸ“‹ This init occurs for import operations"
          echo "::notice title=Documentation::ðŸ“š Error Reference: https://github.com/${{ github.repository }}/blob/main/docs/references/workflow-error-reference.md#terraform-init-errors"
          exit 1
        fi
        
        # Validate Terraform configuration syntax
        terraform validate
        
        # Check if resource already exists in state
        echo "::notice title=Pre-Import State Check::Checking if resource $resource_type.$resource_name already exists in state..."
        
        if terraform state show "$resource_type.$resource_name" 2>/dev/null; then
          echo "::error title=Resource Already Exists::Resource $resource_type.$resource_name already exists in Terraform state. Cannot import a resource that is already managed."
          echo "::notice title=Existing Resource::Use 'terraform state rm $resource_type.$resource_name' to remove from state if you need to re-import"
          exit 1
        else
          echo "::notice title=Resource Not in State::âœ… Resource $resource_type.$resource_name does not exist in state - ready for import"
        fi
        
        # Show current state for reference
        echo "::group::Current Terraform State"
        state_list=$(terraform state list 2>/dev/null || echo "No resources in state")
        echo "$state_list"
        resource_count=$(echo "$state_list" | grep -v "^$" | grep -v "No resources" | wc -l || echo "0")
        echo "Current resource count: $resource_count"
        echo "::endgroup::"
        
        echo "::notice title=Terraform Initialized::âœ… Terraform initialized and state checked successfully"
        
        cd - > /dev/null
    
    # Step 8: Create comprehensive backup of current state
    - name: Create State Backup for Import
      if: github.event.inputs.backup_state == 'true'
      run: |
        config="${{ github.event.inputs.configuration }}"
        timestamp=$(date +%Y%m%d-%H%M%S)
        
        cd "configurations/$config"
        
        echo "::notice title=Creating Backup::Creating comprehensive backup of current Terraform state..."
        
        # Create backups directory if it doesn't exist
        mkdir -p backups
        
        # Pull current state and create timestamped backup
        backup_filename="backups/terraform.tfstate.backup-$timestamp"
        terraform state pull > "$backup_filename" 2>/dev/null || echo "{}" > "$backup_filename"
        
        # Verify backup was created successfully
        if [ -s "$backup_filename" ] && [ "$(cat "$backup_filename")" != "{}" ]; then
          backup_size=$(du -h "$backup_filename" | cut -f1)
          echo "::notice title=Backup Created::âœ… State backup created successfully"
          echo "::notice title=Backup Details::File: $backup_filename, Size: $backup_size"
          
          # Count resources in backup
          resource_count=$(jq '.resources | length' "$backup_filename" 2>/dev/null || echo "0")
          echo "::notice title=Resources in Backup::Resources: $resource_count"
          
          # Add backup file to git for persistence
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add "$backup_filename"
          
          if ! git diff --cached --quiet; then
            git commit -m "backup: create state backup before import operation

            Configuration: $config
            Timestamp: $timestamp
            Backup for: import ${{ github.event.inputs.resource_type }}.${{ github.event.inputs.resource_name }}
            Resource ID: ${{ github.event.inputs.resource_id }}
            Resources in state: $resource_count
            Executed by: @${{ github.actor }}
            
            This backup was created automatically before terraform import operation."
            git push origin main
            echo "::notice title=Backup Committed::State backup committed to repository"
          fi
        else
          echo "::notice title=No Previous State::No existing state to backup - this is normal for new configurations"
          rm -f "$backup_filename"
        fi
        
        cd - > /dev/null
    
    # Step 9: Perform the import operation
    - name: Execute Terraform Import Operation
      id: terraform-import
      run: |
        config="${{ github.event.inputs.configuration }}"
        tfvars_file="${{ github.event.inputs.tfvars_file }}"
        resource_type="${{ github.event.inputs.resource_type }}"
        resource_name="${{ github.event.inputs.resource_name }}"
        resource_id="${{ github.event.inputs.resource_id }}"
        
        cd "configurations/$config"
        
        tfvars_filename="$tfvars_file.tfvars"
        tfvars_path="tfvars/$tfvars_filename"
        
        echo "::notice title=Starting Import::Importing $resource_type.$resource_name with ID: $resource_id"
        
        # Generate execution metadata for AVM compliance
        timestamp=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
        terraform_version=$(terraform --version | head -1 | sed 's/Terraform v//')
        
        # Create comprehensive metadata object for import operation using jq
        import_metadata_json=$(jq -n \
          --arg timestamp "$timestamp" \
          --arg workflow_run "${{ github.run_number }}" \
          --arg workflow_id "${{ github.run_id }}" \
          --arg generated_by "${{ github.actor }}" \
          --arg tf_version "$terraform_version" \
          --arg workflow_version "1.0.0" \
          --arg configuration "$config" \
          --arg tfvars_file "$tfvars_file" \
          --arg repository "${{ github.repository }}" \
          --arg ref "${{ github.ref }}" \
          --arg sha "${{ github.sha }}" \
          --arg event "${{ github.event_name }}" \
          --arg runner_os "${{ runner.os }}" \
          --arg runner_arch "${{ runner.arch }}" \
          --arg operation "import" \
          --arg resource_type "$resource_type" \
          --arg resource_name "$resource_name" \
          --arg resource_id "$resource_id" \
          '{
            "generated_at": $timestamp,
            "workflow_run": $workflow_run,
            "workflow_id": $workflow_id,
            "generated_by": $generated_by,
            "terraform_version": $tf_version,
            "workflow_version": $workflow_version,
            "configuration": $configuration,
            "tfvars_file": $tfvars_file,
            "repository": $repository,
            "ref": $ref,
            "sha": $sha,
            "event": $event,
            "runner_os": $runner_os,
            "runner_arch": $runner_arch,
            "operation": $operation,
            "resource_type": $resource_type,
            "resource_name": $resource_name,
            "resource_id": $resource_id
          }'
        )
        
        # Set GitHub output using multiline format
        {
          echo "import-metadata<<METADATA_EOF"
          echo "$import_metadata_json"
          echo "METADATA_EOF"
        } >> $GITHUB_OUTPUT
        
        echo "::notice title=Metadata Generated::ðŸ“Š Import metadata created for AVM compliance"
        
        # Perform the import with comprehensive variable loading
        echo "::notice title=Import Execution::Executing terraform import command..."
        terraform import \
          -var-file="../../terraform.tfvars" \
          -var-file="$tfvars_path" \
          "$resource_type.$resource_name" \
          "$resource_id"
        
        import_exit_code=$?
        
        if [ $import_exit_code -eq 0 ]; then
          echo "::notice title=Import Successful::âœ… Resource $resource_type.$resource_name imported successfully"
          echo "import-successful=true" >> $GITHUB_OUTPUT
          echo "resource-imported=$resource_type.$resource_name" >> $GITHUB_OUTPUT
        else
          echo "::error title=Import Failed::âŒ Failed to import resource $resource_type.$resource_name"
          echo "::notice title=Error Context::ðŸ“‹ Import failure occurred during resource import phase"
          echo "::notice title=Exit Code::ðŸ”¢ Terraform import exited with code: $import_exit_code"
          echo "::notice title=Troubleshooting::ðŸ” Common terraform import failure causes:"
          echo "::notice title=Issue 1::ðŸ” Resource ID not found or inaccessible in Power Platform"
          echo "::notice title=Issue 2::ðŸ”‘ Insufficient permissions to access the resource"  
          echo "::notice title=Issue 3::ðŸ·ï¸ Resource type mismatch with actual Power Platform resource"
          echo "::notice title=Issue 4::ðŸ’¾ Resource already exists in Terraform state"
          echo "::notice title=Issue 5::ðŸŒ Network connectivity issues to Power Platform API"
          echo "::notice title=Solution 1::ðŸ” Verify resource ID exists in Power Platform admin center"
          echo "::notice title=Solution 2::ðŸ” Check service principal has read access to the resource"
          echo "::notice title=Solution 3::ðŸ·ï¸ Confirm resource type matches Power Platform resource type"
          echo "::notice title=Solution 4::ðŸ’¾ Check if resource is already in state with 'terraform state list'"
          echo "::notice title=Solution 5::ðŸ”„ Re-run workflow if transient network issues occurred"
          echo "::notice title=Documentation::ðŸ“š Error Reference: https://github.com/${{ github.repository }}/blob/main/docs/references/workflow-error-reference.md#terraform-apply-errors"
          echo "::notice title=Power Platform::ðŸ“š Terraform Provider: https://registry.terraform.io/providers/microsoft/power-platform/latest/docs"
          echo "import-successful=false" >> $GITHUB_OUTPUT
          echo "resource-imported=" >> $GITHUB_OUTPUT
          exit 1
        fi
        
        cd - > /dev/null
    
    # Step 10: Verify import with state show
    - name: Verify Import
      run: |
        config="${{ github.event.inputs.configuration }}"
        resource_type="${{ github.event.inputs.resource_type }}"
        resource_name="${{ github.event.inputs.resource_name }}"
        
        cd "configurations/$config"
        
        echo "::notice title=Verifying Import::Verifying imported resource state..."
        
        # Show the imported resource state
        echo "::group::Imported Resource State"
        terraform state show "$resource_type.$resource_name"
        echo "::endgroup::"
        
        # List all resources to confirm import
        echo "::group::Updated State List"
        terraform state list
        echo "::endgroup::"
        
        echo "::notice title=Import Verified::âœ… Resource state verified successfully"
        
        cd - > /dev/null
    
    # Step 11: Test configuration consistency after import
    - name: Post-Import Plan Check
      run: |
        config="${{ github.event.inputs.configuration }}"
        tfvars_file="${{ github.event.inputs.tfvars_file }}"
        
        cd "configurations/$config"
        
        tfvars_filename="$tfvars_file.tfvars"
        tfvars_path="tfvars/$tfvars_filename"
        
        echo "::notice title=Post-Import Validation::Running Terraform plan to validate imported resource configuration..."
        
        # Run plan to see if the imported resource matches the configuration
        terraform plan -detailed-exitcode \
          -var-file="../../terraform.tfvars" \
          -var-file="$tfvars_path" || plan_exit_code=$?
        
        # Analyze plan results
        if [ $plan_exit_code -eq 0 ]; then
          echo "::notice title=Perfect Match::âœ… Imported resource matches Terraform configuration exactly - no changes needed"
        elif [ $plan_exit_code -eq 2 ]; then
          echo "::warning title=Configuration Drift::âš ï¸ Plan shows differences between imported resource and configuration. This is normal and may require configuration updates."
          echo "::notice title=Next Steps::Review the plan above and update your Terraform configuration to match the imported resource state, or adjust the resource as needed."
        else
          echo "::error title=Plan Failed::âŒ Post-import plan failed - unable to validate imported resource"
          echo "::notice title=Error Context::ðŸ“‹ Post-import plan failure indicates configuration or state issues"
          echo "::notice title=Exit Code::ðŸ”¢ Terraform plan exited with code: $plan_exit_code"
          echo "::notice title=Troubleshooting::ðŸ” Common post-import plan failure causes:"
          echo "::notice title=Issue 1::ðŸ“ Configuration syntax errors or invalid resource definitions"
          echo "::notice title=Issue 2::ðŸ”— Incorrect resource references in imported configuration"  
          echo "::notice title=Issue 3::ðŸ’¾ State file corruption during import process"
          echo "::notice title=Issue 4::ðŸ·ï¸ Resource attribute mismatches with imported resource"
          echo "::notice title=Issue 5::ðŸ”‘ Permission changes affecting resource access"
          echo "::notice title=Solution 1::ðŸ“ Review configuration files for syntax errors"
          echo "::notice title=Solution 2::ðŸ” Check imported resource attributes match configuration"
          echo "::notice title=Solution 3::ðŸ’¾ Verify state file integrity after import"
          echo "::notice title=Solution 4::ðŸ”„ Re-run import process if state corruption suspected"
          echo "::notice title=Solution 5::ðŸ“š Review Power Platform provider documentation for resource requirements"
          echo "::notice title=Documentation::ðŸ“š Error Reference: https://github.com/${{ github.repository }}/blob/main/docs/references/workflow-error-reference.md#terraform-plan-errors"
          echo "::notice title=Import Guide::ðŸ“š Terraform Import: https://developer.hashicorp.com/terraform/cli/import"
          exit 1
        fi
        
        cd - > /dev/null
    
    # Step 12: Upload import artifacts for audit trail
    - name: Upload Import Artifacts
      if: steps.terraform-import.outputs.import-successful == 'true'
      run: |
        config="${{ github.event.inputs.configuration }}"
        cd "configurations/$config"
        
        # Create metadata file for artifact
        cat > "import-metadata.json" <<EOF
        ${{ steps.terraform-import.outputs.import-metadata }}
        EOF
        
        echo "::notice title=Metadata Created::ðŸ“Š Import metadata file created for artifact"
        cd - > /dev/null
        
    - name: Upload Artifacts with Metadata
      if: steps.terraform-import.outputs.import-successful == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: terraform-import-${{ github.event.inputs.configuration }}-${{ github.run_number }}
        path: |
          configurations/${{ github.event.inputs.configuration }}/backups/terraform.tfstate.backup-*
          configurations/${{ github.event.inputs.configuration }}/terraform.tfstate.backup.*
          configurations/${{ github.event.inputs.configuration }}/import-metadata.json
        retention-days: 30    # Keep import artifacts for 30 days for audit trail
        description: 'Terraform state backups from import operation for ${{ github.event.inputs.configuration }} - contains pre-import state snapshots for recovery with execution metadata'
    
    # Step 13: Generate comprehensive summary report
    - name: Generate Import Summary
      run: |
        config="${{ github.event.inputs.configuration }}"
        tfvars_file="${{ github.event.inputs.tfvars_file }}"
        resource_type="${{ github.event.inputs.resource_type }}"
        resource_name="${{ github.event.inputs.resource_name }}"
        resource_id="${{ github.event.inputs.resource_id }}"
        import_successful="${{ steps.import.outputs.import-successful }}"
        
        if [ "$import_successful" = "true" ]; then
          echo "::notice title=Import Complete::âœ… Terraform import operation completed successfully"
          summary_status="âœ… SUCCESSFUL"
        else
          echo "::error title=Import Failed::âŒ Terraform import operation failed"
          summary_status="âŒ FAILED"
        fi
        
        echo "## ðŸ“¥ Terraform Import Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Import Status: $summary_status" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Import Details" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Parameter | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| Configuration | \`$config\` |" >> $GITHUB_STEP_SUMMARY
        echo "| tfvars File | \`$tfvars_file.tfvars\` |" >> $GITHUB_STEP_SUMMARY
        echo "| Resource Type | \`$resource_type\` |" >> $GITHUB_STEP_SUMMARY
        echo "| Resource Name | \`$resource_name\` |" >> $GITHUB_STEP_SUMMARY
        echo "| Resource ID | \`$resource_id\` |" >> $GITHUB_STEP_SUMMARY
        echo "| Backup Created | ${{ github.event.inputs.backup_state }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Timestamp | $(date +%Y-%m-%d\ %H:%M:%S) |" >> $GITHUB_STEP_SUMMARY
        echo "| Executed by | @${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Workflow run | [${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Add import analysis section
        cd "configurations/$config"
        if [ "$import_successful" = "true" ]; then
          # Check current state after import
          current_resources=$(terraform state list 2>/dev/null | wc -l || echo "0")
          
          echo "### ðŸ“Š Import Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Analysis Detail | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Import Status** | âœ… Successful |" >> $GITHUB_STEP_SUMMARY
          echo "| **Resource Added** | \`$resource_type.$resource_name\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Total State Resources** | $current_resources |" >> $GITHUB_STEP_SUMMARY
          echo "| **Configuration Status** | Ready for validation |" >> $GITHUB_STEP_SUMMARY
          echo "| **Next Action Required** | Configuration alignment check |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
        else
          echo "### ðŸ“Š Import Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Analysis Detail | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Import Status** | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          echo "| **Attempted Resource** | \`$resource_type.$resource_name\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Resource ID** | \`$resource_id\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Action Required** | Review error and retry |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
        fi
        cd - > /dev/null
        
        if [ "$import_successful" = "true" ]; then
          echo "### âœ… Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. **Review Configuration**: Ensure your Terraform configuration matches the imported resource" >> $GITHUB_STEP_SUMMARY
          echo "2. **Test Plan**: Run the plan/apply workflow to see any differences between current state and desired configuration" >> $GITHUB_STEP_SUMMARY
          echo "3. **Update Configuration**: Modify your \`.tf\` files as needed to align with the imported resource" >> $GITHUB_STEP_SUMMARY
          echo "4. **Run Apply**: Once configuration is aligned, run the plan/apply workflow to ensure consistency" >> $GITHUB_STEP_SUMMARY
          echo "5. **Documentation**: Update documentation to reflect the newly managed resource" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”„ Configuration Alignment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Alignment Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Resource Imported** | âœ… Added to Terraform state |" >> $GITHUB_STEP_SUMMARY
          echo "| **Configuration Match** | Requires validation via plan |" >> $GITHUB_STEP_SUMMARY
          echo "| **Drift Detection** | Available in next plan execution |" >> $GITHUB_STEP_SUMMARY
          echo "| **Recommended Action** | Run terraform plan to check alignment |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Post-Import Validation Guide:**" >> $GITHUB_STEP_SUMMARY
          echo "- **No changes in plan**: âœ… Configuration perfectly matches imported resource" >> $GITHUB_STEP_SUMMARY
          echo "- **Changes detected in plan**: âš ï¸ Update configuration to align with resource state" >> $GITHUB_STEP_SUMMARY
          echo "- **Plan fails**: âŒ Check for configuration issues or missing dependencies" >> $GITHUB_STEP_SUMMARY
        else
          echo "### âŒ Troubleshooting Guide" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Troubleshooting Area | Check |" >> $GITHUB_STEP_SUMMARY
          echo "|---------------------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Resource ID Format** | Verify UUID format and validity |" >> $GITHUB_STEP_SUMMARY
          echo "| **Resource Existence** | Confirm resource exists in Power Platform |" >> $GITHUB_STEP_SUMMARY
          echo "| **Permissions** | Check service principal permissions |" >> $GITHUB_STEP_SUMMARY
          echo "| **Provider Version** | Ensure Power Platform provider supports resource type |" >> $GITHUB_STEP_SUMMARY
          echo "| **Configuration** | Validate Terraform configuration syntax |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Common Import Issues:**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. **Invalid Resource ID**: Ensure the ID is in the correct format for the resource type" >> $GITHUB_STEP_SUMMARY
          echo "2. **Resource Not Found**: Verify the resource exists and is accessible" >> $GITHUB_STEP_SUMMARY
          echo "3. **Permission Denied**: Check that the service principal has read access to the resource" >> $GITHUB_STEP_SUMMARY
          echo "4. **Configuration Mismatch**: Ensure Terraform configuration block exists for the resource" >> $GITHUB_STEP_SUMMARY
          echo "5. **Provider Limitations**: Some resources may not support import operations" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âš ï¸ Important Notes" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ "$import_successful" = "true" ]; then
          echo "- **âœ… Resource Under Management**: The imported resource is now managed by Terraform" >> $GITHUB_STEP_SUMMARY
          echo "- **ðŸš« Avoid Manual Changes**: Make changes only through Terraform to prevent drift" >> $GITHUB_STEP_SUMMARY
          echo "- **ðŸ”„ Future Updates**: Use terraform plan/apply workflow for all modifications" >> $GITHUB_STEP_SUMMARY
          echo "- **ðŸ“‹ Next Required Action**: Run terraform plan to validate configuration alignment" >> $GITHUB_STEP_SUMMARY
        else
          echo "- **âŒ Import Failed**: Resource was not imported into Terraform state" >> $GITHUB_STEP_SUMMARY
          echo "- **ðŸ” Investigation Required**: Review error logs and troubleshooting guide above" >> $GITHUB_STEP_SUMMARY
          echo "- **ðŸ”„ Retry Available**: Fix issues and re-run import workflow" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ github.event.inputs.backup_state }}" = "true" ]; then
          echo "- **ðŸ’¾ State Backup**: Pre-import backup created for rollback if needed" >> $GITHUB_STEP_SUMMARY
          echo "- **ðŸ”™ Rollback Available**: Use backup to restore previous state if required" >> $GITHUB_STEP_SUMMARY
        else
          echo "- **âš ï¸ No Backup**: Pre-import backup was disabled - limited rollback options" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "- **ðŸ”’ Network Security**: JIT network access used for secure backend connectivity" >> $GITHUB_STEP_SUMMARY
        echo "- **ðŸ“ Audit Trail**: Import operation logged in workflow history and artifacts" >> $GITHUB_STEP_SUMMARY
        echo "- **ðŸ“š Documentation**: Update project documentation to reflect new managed resource" >> $GITHUB_STEP_SUMMARY
        echo "- **ðŸŽ¯ Configuration**: Applied to configuration \`$config\` with variables \`$tfvars_file.tfvars\`" >> $GITHUB_STEP_SUMMARY
        
        echo "::notice title=Summary Generated::Import summary added to job summary"
    
    # Step 14: Remove Just-In-Time network access
    - name: Remove JIT Network Access
      if: always()
      uses: ./.github/actions/jit-network-access
      with:
        action: 'remove'
        storage-account-name: ${{ secrets.TERRAFORM_STORAGE_ACCOUNT }}
        resource-group-name: ${{ secrets.TERRAFORM_RESOURCE_GROUP }}
