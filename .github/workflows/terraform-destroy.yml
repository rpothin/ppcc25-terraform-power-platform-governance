# Terraform Destroy Workflow for Power Platform Governance
# This workflow allows safe destruction of Terraform-managed Power Platform resources
# It includes validation, confirmation steps, and backup operations to prevent accidental deletion

name: Terraform Destroy

# Prevent concurrent Terraform operations on same configuration/tfvars combination
concurrency:
  group: terraform-${{ github.event.inputs.configuration || 'default' }}-${{ github.event.inputs.tfvars_file || 'default' }}-${{ github.ref }}
  cancel-in-progress: false  # Don't cancel running Terraform operations

# Trigger: Manual workflow dispatch only with explicit confirmation
# Users must provide explicit confirmation to prevent accidental resource destruction
on:
  workflow_dispatch:
    inputs:
      configuration:
        description: 'Configuration to destroy (resource management configurations)'
        required: true
        type: choice
        options:
          - '02-dlp-policy'
          - '03-environment'
      tfvars_file:
        description: 'tfvars file name without extension (e.g., dlp-finance, env-production)'
        required: true
        type: string
      confirmation:
        description: 'Type "DESTROY" to confirm resource destruction (case sensitive)'
        required: true
        type: string
      backup_state:
        description: 'Create state backup before destroy'
        required: true
        type: boolean
        default: true
      force_destroy:
        description: 'Force destroy even if plan shows no resources (use with caution)'
        required: false
        type: boolean
        default: false

# Dynamic run name that clearly indicates the destructive nature of the operation
run-name: üö® Terraform DESTROY ${{ github.event.inputs.configuration }} (${{ github.event.inputs.tfvars_file }}) by @${{ github.actor }}

# Required permissions for OIDC authentication with Azure and Power Platform
permissions:
  id-token: write   # Required for GitHub OIDC token generation
  contents: write   # Required for repository checkout and committing backups

# No workflow-level environment variables - secrets are only accessible within jobs that specify the production environment

jobs:
  # Job 1: Validation and Safety Checks
  # Validates inputs, checks state, and prepares for destruction
  # This job acts as a safety gate before the actual destroy operation
  terraform-validate:
    name: üîç Validation and Safety Checks
    runs-on: ubuntu-latest
    environment: production  # Required to access production environment secrets
    
    # Environment variables for Power Platform OIDC authentication
    # These are set at job level and use secrets only from the production environment
    env:
      POWER_PLATFORM_USE_OIDC: true
      POWER_PLATFORM_CLIENT_ID: ${{ secrets.POWER_PLATFORM_CLIENT_ID }}
      POWER_PLATFORM_TENANT_ID: ${{ secrets.POWER_PLATFORM_TENANT_ID }}
      # Azure context for Power Platform resources - using same app registration
      ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      ARM_USE_OIDC: true
    
    # Output values that can be used by the destroy job
    outputs:
      resources-exist: ${{ steps.state-check.outputs.resources-exist }}
      resource-count: ${{ steps.state-check.outputs.resource-count }}
      configuration: ${{ github.event.inputs.configuration }}
      backup-created: ${{ steps.backup.outputs.backup-created }}
      # Execution metadata for workflow tracking and AVM compliance
      validation-metadata: ${{ steps.state-check.outputs.validation-metadata }}
    
    steps:
    # Step 1: Validate confirmation input
    - name: Validate Destroy Confirmation Input
      run: |
        confirmation="${{ github.event.inputs.confirmation }}"
        
        if [ "$confirmation" != "DESTROY" ]; then
          echo "::error title=Invalid Confirmation::You must type 'DESTROY' (case sensitive) to confirm resource destruction. Provided: '$confirmation'"
          exit 1
        fi
        
        echo "::warning title=Destruction Confirmed::‚ö†Ô∏è User has confirmed resource destruction. Proceeding with validation checks..."
    
    # Step 2: Checkout repository code
    - name: Checkout Repository for Validation
      uses: actions/checkout@v4
    
    # Step 3: Authenticate with Azure using OIDC for backend state storage
    - name: Azure Login with OIDC
      uses: azure/login@v2.3.0
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
    
    # Step 4: Add Just-In-Time network access for Terraform backend
    - name: Add JIT Network Access
      id: jit-add
      uses: ./.github/actions/jit-network-access
      with:
        action: 'add'
        storage-account-name: ${{ secrets.TERRAFORM_STORAGE_ACCOUNT }}
        resource-group-name: ${{ secrets.TERRAFORM_RESOURCE_GROUP }}
    
    # Step 5: Install and configure Terraform CLI
    - name: Setup Terraform CLI for Validation
      uses: hashicorp/setup-terraform@v3.1.2
      with:
        terraform_version: ${{ vars.TERRAFORM_VERSION || '1.12.2' }}
        terraform_wrapper: false    # Disable wrapper for better output handling
    
    # Step 6: Validate inputs and configuration
    - name: Validate Destroy Inputs
      run: |
        config="${{ github.event.inputs.configuration }}"
        tfvars_file="${{ github.event.inputs.tfvars_file }}"
        
        echo "::notice title=Validation Starting::Validating inputs for destroy operation..."
        
        # Validate configuration directory exists
        if [ ! -d "configurations/$config" ]; then
          echo "::error title=Configuration Not Found::Configuration directory 'configurations/$config' does not exist. Please check the configuration name."
          exit 1
        fi
        
        # Validate tfvars file exists
        tfvars_filename="$tfvars_file.tfvars"
        if [ ! -f "configurations/$config/tfvars/$tfvars_filename" ]; then
          echo "::error title=tfvars File Not Found::Specified tfvars file 'tfvars/$tfvars_filename' does not exist in configuration '$config'."
          exit 1
        fi
        
        echo "::notice title=Input Validation Complete::‚úÖ All inputs validated successfully"
        echo "::warning title=Destroy Target::üéØ Target configuration: $config with tfvars: $tfvars_filename"
    
    # Step 7: Initialize Terraform and check current state
    - name: Initialize and Check State
      id: state-check
      run: |
        config="${{ github.event.inputs.configuration }}"
        
        echo "::notice title=Initializing Terraform::Initializing Terraform for configuration: $config"
        cd "configurations/$config"
        
        # Add a small delay to ensure network rules are fully propagated
        echo "Waiting 10 seconds for network rules to propagate..."
        sleep 10
        
        # Initialize Terraform with Azure backend for state storage (with retry logic)
        echo "::notice title=Terraform Init::Initializing Terraform for destroy planning..."
        
        # Retry logic for terraform init (network-dependent operation)
        max_retries=3
        retry_count=0
        init_success=false
        
        while [ $retry_count -lt $max_retries ] && [ "$init_success" = false ]; do
          retry_count=$((retry_count + 1))
          echo "::notice title=Init Attempt::üîÑ Terraform init attempt $retry_count of $max_retries..."
          
          if terraform init \
            -backend-config="storage_account_name=${{ secrets.TERRAFORM_STORAGE_ACCOUNT }}" \
            -backend-config="container_name=${{ secrets.TERRAFORM_CONTAINER }}" \
            -backend-config="key=$config-${{ github.event.inputs.tfvars_file }}.tfstate" \
            -backend-config="resource_group_name=${{ secrets.TERRAFORM_RESOURCE_GROUP }}" \
            -backend-config="subscription_id=${{ secrets.AZURE_SUBSCRIPTION_ID }}" \
            -backend-config="tenant_id=${{ secrets.AZURE_TENANT_ID }}" \
            -backend-config="use_oidc=true"; then
            
            init_success=true
            echo "::notice title=Init Success::‚úÖ Terraform init completed successfully on attempt $retry_count"
          else
            echo "::warning title=Init Failed::‚ö†Ô∏è Terraform init attempt $retry_count failed"
            if [ $retry_count -lt $max_retries ]; then
              wait_time=$((retry_count * 10))
              echo "::notice title=Retry Delay::‚è±Ô∏è Waiting ${wait_time} seconds before retry..."
              sleep $wait_time
            fi
          fi
        done
        
        if [ "$init_success" = false ]; then
          echo "::error title=Init Failed::‚ùå Terraform init failed after $max_retries attempts"
          echo "::notice title=Context::üìã This init occurs for destroy planning phase"
          echo "::notice title=Documentation::üìö Error Reference: https://github.com/${{ github.repository }}/blob/main/docs/references/workflow-error-reference.md#terraform-init-errors"
          exit 1
        fi
        
        # Validate Terraform configuration syntax
        terraform validate
        
        # Check current state for resources
        echo "::notice title=State Analysis::Analyzing current Terraform state..."
        
        # Generate execution metadata for AVM compliance
        timestamp=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
        terraform_version=$(terraform --version | head -1 | sed 's/Terraform v//')
        
        # Create comprehensive metadata object for validation phase using jq
        validation_metadata_json=$(jq -n \
          --arg timestamp "$timestamp" \
          --arg workflow_run "${{ github.run_number }}" \
          --arg workflow_id "${{ github.run_id }}" \
          --arg generated_by "${{ github.actor }}" \
          --arg tf_version "$terraform_version" \
          --arg workflow_version "1.0.0" \
          --arg configuration "$config" \
          --arg tfvars_file "${{ github.event.inputs.tfvars_file }}" \
          --arg repository "${{ github.repository }}" \
          --arg ref "${{ github.ref }}" \
          --arg sha "${{ github.sha }}" \
          --arg event "${{ github.event_name }}" \
          --arg runner_os "${{ runner.os }}" \
          --arg runner_arch "${{ runner.arch }}" \
          --arg phase "validation" \
          --arg operation "destroy" \
          '{
            "generated_at": $timestamp,
            "workflow_run": $workflow_run,
            "workflow_id": $workflow_id,
            "generated_by": $generated_by,
            "terraform_version": $tf_version,
            "workflow_version": $workflow_version,
            "configuration": $configuration,
            "tfvars_file": $tfvars_file,
            "repository": $repository,
            "ref": $ref,
            "sha": $sha,
            "event": $event,
            "runner_os": $runner_os,
            "runner_arch": $runner_arch,
            "phase": $phase,
            "operation": $operation
          }'
        )
        
        # Set GitHub output using multiline format
        {
          echo "validation-metadata<<METADATA_EOF"
          echo "$validation_metadata_json"
          echo "METADATA_EOF"
        } >> $GITHUB_OUTPUT
        
        echo "::notice title=Metadata Generated::üìä Validation metadata created for AVM compliance"
        
        # Get list of resources in state
        resource_list=$(terraform state list 2>/dev/null || echo "")
        resource_count=$(echo "$resource_list" | grep -v '^$' | wc -l || echo "0")
        
        echo "::group::Current State Analysis"
        echo "Configuration: $config"
        echo "Resource count in state: $resource_count"
        if [ $resource_count -gt 0 ]; then
          echo "Resources to be destroyed:"
          echo "$resource_list"
        else
          echo "No resources found in state"
        fi
        echo "::endgroup::"
        
        # Set outputs for next job
        if [ $resource_count -gt 0 ]; then
          echo "resources-exist=true" >> $GITHUB_OUTPUT
          echo "::warning title=Resources Found::‚ö†Ô∏è Found $resource_count resource(s) that will be destroyed"
        else
          echo "resources-exist=false" >> $GITHUB_OUTPUT
          echo "::notice title=No Resources::No resources found in state for destruction"
        fi
        echo "resource-count=$resource_count" >> $GITHUB_OUTPUT
        
        cd - > /dev/null
    
    # Step 8: Create state backup (if requested)
    - name: Create State Backup for Destruction
      id: backup
      if: github.event.inputs.backup_state == 'true'
      run: |
        config="${{ github.event.inputs.configuration }}"
        timestamp=$(date +%Y%m%d-%H%M%S)
        
        echo "::notice title=Creating Backup::Creating state backup before destroy operation..."
        cd "configurations/$config"
        
        # Create backups directory if it doesn't exist
        mkdir -p backups
        
        # Pull current state and create timestamped backup
        backup_filename="backups/terraform.tfstate.backup-$timestamp"
        terraform state pull > "$backup_filename"
        
        # Verify backup was created successfully
        if [ -s "$backup_filename" ]; then
          backup_size=$(du -h "$backup_filename" | cut -f1)
          echo "::notice title=Backup Created::‚úÖ State backup created successfully"
          echo "::notice title=Backup Details::File: $backup_filename, Size: $backup_size"
          echo "backup-created=true" >> $GITHUB_OUTPUT
          
          # Add backup file to git for persistence
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add "$backup_filename"
          
          if ! git diff --cached --quiet; then
            git commit -m "backup: create state backup before destroy operation

            Configuration: $config
            Timestamp: $timestamp
            Backup for: destroy operation by @${{ github.actor }}
            Resources in state: ${{ steps.state-check.outputs.resource-count }}
            
            This backup was created automatically before terraform destroy operation."
            git push origin main
            echo "::notice title=Backup Committed::State backup committed to repository"
          fi
        else
          echo "::error title=Backup Failed::Failed to create state backup"
          exit 1
        fi
        
        cd - > /dev/null
    
    # Step 9: Generate destroy plan for review
    - name: Generate Destroy Plan
      run: |
        config="${{ github.event.inputs.configuration }}"
        tfvars_file="${{ github.event.inputs.tfvars_file }}"
        
        cd "configurations/$config"
        
        tfvars_filename="$tfvars_file.tfvars"
        tfvars_path="tfvars/$tfvars_filename"
        
        echo "::notice title=Generating Destroy Plan::Creating destruction plan for review..."
        
        # Generate destroy plan
        terraform plan -destroy -detailed-exitcode -out=destroy-plan \
          -var-file="../../terraform.tfvars" \
          -var-file="$tfvars_path" || destroy_plan_exit_code=$?
        
        # Handle different exit codes from terraform plan -destroy
        if [ $destroy_plan_exit_code -eq 1 ]; then
          echo "::error title=Destroy Plan Failed::‚ùå Terraform destroy plan failed for configuration $config"
          echo "::notice title=Error Context::üìã Destroy plan failure occurred during resource analysis phase"
          echo "::notice title=Troubleshooting::üîç Common terraform destroy plan failure causes:"
          echo "::notice title=Issue 1::üîë Authentication or authorization issues with Power Platform"
          echo "::notice title=Issue 2::üåê Network connectivity issues to Power Platform API"  
          echo "::notice title=Issue 3::üíæ State file corruption or lock conflicts"
          echo "::notice title=Issue 4::üîó Resource dependencies preventing destruction analysis"
          echo "::notice title=Issue 5::üì¶ Provider version compatibility issues"
          echo "::notice title=Solution 1::üîê Verify service principal has required Power Platform permissions"
          echo "::notice title=Solution 2::üîÑ Re-run workflow if transient network or API issues occurred"
          echo "::notice title=Solution 3::üíæ Check state file integrity and clear locks if needed"
          echo "::notice title=Solution 4::üîó Review resource dependencies in Power Platform admin center"
          echo "::notice title=Solution 5::üìö Review Power Platform provider documentation for destroy requirements"
          echo "::notice title=Documentation::üìö Error Reference: https://github.com/${{ github.repository }}/blob/main/docs/references/workflow-error-reference.md#terraform-plan-errors"
          echo "::notice title=Power Platform::üìö Admin Center: https://admin.powerplatform.microsoft.com/"
          exit 1
        elif [ $destroy_plan_exit_code -eq 2 ]; then
          echo "::warning title=Resources to Destroy::‚ö†Ô∏è Terraform destroy plan shows resources will be destroyed"
        else
          echo "::notice title=Nothing to Destroy::No resources found that can be destroyed"
          if [ "${{ github.event.inputs.force_destroy }}" != "true" ]; then
            echo "::error title=No Resources to Destroy::No resources found for destruction and force_destroy is false. If you want to proceed anyway, set force_destroy to true."
            exit 1
          fi
        fi
        
        echo "::group::Destroy Plan Summary"
        terraform show destroy-plan | head -50  # Show first 50 lines for review
        echo "::endgroup::"
        
        cd - > /dev/null
    
    # Step 10: Upload destroy plan as artifact for audit trail
    - name: Upload Destroy Plan as Artifact
      run: |
        config="${{ github.event.inputs.configuration }}"
        cd "configurations/$config"
        
        # Create metadata file for artifact
        cat > "destroy-plan-metadata.json" <<EOF
        ${{ steps.state-check.outputs.validation-metadata }}
        EOF
        
        echo "::notice title=Metadata Created::üìä Destroy plan metadata file created for artifact"
        cd - > /dev/null
        
    - name: Upload Plan with Metadata
      uses: actions/upload-artifact@v4
      with:
        name: terraform-destroy-plan-${{ github.event.inputs.configuration }}-${{ github.run_number }}
        path: |
          configurations/*/destroy-plan
          configurations/*/destroy-plan-metadata.json
        retention-days: 7    # Keep destroy plans for 7 days for audit trail
        description: 'Terraform destroy plan for ${{ github.event.inputs.configuration }} configuration - contains planned resource deletions for audit and rollback purposes with execution metadata'
    
    # Step 11: Remove Just-In-Time network access
    - name: Remove JIT Network Access
      if: always()
      uses: ./.github/actions/jit-network-access
      with:
        action: 'remove'
        storage-account-name: ${{ secrets.TERRAFORM_STORAGE_ACCOUNT }}
        resource-group-name: ${{ secrets.TERRAFORM_RESOURCE_GROUP }}

  # Job 2: Destroy Execution
  # Only runs after successful validation and with explicit resource existence check
  # Performs the actual resource destruction with safety checks
  terraform-destroy:
    name: üö® Terraform Destroy
    runs-on: ubuntu-latest
    environment: production  # Required to access production environment secrets
    needs: terraform-validate    # Depends on successful validation
    
    # Environment variables for Power Platform OIDC authentication
    # These are set at job level and use secrets only from the production environment
    env:
      POWER_PLATFORM_USE_OIDC: true
      POWER_PLATFORM_CLIENT_ID: ${{ secrets.POWER_PLATFORM_CLIENT_ID }}
      POWER_PLATFORM_TENANT_ID: ${{ secrets.POWER_PLATFORM_TENANT_ID }}
      # Azure context for Power Platform resources - using same app registration
      ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      ARM_USE_OIDC: true
    
    # Conditional execution: only run if validation succeeded and resources exist (or force is enabled)
    if: |
      always() && 
      needs.terraform-validate.result == 'success' && 
      (needs.terraform-validate.outputs.resources-exist == 'true' || github.event.inputs.force_destroy == 'true')
    
    steps:
    # Step 1: Final confirmation check
    - name: Final Confirmation
      run: |
        resource_count="${{ needs.terraform-validate.outputs.resource-count }}"
        config="${{ needs.terraform-validate.outputs.configuration }}"
        
        echo "::warning title=Final Warning::üö® FINAL WARNING: About to destroy $resource_count resource(s) in configuration '$config'"
        echo "::warning title=Irreversible Action::‚ö†Ô∏è This action cannot be undone. Resources will be permanently deleted."
        
        # Give a brief pause for emphasis
        sleep 5
        
        echo "::notice title=Proceeding with Destruction::Continuing with terraform destroy operation..."
    
    # Step 2: Checkout repository code
    - name: Checkout Repository for Destroy
      uses: actions/checkout@v4
    
    # Step 3: Authenticate with Azure using OIDC for backend state storage
    - name: Azure Login with OIDC
      uses: azure/login@v2.3.0
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
    
    # Step 4: Add Just-In-Time network access for Terraform backend
    - name: Add JIT Network Access
      id: jit-add
      uses: ./.github/actions/jit-network-access
      with:
        action: 'add'
        storage-account-name: ${{ secrets.TERRAFORM_STORAGE_ACCOUNT }}
        resource-group-name: ${{ secrets.TERRAFORM_RESOURCE_GROUP }}
    
    # Step 5: Install and configure Terraform CLI
    - name: Setup Terraform CLI for Destruction
      uses: hashicorp/setup-terraform@v3.1.2
      with:
        terraform_version: ${{ vars.TERRAFORM_VERSION || '1.12.2' }}
        terraform_wrapper: false
    
    # Step 6: Download the destroy plan created in validation job
    - name: Download Destroy Plan from Artifacts
      uses: actions/download-artifact@v4
      with:
        name: destroy-plan-${{ github.run_number }}
        path: .
    
    # Step 7: Execute the destroy operation
    - name: Execute Terraform Destroy
      run: |
        config="${{ needs.terraform-validate.outputs.configuration }}"
        tfvars_file="${{ github.event.inputs.tfvars_file }}"
        
        echo "::warning title=Executing Destroy::üö® Starting Terraform destroy for configuration: $config"
        cd "configurations/$config"
        
        # Add a small delay to ensure network rules are fully propagated
        echo "Waiting 10 seconds for network rules to propagate..."
        sleep 10
        
        # Re-initialize Terraform (required after downloading artifacts) with retry logic
        echo "::notice title=Terraform Re-init::Re-initializing Terraform for destroy execution..."
        
        # Retry logic for terraform init (network-dependent operation)
        max_retries=3
        retry_count=0
        init_success=false
        
        while [ $retry_count -lt $max_retries ] && [ "$init_success" = false ]; do
          retry_count=$((retry_count + 1))
          echo "::notice title=Init Attempt::üîÑ Terraform init attempt $retry_count of $max_retries..."
          
          if terraform init \
            -backend-config="storage_account_name=${{ secrets.TERRAFORM_STORAGE_ACCOUNT }}" \
            -backend-config="container_name=${{ secrets.TERRAFORM_CONTAINER }}" \
            -backend-config="key=$config-${{ github.event.inputs.tfvars_file }}.tfstate" \
            -backend-config="resource_group_name=${{ secrets.TERRAFORM_RESOURCE_GROUP }}" \
            -backend-config="subscription_id=${{ secrets.AZURE_SUBSCRIPTION_ID }}" \
            -backend-config="tenant_id=${{ secrets.AZURE_TENANT_ID }}" \
            -backend-config="use_oidc=true"; then
            
            init_success=true
            echo "::notice title=Init Success::‚úÖ Terraform re-init for destroy completed successfully on attempt $retry_count"
          else
            echo "::warning title=Init Failed::‚ö†Ô∏è Terraform init attempt $retry_count failed"
            if [ $retry_count -lt $max_retries ]; then
              wait_time=$((retry_count * 10))
              echo "::notice title=Retry Delay::‚è±Ô∏è Waiting ${wait_time} seconds before retry..."
              sleep $wait_time
            fi
          fi
        done
        
        if [ "$init_success" = false ]; then
          echo "::error title=Init Failed::‚ùå Terraform init failed after $max_retries attempts"
          echo "::notice title=Context::üìã This init occurs before destroy execution after downloading artifacts"
          echo "::notice title=Documentation::üìö Error Reference: https://github.com/${{ github.repository }}/blob/main/docs/references/workflow-error-reference.md#terraform-init-errors"
          exit 1
        fi
        
        # Execute destroy using the pre-approved plan
        echo "::warning title=Applying Destroy Plan::Applying destroy plan - resources will be deleted"
        terraform apply -auto-approve destroy-plan
        
        if [ $? -eq 0 ]; then
          echo "::notice title=Destroy Successful::‚úÖ Terraform destroy completed successfully"
        else
          destroy_exit_code=$?
          echo "::error title=Destroy Failed::‚ùå Terraform destroy operation failed"
          echo "::notice title=Error Context::üìã Destroy failure occurred during resource deletion phase"
          echo "::notice title=Exit Code::üî¢ Terraform destroy exited with code: $destroy_exit_code"
          echo "::notice title=Troubleshooting::üîç Common terraform destroy failure causes:"
          echo "::notice title=Issue 1::üîí Resource protection policies preventing deletion"
          echo "::notice title=Issue 2::üîó Resource dependencies blocking destruction order"  
          echo "::notice title=Issue 3::üåê Network connectivity issues during deletion"
          echo "::notice title=Issue 4::üíæ State file conflicts or corruption"
          echo "::notice title=Issue 5::üèóÔ∏è Power Platform service limits during bulk deletion"
          echo "::notice title=Solution 1::üîç Check Power Platform admin center for resource protection policies"
          echo "::notice title=Solution 2::üîó Review resource dependencies and destroy order"
          echo "::notice title=Solution 3::üîÑ Re-run workflow if transient network issues occurred"
          echo "::notice title=Solution 4::üíæ Verify state file integrity and clear locks"
          echo "::notice title=Solution 5::‚è±Ô∏è Consider destroying resources in smaller batches"
          echo "::notice title=Documentation::üìö Error Reference: https://github.com/${{ github.repository }}/blob/main/docs/references/workflow-error-reference.md#terraform-apply-errors"
          echo "::notice title=Power Platform::üìö Admin Center: https://admin.powerplatform.microsoft.com/"
          exit 1
        fi
        
        cd - > /dev/null
    
    # Step 8: Verify state is clean after destroy
    - name: Verify Clean State
      run: |
        config="${{ needs.terraform-validate.outputs.configuration }}"
        
        cd "configurations/$config"
        
        echo "::notice title=Verifying Clean State::Checking that all resources were destroyed..."
        
        # Check final state
        remaining_resources=$(terraform state list 2>/dev/null || echo "")
        remaining_count=$(echo "$remaining_resources" | grep -v '^$' | wc -l || echo "0")
        
        echo "::group::Post-Destroy State Verification"
        echo "Configuration: $config"
        echo "Remaining resources in state: $remaining_count"
        if [ $remaining_count -gt 0 ]; then
          echo "Remaining resources:"
          echo "$remaining_resources"
        else
          echo "‚úÖ State is clean - no resources remaining"
        fi
        echo "::endgroup::"
        
        if [ $remaining_count -gt 0 ]; then
          echo "::warning title=Incomplete Destroy::‚ö†Ô∏è Warning: $remaining_count resource(s) still remain in state after destroy"
          echo "::notice title=Manual Cleanup Required::Some resources may require manual cleanup or additional destroy operations"
        else
          echo "::notice title=Clean Destroy::‚úÖ All resources successfully destroyed - state is clean"
        fi
        
        cd - > /dev/null
    
    # Step 9: Create post-destroy state snapshot
    - name: Post-Destroy State Snapshot
      run: |
        config="${{ needs.terraform-validate.outputs.configuration }}"
        timestamp=$(date +%Y%m%d-%H%M%S)
        
        cd "configurations/$config"
        mkdir -p backups
        
        # Create post-destroy state snapshot
        post_destroy_snapshot="backups/terraform.tfstate.post-destroy-$timestamp"
        terraform state pull > "$post_destroy_snapshot"
        
        echo "::notice title=Post-Destroy Snapshot::Created post-destroy state snapshot: $post_destroy_snapshot"
        
        # Commit the snapshot
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git add "$post_destroy_snapshot"
        
        if ! git diff --cached --quiet; then
          git commit -m "snapshot: post-destroy state snapshot

          Configuration: $config
          Destroy completed: $timestamp
          Executed by: @${{ github.actor }}
          Remaining resources: $(terraform state list 2>/dev/null | wc -l || echo 0)
          
          This snapshot was created after terraform destroy operation."
          git push origin main
          echo "::notice title=Snapshot Committed::Post-destroy snapshot committed to repository"
        fi
        
        cd - > /dev/null
    
    # Step 10: Generate destroy summary report
    - name: Generate Destroy Summary
      run: |
        config="${{ needs.terraform-validate.outputs.configuration }}"
        tfvars_file="${{ github.event.inputs.tfvars_file }}"
        resource_count="${{ needs.terraform-validate.outputs.resource-count }}"
        backup_created="${{ needs.terraform-validate.outputs.backup-created }}"
        
        echo "::notice title=Destroy Complete::‚úÖ Terraform destroy operation completed"
        
        # Generate execution metadata for destroy phase
        timestamp=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
        terraform_version=$(terraform --version | head -1 | sed 's/Terraform v//')
        
        # Create comprehensive metadata object for destroy phase using jq
        destroy_metadata_json=$(jq -n \
          --arg timestamp "$timestamp" \
          --arg workflow_run "${{ github.run_number }}" \
          --arg workflow_id "${{ github.run_id }}" \
          --arg generated_by "${{ github.actor }}" \
          --arg tf_version "$terraform_version" \
          --arg workflow_version "1.0.0" \
          --arg configuration "$config" \
          --arg tfvars_file "$tfvars_file" \
          --arg repository "${{ github.repository }}" \
          --arg ref "${{ github.ref }}" \
          --arg sha "${{ github.sha }}" \
          --arg event "${{ github.event_name }}" \
          --arg runner_os "${{ runner.os }}" \
          --arg runner_arch "${{ runner.arch }}" \
          --arg phase "destroy" \
          --arg operation "destroy" \
          --arg resources_destroyed "$resource_count" \
          --arg backup_created "$backup_created" \
          --argjson validation_metadata '${{ toJson(needs.terraform-validate.outputs.validation-metadata) }}' \
          '{
            "generated_at": $timestamp,
            "workflow_run": $workflow_run,
            "workflow_id": $workflow_id,
            "generated_by": $generated_by,
            "terraform_version": $tf_version,
            "workflow_version": $workflow_version,
            "configuration": $configuration,
            "tfvars_file": $tfvars_file,
            "repository": $repository,
            "ref": $ref,
            "sha": $sha,
            "event": $event,
            "runner_os": $runner_os,
            "runner_arch": $runner_arch,
            "phase": $phase,
            "operation": $operation,
            "resources_destroyed": $resources_destroyed,
            "backup_created": $backup_created,
            "validation_metadata": $validation_metadata
          }'
        )
        
        # Save metadata to file for artifact
        cd "configurations/$config"
        echo "$destroy_metadata_json" > "destroy-metadata.json"
        
        echo "::notice title=Metadata Generated::üìä Destroy execution metadata created for AVM compliance"
        
        echo "## üö® Terraform Destroy Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Destruction Details" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Parameter | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| Configuration | \`$config\` |" >> $GITHUB_STEP_SUMMARY
        echo "| tfvars File | \`$tfvars_file.tfvars\` |" >> $GITHUB_STEP_SUMMARY
        echo "| Resources Destroyed | $resource_count |" >> $GITHUB_STEP_SUMMARY
        echo "| Executed by | @${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Timestamp | $(date '+%Y-%m-%d %H:%M:%S') |" >> $GITHUB_STEP_SUMMARY
        echo "| State Backup Created | $backup_created |" >> $GITHUB_STEP_SUMMARY
        echo "| Workflow run | [${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Check final state for summary
        cd "configurations/$config"
        remaining_count=$(terraform state list 2>/dev/null | wc -l || echo "0")
        
        if [ $remaining_count -eq 0 ]; then
          echo "### ‚úÖ Destroy Status: SUCCESSFUL" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All resources have been successfully destroyed. The Terraform state is clean." >> $GITHUB_STEP_SUMMARY
        else
          echo "### ‚ö†Ô∏è Destroy Status: INCOMPLETE" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Warning**: $remaining_count resource(s) still remain in state after destroy." >> $GITHUB_STEP_SUMMARY
          echo "Manual cleanup may be required for these resources." >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### üîÑ Recovery Information" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Backup Detail | Information |" >> $GITHUB_STEP_SUMMARY
        echo "|---------------|-------------|" >> $GITHUB_STEP_SUMMARY
        if [ "$backup_created" == "true" ]; then
          echo "| **State Backup** | ‚úÖ Available in \`configurations/$config/backups/\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Recovery Method** | Use \`terraform state push\` to restore from backup |" >> $GITHUB_STEP_SUMMARY
          echo "| **Backup Location** | Azure Storage + Local artifact |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| **State Backup** | ‚ùå Not created (disabled by user) |" >> $GITHUB_STEP_SUMMARY
          echo "| **Recovery Method** | Limited - manual resource recreation required |" >> $GITHUB_STEP_SUMMARY
          echo "| **Risk Level** | High - No automated recovery available |" >> $GITHUB_STEP_SUMMARY
        fi
        echo "| **Post-Destroy Snapshot** | Available in artifacts for 30 days |" >> $GITHUB_STEP_SUMMARY
        echo "| **Recovery Documentation** | See project README for detailed recovery steps |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Add next steps section
        echo "### üìã Next Steps" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ $remaining_count -eq 0 ]; then
          echo "**‚úÖ Destruction Complete - Cleanup Actions:**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. **Verify Cleanup**: Confirm all related resources are removed from Power Platform admin center" >> $GITHUB_STEP_SUMMARY
          echo "2. **Update Dependencies**: Check and update any dependent configurations or documentation" >> $GITHUB_STEP_SUMMARY
          echo "3. **Archive Configuration**: Consider archiving or removing the configuration if no longer needed" >> $GITHUB_STEP_SUMMARY
          echo "4. **Audit Trail**: Document the destruction reason and impact for compliance records" >> $GITHUB_STEP_SUMMARY
        else
          echo "**‚ö†Ô∏è Incomplete Destruction - Action Required:**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. **Investigate Remaining**: Check why $remaining_count resource(s) were not destroyed" >> $GITHUB_STEP_SUMMARY
          echo "2. **Manual Cleanup**: Manually remove remaining resources if needed" >> $GITHUB_STEP_SUMMARY
          echo "3. **State Cleanup**: Run \`terraform state rm\` to clean up orphaned state entries" >> $GITHUB_STEP_SUMMARY
          echo "4. **Re-run Destroy**: Consider re-running destroy after manual cleanup" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### ‚ö†Ô∏è Important Notes" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Irreversible Action**: Resources have been permanently deleted from Power Platform" >> $GITHUB_STEP_SUMMARY
        echo "- **State Management**: Terraform state updated to reflect destroyed resources" >> $GITHUB_STEP_SUMMARY
        echo "- **Network Security**: JIT network access was used for secure backend connectivity" >> $GITHUB_STEP_SUMMARY
        echo "- **Resource Recreation**: Use terraform plan/apply with same configuration to recreate" >> $GITHUB_STEP_SUMMARY
        echo "- **Audit Trail**: This destruction operation is logged in workflow history" >> $GITHUB_STEP_SUMMARY
        echo "- **Configuration Preserved**: Configuration files remain unchanged for future use" >> $GITHUB_STEP_SUMMARY
        if [ "$backup_created" == "true" ]; then
          echo "- **Backup Available**: State backup available for emergency recovery within retention period" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        
        cd - > /dev/null
    
    # Step 11: Upload destroy metadata as artifact
    - name: Upload Destroy Metadata as Artifact
      uses: actions/upload-artifact@v4
      with:
        name: terraform-destroy-metadata-${{ github.event.inputs.configuration }}-${{ github.run_number }}
        path: configurations/*/destroy-metadata.json
        retention-days: 30    # Keep metadata longer for audit trail
        description: 'Terraform destroy execution metadata for ${{ github.event.inputs.configuration }} configuration - contains comprehensive execution tracking information'
    
    # Step 12: Remove Just-In-Time network access
    - name: Remove JIT Network Access
      if: always()
      uses: ./.github/actions/jit-network-access
      with:
        action: 'remove'
        storage-account-name: ${{ secrets.TERRAFORM_STORAGE_ACCOUNT }}
        resource-group-name: ${{ secrets.TERRAFORM_RESOURCE_GROUP }}
