# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# TERRAFORM VALIDATION DETECT-AND-DISPATCH WORKFLOW FOR POWER PLATFORM GOVERNANCE
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# Detects changed Terraform configurations/modules and dispatches per-path validation workflows in parallel.
#
# üéØ WHY THIS EXISTS:
# - Decouples change detection from validation for robust, parallel, and isolated quality checks
# - Automates validation only for changed configurations/modules, reducing CI/CD runtime and resource use
# - Aggregates and summarizes results for governance and auditability
#
# üîí SECURITY DECISIONS:
# - OIDC authentication for all cloud and Power Platform connections
# - All jobs requiring secrets run in the 'production' environment for protection
# - Principle of least privilege applied to all permissions
#
# ‚öôÔ∏è OPERATIONAL CONTEXT:
# - Concurrency group ensures only one detect-and-dispatch run per ref at a time
# - Timeout values sized for comprehensive validation without resource waste
# - Supports both PR and manual dispatch triggers
#
# üìã INTEGRATION REQUIREMENTS:
# - Uses composite action for change detection
# - Dispatches single-path validation workflow for each changed path
# - Aggregates results and calls execution summary workflow
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
name: "Terraform Validation Detect and Dispatch"

concurrency:
  group: terraform-validation-detect-and-dispatch-${{ github.ref }}
  cancel-in-progress: false

on:
  # === AUTOMATED TESTING ON PULL REQUESTS ===
  # Trigger comprehensive testing when changes affect Terraform configurations
  # This ensures all modifications are validated before merge
  pull_request:
    paths:
      - 'configurations/**'     # All Power Platform configuration directories
      - 'modules/**'            # Custom Terraform modules and reusable components

  # === AUTOMATED TESTING ON MAIN BRANCH ===
  # Validate changes after merge to ensure main branch stability
  push:
    branches: [main]
    paths:
      - 'configurations/**'     # Configuration changes requiring validation
      - 'modules/**'            # Module updates affecting dependent configurations

run-name: "üß™ Detect & Validate Terraform Changes by @${{ github.actor }}"

permissions:
  contents: read          # Required: Repository content access for validation
  actions: write          # Required: Dispatch other workflows and access workflow metadata
  security-events: write  # Required: Upload security findings to GitHub Security tab
  id-token: write         # Required: OIDC authentication with Azure AD for integration

jobs:
  # === REUSABLE CHANGE DETECTION ===
  # Leverages standardized change detection workflow for consistency and efficiency
  # Replaces inline change detection logic with proven, centralized implementation
  detect-changes:
    name: üîç Detect Terraform Changes
    uses: ./.github/workflows/reusable-change-detection.yml
    with:
      # === PASS-THROUGH WORKFLOW INPUTS ===
      # Maintains seamless user experience by forwarding all manual dispatch inputs
      # Provides defaults for non-manual triggers (push, pull_request)
      target-path: ''
      force-all: false

      # === TERRAFORM TESTING SPECIFIC CONFIGURATION ===
      # Include both configurations and modules for comprehensive testing coverage
      include-configs: true
      include-modules: true

      # === TERRAFORM-SPECIFIC PATH FILTERING ===
      # Filter for files that affect Terraform testing and validation
      # Includes: .tf files, .tfvars files, and terraform configuration files
      path-filter: '\.(tf|tfvars)$|\.tftest\.hcl$'

    # === VALIDATION DISPATCH ===
  # Runs single-path validation for each changed directory in parallel
  # WHY: Provides isolated, parallel validation for each changed configuration/module, improving speed and reliability while ensuring that only affected paths are validated
  validate-paths:
    name: üö¶ Validate Changed Paths
    needs: detect-changes
    if: needs.detect-changes.outputs.has-changes == 'true'
    runs-on: ubuntu-latest
    steps:
      # Dispatches validation workflows for all changed paths
      # WHY: Dispatches validation workflows for all changed paths, handling newline-separated format from reusable workflow
      - name: Dispatch Validation for All Changed Paths
        uses: actions/github-script@v7
        id: dispatch
        with:
          script: |
            const changedPaths = `${{ needs.detect-changes.outputs.changed-paths }}`;
            const workflow_id = 'terraform-single-path-validation.yml';
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const ref = context.ref.replace('refs/heads/', '');
            const runNumber = process.env.GITHUB_RUN_NUMBER;
            const runId = process.env.GITHUB_RUN_ID;
            const sha = process.env.GITHUB_SHA;
            const repository = process.env.GITHUB_REPOSITORY;
            const eventName = process.env.GITHUB_EVENT_NAME;
            const actor = process.env.GITHUB_ACTOR;
            const timestamp = new Date().toISOString();
            
            if (!changedPaths || changedPaths.trim() === '') {
              core.info('No paths to process');
              core.setOutput('notice', '');
              core.setOutput('dispatched-count', 0);
              core.setOutput('dispatched-paths', '');
              core.setOutput('has-failures', 'false');
              core.setOutput('timestamp', timestamp);
              return;
            }
            
            // Split paths by newline and filter out empty lines
            const paths = changedPaths.split('\n').filter(path => path.trim() !== '');
            
            core.info(`Processing ${paths.length} changed path(s)`);
            
            // Track dispatched configs for summary
            const dispatched = [];
            let failed = false;
            
            for (const path of paths) {
              const trimmedPath = path.trim();
              if (!trimmedPath) continue;
              const configName = trimmedPath.replace(/^configurations\//, '').replace(/^modules\//, '');
              try {
                await github.rest.actions.createWorkflowDispatch({
                  owner,
                  repo,
                  workflow_id,
                  ref,
                  inputs: { target_configuration: configName }
                });
                dispatched.push(`‚Ä¢ ${trimmedPath} (config: ${configName})`);
              } catch (error) {
                core.error(`‚ùå Failed to dispatch validation for ${trimmedPath}: ${error.message}`);
                failed = true;
              }
            }
            
            core.setOutput('dispatched-count', dispatched.length);
            core.setOutput('dispatched-paths', dispatched.join('%0A'));
            core.setOutput('has-failures', failed ? 'true' : 'false');
            core.setOutput('timestamp', timestamp);
            core.setOutput('workflow-id', workflow_id);
            const workflowUrl = `https://github.com/${owner}/${repo}/actions/workflows/${workflow_id}`;
            core.setOutput('workflow-url', workflowUrl);

            core.info(`üéâ Successfully dispatched validation for all ${paths.length} path(s)`);

      # Emit a notice summarizing the dispatch results
      # WHY: Provides a clear summary of what was dispatched, including any failures, for easy tracking and troubleshooting
      - name: Emit Dispatch Summary Notice
        if: always()
        run: |
          if [ "${{ steps.dispatch.outputs.dispatched-count }}" -eq 0 ]; then
            echo "::notice title=Terraform Validation Dispatch Summary::No validations were dispatched."
          else
            echo "::notice title=Terraform Validation Dispatch Summary::‚úÖ Dispatched validation for ${{ steps.dispatch.outputs.dispatched-count }} path(s)%0A%0Aüìã Paths Dispatched:%0A${{ steps.dispatch.outputs.dispatched-paths }}%0A%0Aüîó View ${{ steps.dispatch.outputs.workflow-id }} Workflow Runs: (${{ steps.dispatch.outputs.workflow-url }})${{ steps.dispatch.outputs.has-failures == 'true' && '%0A%0A‚ö†Ô∏è Some dispatches failed. See logs for details.' || '' }}"
          fi

  # === AGGREGATE & SUMMARY ===
  # Aggregates results and generates a summary for governance and audit
  # WHY: Provides a comprehensive report of all validation results, supporting governance, compliance, and troubleshooting
  execution-summary:
    name: üìä Aggregate & Summarize Results
    needs: [detect-changes, validate-paths]
    if: always()
    uses: ./.github/workflows/reusable-execution-summary.yml
    with:
      workflow-name: "terraform-validation-detect-and-dispatch"
      operation-type: "validation"
      configuration: "multi-path"
      job-results: ${{ toJSON(needs) }}
      # No manual workflow inputs; always empty
      workflow-inputs: '{}'
      include-troubleshooting: true
      include-technical-details: true
      summary-level: "detailed"
      artifact-retention-days: 14
