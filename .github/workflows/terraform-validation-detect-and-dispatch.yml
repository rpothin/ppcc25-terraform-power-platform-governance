# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# TERRAFORM VALIDATION DETECT-AND-DISPATCH WORKFLOW FOR POWER PLATFORM GOVERNANCE
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Detects changed Terraform configurations/modules and dispatches per-path validation workflows in parallel.
#
# ğŸ¯ WHY THIS EXISTS:
# - Decouples change detection from validation for robust, parallel, and isolated quality checks
# - Automates validation only for changed configurations/modules, reducing CI/CD runtime and resource use
# - Aggregates and summarizes results for governance and auditability
#
# ğŸ”’ SECURITY DECISIONS:
# - OIDC authentication for all cloud and Power Platform connections
# - All jobs requiring secrets run in the 'production' environment for protection
# - Principle of least privilege applied to all permissions
#
# âš™ï¸ OPERATIONAL CONTEXT:
# - Concurrency group ensures only one detect-and-dispatch run per ref at a time
# - Timeout values sized for comprehensive validation without resource waste
# - Supports both PR and manual dispatch triggers
#
# ğŸ“‹ INTEGRATION REQUIREMENTS:
# - Uses composite action for change detection
# - Dispatches single-path validation workflow for each changed path
# - Aggregates results and calls execution summary workflow
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
name: "Terraform Validation Detect and Dispatch"

concurrency:
  group: terraform-validation-detect-and-dispatch-${{ github.ref }}
  cancel-in-progress: false

on:
  # === AUTOMATED TESTING ON PULL REQUESTS ===
  # Trigger comprehensive testing when changes affect Terraform configurations
  # This ensures all modifications are validated before merge
  pull_request:
    paths:
      - 'configurations/**'     # All Power Platform configuration directories
      - 'modules/**'            # Custom Terraform modules and reusable components

  # === AUTOMATED TESTING ON MAIN BRANCH ===
  # Validate changes after merge to ensure main branch stability
  push:
    branches: [main]
    paths:
      - 'configurations/**'     # Configuration changes requiring validation
      - 'modules/**'            # Module updates affecting dependent configurations

run-name: "ğŸ§ª Detect & Validate Terraform Changes by @${{ github.actor }}"

permissions:
  contents: read          # Required: Repository content access for validation
  actions: read           # Required: Access to workflow metadata and job execution data
  security-events: write  # Required: Upload security findings to GitHub Security tab
  id-token: write         # Required: OIDC authentication with Azure AD for integration

jobs:
  # === REUSABLE CHANGE DETECTION ===
  # Leverages standardized change detection workflow for consistency and efficiency
  # Replaces inline change detection logic with proven, centralized implementation
  detect-changes:
    name: ğŸ” Detect Terraform Changes
    uses: ./.github/workflows/reusable-change-detection.yml
    with:
      # === PASS-THROUGH WORKFLOW INPUTS ===
      # Maintains seamless user experience by forwarding all manual dispatch inputs
      # Provides defaults for non-manual triggers (push, pull_request)
      target-path: ''
      force-all: false

      # === TERRAFORM TESTING SPECIFIC CONFIGURATION ===
      # Include both configurations and modules for comprehensive testing coverage
      include-configs: true
      include-modules: true

      # === TERRAFORM-SPECIFIC PATH FILTERING ===
      # Filter for files that affect Terraform testing and validation
      # Includes: .tf files, .tfvars files, and terraform configuration files
      path-filter: '\.(tf|tfvars)$|\.tftest\.hcl$'

  # === VALIDATION DISPATCH ===
  # Runs single-path validation for each changed directory in parallel
  # WHY: Provides isolated, parallel validation for each changed configuration/module, improving speed and reliability while ensuring that only affected paths are validated
  validate-paths:
    name: ğŸš¦ Validate Changed Paths
    needs: detect-changes
    if: needs.detect-changes.outputs.has-changes == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        target_path: ${{ fromJson(needs.detect-changes.outputs.changed-paths) }}
    steps:
      # Dispatches the single-path validation workflow for each changed path
      # WHY: Dispatches the single-path validation workflow for each changed path, enabling robust, per-path quality checks and audit trails
      - name: Dispatch Single Path Validation
        uses: actions/github-script@v7
        with:
          script: |
            const path = '${{ matrix.target_path }}';
            const configName = path.replace(/^configurations\//, '').replace(/^modules\//, '');
            const workflow_id = 'terraform-single-path-validation.yml';
            const owner = process.env.GITHUB_REPOSITORY.split('/')[0];
            const repo = process.env.GITHUB_REPOSITORY.split('/')[1];
            const dispatch = await github.rest.actions.createWorkflowDispatch({
              owner,
              repo,
              workflow_id,
              ref: process.env.GITHUB_REF_NAME,
              inputs: { target_configuration: configName }
            });
            core.info(`Dispatched validation for: ${path}`);

  # === AGGREGATE & SUMMARY ===
  # Aggregates results and generates a summary for governance and audit
  # WHY: Provides a comprehensive report of all validation results, supporting governance, compliance, and troubleshooting
  execution-summary:
    name: ğŸ“Š Aggregate & Summarize Results
    needs: [detect-changes, validate-paths]
    if: always()
    uses: ./.github/workflows/reusable-execution-summary.yml
    with:
      workflow-name: "terraform-validation-detect-and-dispatch"
      operation-type: "validation"
      configuration: "multi-path"
      job-results: ${{ toJSON(needs) }}
      # No manual workflow inputs; always empty
      workflow-inputs: '{}'
      include-troubleshooting: true
      include-technical-details: true
      summary-level: "detailed"
      artifact-retention-days: 14
