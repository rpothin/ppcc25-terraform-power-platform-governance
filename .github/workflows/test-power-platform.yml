name: Test Power Platform Configurations

on:
  pull_request:
    paths:
      - 'configurations/**'
      - 'modules/**'
      - 'scripts/test-utils/**'
      - '.github/workflows/test-power-platform.yml'
  push:
    branches: [main]
    paths:
      - 'configurations/**'
      - 'modules/**'
      - 'scripts/test-utils/**'
      - '.github/workflows/test-power-platform.yml'
  workflow_dispatch: # Allow manual triggering

env:
  TF_VERSION: '~1.5'
  TF_IN_AUTOMATION: true

jobs:
  # Job 1: Detect Changes - Only process what actually changed
  detect-changes:
    name: Detect Configuration Changes
    runs-on: ubuntu-latest
    outputs:
      configurations: ${{ steps.changes.outputs.configurations }}
      modules: ${{ steps.changes.outputs.modules }}
      test-utils: ${{ steps.changes.outputs.test-utils }}
      any-config-changed: ${{ steps.changes.outputs.configurations == 'true' || steps.changes.outputs.modules == 'true' }}
      changed-paths: ${{ steps.scan-changed.outputs.changed-paths }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history for change detection

      - name: Detect File Changes
        id: changes
        uses: dorny/paths-filter@v2
        with:
          filters: |
            configurations:
              - 'configurations/**/*.tf'
              - 'configurations/**/*.tfvars'
              - 'configurations/**/terraform.tfvars'
              - 'configurations/**/.terraform-docs.yml'
              - 'configurations/**/.terraform-docs.yaml'
              - 'configurations/**/_header.md'
              - 'configurations/**/_footer.md'
            modules:
              - 'modules/**/*.tf'
              - 'modules/**/.terraform-docs.yml'
              - 'modules/**/.terraform-docs.yaml'
              - 'modules/**/_header.md'
              - 'modules/**/_footer.md'
            test-utils:
              - 'scripts/test-utils/**'

      - name: Scan Changed Paths
        id: scan-changed
        if: steps.changes.outputs.configurations == 'true' || steps.changes.outputs.modules == 'true' || github.event_name == 'workflow_dispatch'
        run: |
          echo "::notice title=Scanning Changes::Identifying specific changed paths..."
          
          # Handle manual dispatch scenarios
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "::notice title=Manual Dispatch::Scanning all valid paths for testing..."
            
            # Scan all paths
            paths_to_process=()
            
            # Scan configurations
            if [ -d "configurations" ]; then
              for config_dir in configurations/*/; do
                dir=${config_dir%/}
                if [ -d "$dir" ] && find "$dir" -maxdepth 1 -name "*.tf" -type f | grep -q .; then
                  paths_to_process+=("$dir")
                  echo "::notice title=Configuration Found::$dir"
                fi
              done
            fi
            
            # Scan modules
            if [ -d "modules" ]; then
              for module_dir in modules/*/; do
                dir=${module_dir%/}
                if [ -d "$dir" ] && find "$dir" -maxdepth 1 -name "*.tf" -type f | grep -q .; then
                  paths_to_process+=("$dir")
                  echo "::notice title=Module Found::$dir"
                fi
              done
            fi
            
            if [ ${#paths_to_process[@]} -eq 0 ]; then
              echo "::warning title=No Paths Found::No valid paths found for testing"
              echo "changed-paths=" >> $GITHUB_OUTPUT
            else
              printf -v joined '%s\n' "${paths_to_process[@]}"
              {
                echo "changed-paths<<PATHS_EOF"
                echo "$joined"
                echo "PATHS_EOF"
              } >> $GITHUB_OUTPUT
              echo "::notice title=Manual Dispatch Complete::Will test ${#paths_to_process[@]} path(s)"
            fi
            exit 0
          fi
          
          # Get list of changed files (for pull requests and pushes)
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            changed_files=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)
          elif [ "${{ github.event_name }}" = "push" ]; then
            changed_files=$(git diff --name-only HEAD~1 HEAD)
          else
            # Fallback for other events
            changed_files=$(git diff --name-only HEAD~1 HEAD)
          fi
          
          echo "::group::Changed Files"
          echo "$changed_files"
          echo "::endgroup::"
          
          # Function to check if directory has terraform files
          should_process_path() {
            local dir="$1"
            [ -d "$dir" ] && find "$dir" -maxdepth 1 -name "*.tf" -type f | grep -q .
          }
          
          # Identify unique parent directories that need testing
          paths_to_process=()
          
          # Process each changed file
          while IFS= read -r file; do
            # Skip empty lines
            [ -z "$file" ] && continue
            
            # Extract directory path
            if [[ "$file" =~ ^(configurations|modules)/[^/]+/ ]]; then
              # Extract the configuration/module directory (e.g., configurations/01-dlp-policies/)
              dir=$(echo "$file" | grep -oE '^(configurations|modules)/[^/]+/')
              dir=${dir%/}  # Remove trailing slash
              
              # Check if this path should be processed and isn't already in our list
              if should_process_path "$dir" && [[ ! " ${paths_to_process[@]} " =~ " ${dir} " ]]; then
                paths_to_process+=("$dir")
                echo "::notice title=Path Added::Will test: $dir"
              fi
            fi
          done <<< "$changed_files"
          
          if [ ${#paths_to_process[@]} -eq 0 ]; then
            echo "::notice title=No Paths::No paths require testing"
            echo "changed-paths=" >> $GITHUB_OUTPUT
          else
            # Join array elements with newline for multiline output
            printf -v joined '%s\n' "${paths_to_process[@]}"
            {
              echo "changed-paths<<PATHS_EOF"
              echo "$joined"
              echo "PATHS_EOF"
            } >> $GITHUB_OUTPUT
            echo "::notice title=Paths Identified::Will test ${#paths_to_process[@]} path(s): ${paths_to_process[*]}"
          fi

  # Job 2: Terraform format and validation
  terraform-validate:
    name: Terraform Format Check
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.any-config-changed == 'true'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Format Check
        run: |
          echo "üîç Checking Terraform format..."
          terraform fmt -recursive -check

  # Job 3: Configuration Validation - Validate all changed configurations
  configuration-validation:
    name: Configuration Validation
    runs-on: ubuntu-latest
    needs: [detect-changes, terraform-validate]
    if: needs.detect-changes.outputs.any-config-changed == 'true' && needs.detect-changes.outputs.changed-paths != ''
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Validate Changed Configurations
        run: |
          echo "üîç Validating changed Terraform configurations..."
          
          # Get the changed paths from the detect-changes job
          paths_input="${{ needs.detect-changes.outputs.changed-paths }}"
          
          # Convert to array
          if [ -n "$paths_input" ]; then
            readarray -t paths <<< "$paths_input"
          else
            echo "::notice title=No Paths::No changed paths to validate"
            exit 0
          fi
          
          # Track validation results
          validated_count=0
          failed_count=0
          
          # Process each changed path
          for target_path in "${paths[@]}"; do
            # Skip empty lines
            [ -z "$target_path" ] && continue
            
            echo "::notice title=Validating Path::Processing: $target_path"
            
            # Verify path exists and has Terraform files
            if [ ! -d "$target_path" ]; then
              echo "::error title=Path Not Found::Directory does not exist: $target_path"
              failed_count=$((failed_count + 1))
              continue
            fi
            
            # Check for Terraform files
            if ! find "$target_path" -maxdepth 1 -name "*.tf" -type f | grep -q .; then
              echo "::warning title=No TF Files::No Terraform files found in $target_path, skipping validation"
              continue
            fi
            
            # Change to target directory for validation
            cd "$target_path" || {
              echo "::error title=CD Failed::Cannot change to directory $target_path"
              failed_count=$((failed_count + 1))
              continue
            }
            
            # Initialize without backend for validation
            echo "::notice title=Terraform Init::Initializing $target_path (backend=false)"
            if ! terraform init -backend=false; then
              echo "::error title=Init Failed::terraform init failed for $target_path"
              failed_count=$((failed_count + 1))
              cd - > /dev/null
              continue
            fi
            
            # Validate configuration
            echo "::notice title=Terraform Validate::Validating $target_path"
            if terraform validate; then
              echo "::notice title=Validation Success::‚úÖ $target_path passed validation"
              validated_count=$((validated_count + 1))
            else
              echo "::error title=Validation Failed::‚ùå terraform validate failed for $target_path"
              failed_count=$((failed_count + 1))
            fi
            
            # Return to workspace root
            cd - > /dev/null
          done
          
          # Report results
          echo "::notice title=Validation Complete::üìä Validated: $validated_count, Failed: $failed_count"
          
          if [ $failed_count -gt 0 ]; then
            echo "::error title=Validation Failures::Some configurations failed validation. Check logs above."
            exit 1
          fi
          
          echo "::notice title=All Validations Passed::‚úÖ All changed configurations are valid!"

  # Job 4: Unit Testing - Test individual modules and configurations in isolation
  unit-testing:
    name: Unit Testing
    runs-on: ubuntu-latest
    needs: [detect-changes, configuration-validation]
    if: needs.detect-changes.outputs.any-config-changed == 'true' && needs.detect-changes.outputs.changed-paths != ''
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Run Unit Tests
        run: |
          echo "üß™ Running unit tests for changed configurations..."
          
          # Get the changed paths from the detect-changes job
          paths_input="${{ needs.detect-changes.outputs.changed-paths }}"
          
          # Convert to array
          if [ -n "$paths_input" ]; then
            readarray -t paths <<< "$paths_input"
          else
            echo "::notice title=No Paths::No changed paths to test"
            exit 0
          fi
          
          # Track testing results
          tested_count=0
          skipped_count=0
          failed_count=0
          
          # Process each changed path
          for target_path in "${paths[@]}"; do
            # Skip empty lines
            [ -z "$target_path" ] && continue
            
            echo "::notice title=Unit Testing Path::Processing: $target_path"
            
            # Check if path has unit tests
            if [ -d "$target_path/tests" ] && [ -f "$target_path/tests/run-tests.sh" ]; then
              echo "::notice title=Running Tests::Found test suite in $target_path"
              
              cd "$target_path" || {
                echo "::error title=CD Failed::Cannot change to directory $target_path"
                failed_count=$((failed_count + 1))
                continue
              }
              
              # Make test script executable and run it
              chmod +x tests/run-tests.sh
              if ./tests/run-tests.sh all; then
                echo "::notice title=Tests Passed::‚úÖ Unit tests passed for $target_path"
                tested_count=$((tested_count + 1))
              else
                echo "::error title=Tests Failed::‚ùå Unit tests failed for $target_path"
                failed_count=$((failed_count + 1))
              fi
              
              cd - > /dev/null
            else
              echo "::notice title=No Tests::No unit test suite found for $target_path (tests/run-tests.sh missing)"
              skipped_count=$((skipped_count + 1))
            fi
          done
          
          # Report results
          echo "::notice title=Unit Testing Complete::üìä Tested: $tested_count, Skipped: $skipped_count, Failed: $failed_count"
          
          if [ $failed_count -gt 0 ]; then
            echo "::error title=Unit Test Failures::Some unit tests failed. Check logs above."
            exit 1
          fi
          
          if [ $tested_count -eq 0 ] && [ $skipped_count -gt 0 ]; then
            echo "::notice title=No Tests Available::All paths skipped due to missing test suites"
          else
            echo "::notice title=Unit Tests Passed::‚úÖ All available unit tests passed!"
          fi

  # Job 5: Integration Testing - Test with real Azure/Power Platform resources
  integration-testing:
    name: Integration Testing
    runs-on: ubuntu-latest
    needs: [detect-changes, unit-testing]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push' && needs.detect-changes.outputs.any-config-changed == 'true' && needs.detect-changes.outputs.changed-paths != ''
    
    # Set up OIDC permissions for Azure authentication
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Azure Login (OIDC)
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.ARM_CLIENT_ID }}
          tenant-id: ${{ secrets.ARM_TENANT_ID }}
          subscription-id: ${{ secrets.ARM_SUBSCRIPTION_ID }}

      - name: Run Integration Tests
        env:
          ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
          ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}
          ARM_USE_OIDC: true
          RUN_AUTHENTICATED_TESTS: true
          TF_VAR_tenant_id: ${{ secrets.ARM_TENANT_ID }}
          # Backend configuration
          ARM_STORAGE_ACCOUNT_NAME: ${{ secrets.ARM_STORAGE_ACCOUNT_NAME }}
          ARM_CONTAINER_NAME: ${{ secrets.ARM_CONTAINER_NAME }}
          ARM_KEY: ${{ secrets.ARM_KEY }}
        run: |
          echo "üîê Running integration tests with real Azure/Power Platform resources..."
          
          # Get the changed paths from the detect-changes job
          paths_input="${{ needs.detect-changes.outputs.changed-paths }}"
          
          # Convert to array
          if [ -n "$paths_input" ]; then
            readarray -t paths <<< "$paths_input"
          else
            echo "::notice title=No Paths::No changed paths to test"
            exit 0
          fi
          
          # Track integration testing results
          tested_count=0
          skipped_count=0
          failed_count=0
          
          # Process each changed path
          for target_path in "${paths[@]}"; do
            # Skip empty lines
            [ -z "$target_path" ] && continue
            
            echo "::notice title=Integration Testing Path::Processing: $target_path"
            
            # Check if path has integration tests
            if [ -d "$target_path/tests" ] && [ -f "$target_path/tests/integration-test.sh" ]; then
              echo "::notice title=Running Integration Tests::Found integration test suite in $target_path"
              
              cd "$target_path" || {
                echo "::error title=CD Failed::Cannot change to directory $target_path"
                failed_count=$((failed_count + 1))
                continue
              }
              
              # Make integration test script executable and run it
              chmod +x tests/integration-test.sh
              if ./tests/integration-test.sh; then
                echo "::notice title=Integration Tests Passed::‚úÖ Integration tests passed for $target_path"
                tested_count=$((tested_count + 1))
              else
                echo "::error title=Integration Tests Failed::‚ùå Integration tests failed for $target_path"
                failed_count=$((failed_count + 1))
              fi
              
              cd - > /dev/null
            else
              echo "::notice title=No Integration Tests::No integration test suite found for $target_path (tests/integration-test.sh missing)"
              skipped_count=$((skipped_count + 1))
            fi
          done
          
          # Report results
          echo "::notice title=Integration Testing Complete::üìä Tested: $tested_count, Skipped: $skipped_count, Failed: $failed_count"
          
          if [ $failed_count -gt 0 ]; then
            echo "::error title=Integration Test Failures::Some integration tests failed. Check logs above."
            exit 1
          fi
          
          if [ $tested_count -eq 0 ] && [ $skipped_count -gt 0 ]; then
            echo "::notice title=No Integration Tests Available::All paths skipped due to missing integration test suites"
          else
            echo "::notice title=Integration Tests Passed::‚úÖ All available integration tests passed!"
          fi

  # Job 6: Security Scanning
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: [detect-changes, terraform-validate]
    if: needs.detect-changes.outputs.any-config-changed == 'true'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  # Job 7: Test Results Summary
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [detect-changes, terraform-validate, configuration-validation, unit-testing, integration-testing, security-scan]
    if: always() && needs.detect-changes.outputs.any-config-changed == 'true'
    
    steps:
      - name: Test Results Summary
        run: |
          echo "## üß™ Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.terraform-validate.result }}" == "success" ]; then
            echo "| Terraform Format Check | ‚úÖ PASSED |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Terraform Format Check | ‚ùå FAILED |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.configuration-validation.result }}" == "success" ]; then
            echo "| Configuration Validation | ‚úÖ PASSED |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.configuration-validation.result }}" == "skipped" ]; then
            echo "| Configuration Validation | ‚è≠Ô∏è SKIPPED |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Configuration Validation | ‚ùå FAILED |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.unit-testing.result }}" == "success" ]; then
            echo "| Unit Testing | ‚úÖ PASSED |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.unit-testing.result }}" == "skipped" ]; then
            echo "| Unit Testing | ‚è≠Ô∏è SKIPPED |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Unit Testing | ‚ùå FAILED |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.integration-testing.result }}" == "success" ]; then
            echo "| Integration Testing | ‚úÖ PASSED |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.integration-testing.result }}" == "skipped" ]; then
            echo "| Integration Testing | ‚è≠Ô∏è SKIPPED |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Integration Testing | ‚ùå FAILED |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.security-scan.result }}" == "success" ]; then
            echo "| Security Scan | ‚úÖ PASSED |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Security Scan | ‚ùå FAILED |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow completed at:** $(date)" >> $GITHUB_STEP_SUMMARY
