# Terraform Documentation Generation Workflow for Power Platform Governance
# This workflow automatically generates and maintains up-to-date Terraform documentation
# using terraform-docs for all configurations and modules in the repository
# Follows AVM standards and ensures consistent documentation formatting

name: Generate Terraform Docs

# Allow safe cancellation of documentation generation workflows
concurrency:
  group: terraform-docs-${{ github.ref }}
  cancel-in-progress: true

# Trigger: Pull requests and pushes that modify Terraform files
# Also supports manual dispatch for ad-hoc documentation generation
on:
  pull_request:
    paths:
      - 'modules/**/*.tf'
      - 'modules/**/.terraform-docs.yml'
      - 'modules/**/_header.md'
      - 'modules/**/_footer.md'
      - 'configurations/**/*.tf'
      - 'configurations/**/.terraform-docs.yml'
      - 'configurations/**/_header.md'
      - 'configurations/**/_footer.md'
  push:
    branches: [main]
    paths:
      - 'modules/**/*.tf'
      - 'modules/**/.terraform-docs.yml'
      - 'modules/**/_header.md'
      - 'modules/**/_footer.md'
      - 'configurations/**/*.tf'
      - 'configurations/**/.terraform-docs.yml'
      - 'configurations/**/_header.md'
      - 'configurations/**/_footer.md'
  workflow_dispatch:
    inputs:
      target_path:
        description: 'Specific path to generate docs for (e.g., configurations/01-dlp-policies). Leave empty to process all changed or all paths.'
        required: false
        type: string
      force_all:
        description: 'Force processing all configurations and modules (ignore change detection)'
        required: false
        default: false
        type: boolean

# Dynamic run name that shows what triggered the documentation generation
run-name: üìö Generate Terraform Docs${{ github.event.inputs.target_path && format(' for {0}', github.event.inputs.target_path) || (github.event.inputs.force_all == 'true' && ' for ALL paths' || ' for changed paths') }} by @${{ github.actor }}

# Required permissions for committing documentation updates
permissions:
  contents: write     # Required for repository checkout and committing generated docs
  pull-requests: write # Required for commenting on PRs with documentation status

# No workflow-level environment variables needed - this is a documentation-only workflow

jobs:
  # Job 1: Detect Changes - Only process what actually changed
  detect-changes:
    name: üîç Detect Changes
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      configurations: ${{ steps.detect.outputs.has-changes }}
      modules: ${{ steps.detect.outputs.has-changes }}
      any-docs-changed: ${{ steps.detect.outputs.has-changes }}
      changed-paths: ${{ steps.detect.outputs.changed-paths }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history for change detection

      - name: Detect Changes
        id: detect
        uses: ./.github/actions/detect-terraform-changes
        with:
          target-path: ${{ github.event.inputs.target_path }}
          force-all: ${{ github.event.inputs.force_all }}
          include-configs: 'true'
          include-modules: 'true'

  # Job 2: Generate Documentation - Only for changed paths
  terraform-docs:
    name: üìö Generate terraform-docs
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: detect-changes
    if: needs.detect-changes.outputs.has-changes == 'true'

    steps:
    # Step 1: Checkout repository code
    - name: Checkout Repository for Documentation
      uses: actions/checkout@v4
      with:
        # For pull requests, checkout the head branch to enable commits
        ref: ${{ github.event.pull_request.head.ref || github.ref }}
        # Use a token that can push to protected branches
        token: ${{ secrets.GITHUB_TOKEN }}

    # Step 2: Generate documentation only for changed paths
    - name: Generate Documentation for Changed Configurations
      run: |
        echo "::notice title=Documentation Generation::Starting terraform-docs generation for changed paths only..."
        
        # Track generation results
        generated_count=0
        failed_count=0
        
        # Get the changed paths from the detect-changes job
        paths_input="${{ needs.detect-changes.outputs.changed-paths }}"
        
        # Convert to array
        if [ -n "$paths_input" ]; then
          readarray -t paths <<< "$paths_input"
        else
          echo "::warning title=No Paths::No changed paths to process"
          exit 0
        fi
        
        # Process each changed path
        for target_path in "${paths[@]}"; do
          # Skip empty lines
          [ -z "$target_path" ] && continue
          
          echo "::notice title=Processing Changed Path::Generating documentation for: $target_path"
          
          # Verify path exists and has required files
          if [ ! -d "$target_path" ]; then
            echo "::error title=Path Not Found::Directory does not exist: $target_path"
            failed_count=$((failed_count + 1))
            continue
          fi
          
          # Determine configuration file
          config_file=""
          if [ -f "$target_path/.terraform-docs.yml" ]; then
            config_file=".terraform-docs.yml"
          elif [ -f "$target_path/.terraform-docs.yaml" ]; then
            config_file=".terraform-docs.yaml"
          else
            echo "::warning title=No Config::No terraform-docs configuration found in $target_path, skipping"
            continue
          fi
          
          # Check for Terraform files
          if ! find "$target_path" -maxdepth 1 -name "*.tf" -type f | grep -q .; then
            echo "::warning title=No TF Files::No Terraform files found in $target_path, skipping"
            continue
          fi
          
          # Generate documentation using terraform-docs Docker
          echo "::notice title=Generating Docs::Running terraform-docs for $target_path..."
          
          if docker run --rm \
            --volume "$(pwd):/terraform-docs" \
            --workdir "/terraform-docs/$target_path" \
            quay.io/terraform-docs/terraform-docs:0.20.0 \
            -c "$config_file" .; then
            
            echo "::notice title=Generation Success::‚úÖ Documentation generated successfully for $target_path"
            generated_count=$((generated_count + 1))
          else
            echo "::error title=Generation Failed::‚ùå terraform-docs failed for $target_path"
            failed_count=$((failed_count + 1))
          fi
        done
        
        # Report results
        echo "::notice title=Generation Complete::üìä Generated: $generated_count, Failed: $failed_count"
        
        if [ $failed_count -gt 0 ]; then
          echo "::error title=Generation Failures::Some documentation generation failed. Check logs above."
          exit 1
        fi
        
        # Store results for summary
        echo "generated_count=$generated_count" >> $GITHUB_OUTPUT
        echo "failed_count=$failed_count" >> $GITHUB_OUTPUT

    # Step 4: Check for documentation changes and commit if necessary
    - name: Check for Documentation Changes
      id: changes
      run: |
        echo "::notice title=Change Detection::Checking for documentation changes..."
        
        # Configure git for the action
        git config user.name "github-actions[bot]"
        git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
        
        # Check if there are any changes
        if git diff --quiet; then
          echo "::notice title=No Changes::No documentation changes detected"
          echo "has_changes=false" >> $GITHUB_OUTPUT
        else
          echo "::notice title=Changes Detected::Documentation changes found"
          echo "has_changes=true" >> $GITHUB_OUTPUT
          
          # Show what files changed
          echo "::group::Changed Files"
          git diff --name-only
          echo "::endgroup::"
        fi

    # Step 5: Commit documentation changes
    - name: Commit Documentation Updates
      if: steps.changes.outputs.has_changes == 'true'
      run: |
        echo "::notice title=Committing Changes::Committing updated documentation..."
        
        # Add all changes
        git add -A
        
        # Create detailed commit message
        changed_paths="${{ needs.detect-changes.outputs.changed-paths }}"
        readarray -t paths <<< "$changed_paths"
        
        commit_message="docs: update terraform documentation
        
        Auto-generated by terraform-docs GitHub Action
        
        Updated documentation for changed paths:
        $(printf '%s\n' "${paths[@]}" | sed 's/^/- /')
        
        Files updated:
        $(git diff --cached --name-only | sed 's/^/- /')
        
        Workflow: ${{ github.workflow }}
        Run: ${{ github.run_number }}
        Triggered by: ${{ github.actor }}
        Event: ${{ github.event_name }}"
        
        # Commit changes
        git commit -m "$commit_message"
        
        # Push changes back to the branch
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          # For pull requests, push to the head branch
          git push origin "${{ github.event.pull_request.head.ref }}"
          echo "::notice title=Pushed to PR::‚úÖ Documentation committed to pull request branch"
        else
          # For push events, push to the current branch
          git push origin "${{ github.ref_name }}"
          echo "::notice title=Pushed to Branch::‚úÖ Documentation committed to branch ${{ github.ref_name }}"
        fi

    # Step 6: Add PR comment with documentation status (for pull requests only)
    - name: Comment on Pull Request
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const hasChanges = '${{ steps.changes.outputs.has_changes }}' === 'true';
          const changedPaths = `${{ needs.detect-changes.outputs.changed-paths }}`.split('\n').filter(p => p.trim());
          
          let commentBody;
          if (hasChanges) {
            const pathsList = changedPaths.map(path => `- \`${path}\``).join('\n');
            commentBody = `## üìö Terraform Documentation Updated
            
            The terraform-docs workflow has automatically updated documentation for the following changed paths:
            
            ### Updated Paths
            ${pathsList}
            
            ### Changes Made
            - Documentation regenerated using terraform-docs v0.20.0
            - README files updated with latest Terraform configuration details
            - Changes committed automatically to this PR branch
            
            ### Next Steps
            Please review the documentation changes in the **Files changed** tab to ensure they look correct.
            
            ---
            *This comment was generated automatically by the terraform-docs workflow.*`;
          } else {
            commentBody = `## üìö Terraform Documentation Status
            
            The terraform-docs workflow has completed successfully with no changes needed.
            
            ### Status
            ‚úÖ All documentation is up-to-date for changed paths
            
            ### Processed Paths
            ${changedPaths.map(path => `- \`${path}\``).join('\n')}
            
            ---
            *This comment was generated automatically by the terraform-docs workflow.*`;
          }
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: commentBody
          });

    # Step 7: Generate workflow summary
    - name: Generate Workflow Summary
      if: always()
      run: |
        # Generate comprehensive workflow summary
        echo "## üìö Terraform Documentation Generation Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Execution Details" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Parameter | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| Trigger | ${{ github.event_name }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Optimization | **Changed paths only** ‚ö° |" >> $GITHUB_STEP_SUMMARY
        echo "| Processed Paths | ${{ needs.detect-changes.outputs.changed-paths != '' && '‚úÖ Detected changes' || 'üîç No changes detected' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Timestamp | $(date +%Y-%m-%d\ %H:%M:%S) |" >> $GITHUB_STEP_SUMMARY
        echo "| Executed by | @${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Workflow run | [${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Efficiency report
        changed_paths="${{ needs.detect-changes.outputs.changed-paths }}"
        if [ -n "$changed_paths" ]; then
          readarray -t paths <<< "$changed_paths"
          path_count=${#paths[@]}
          
          echo "### ‚ö° Efficiency Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Paths Processed** | $path_count (changed only) |" >> $GITHUB_STEP_SUMMARY
          echo "| **Optimization** | ‚úÖ Smart change detection enabled |" >> $GITHUB_STEP_SUMMARY
          echo "| **Time Saved** | ~$(( (10 - $path_count) * 30 )) seconds (estimated) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### üìÅ Changed Paths Processed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          for path in "${paths[@]}"; do
            [ -n "$path" ] && echo "- \`$path\`" >> $GITHUB_STEP_SUMMARY
          done
        else
          echo "### ‚ö° Efficiency Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Paths Processed** | 0 (no relevant changes detected) |" >> $GITHUB_STEP_SUMMARY
          echo "| **Optimization** | ‚úÖ Workflow skipped unnecessary processing |" >> $GITHUB_STEP_SUMMARY
          echo "| **Time Saved** | ~5 minutes (full scan avoided) |" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Status section
        has_changes="${{ steps.changes.outputs.has_changes }}"
        if [ "$has_changes" = "true" ]; then
          echo "### ‚úÖ Documentation Updated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Detail | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Status** | Documentation Changes Committed |" >> $GITHUB_STEP_SUMMARY
          echo "| **Action Taken** | README files updated and committed |" >> $GITHUB_STEP_SUMMARY
          echo "| **terraform-docs Version** | 0.20.0 |" >> $GITHUB_STEP_SUMMARY
        else
          echo "### üÜó Documentation Current" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Detail | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Status** | No Changes Needed |" >> $GITHUB_STEP_SUMMARY
          echo "| **Current State** | All documentation is up-to-date |" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Next steps
        echo "### üìã Next Steps" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ "$has_changes" = "true" ]; then
          echo "1. **Review Changes**: Check the committed documentation updates" >> $GITHUB_STEP_SUMMARY
          echo "2. **Verify Content**: Ensure generated content is accurate and complete" >> $GITHUB_STEP_SUMMARY
          echo "3. **Continue Development**: Documentation is now current for your changes" >> $GITHUB_STEP_SUMMARY
        else
          echo "1. **No Action Required**: Documentation is current and consistent" >> $GITHUB_STEP_SUMMARY
          echo "2. **Continue Development**: All documentation requirements are met" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Important notes
        echo "### üìå Important Notes" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **‚ö° Smart Processing**: Only processes changed configurations/modules" >> $GITHUB_STEP_SUMMARY
        echo "- **üöÄ Performance**: Significantly faster than full repository scan" >> $GITHUB_STEP_SUMMARY
        echo "- **üéØ Precision**: Targets exactly what needs updating" >> $GITHUB_STEP_SUMMARY
        echo "- **‚ôªÔ∏è Resource Efficient**: Saves CI/CD minutes and reduces carbon footprint" >> $GITHUB_STEP_SUMMARY
        echo "- **AVM Compliance**: Documentation follows Azure Verified Module standards" >> $GITHUB_STEP_SUMMARY
        echo "- **Configuration**: Each path uses its own .terraform-docs.yml configuration" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
