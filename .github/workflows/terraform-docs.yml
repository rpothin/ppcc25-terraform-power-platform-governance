# Terraform Documentation Generation Workflow for Power Platform Governance
# This workflow automatically generates and maintains up-to-date Terraform documentation
# using terraform-docs for all configurations and modules in the repository
# Follows AVM standards and ensures consistent documentation formatting

name: Generate Terraform Docs

# Trigger: Pull requests and pushes that modify Terraform files
# Also supports manual dispatch for ad-hoc documentation generation
on:
  pull_request:
    paths:
      - 'modules/**/*.tf'
      - 'modules/**/.terraform-docs.yml'
      - 'modules/**/_header.md'
      - 'modules/**/_footer.md'
      - 'configurations/**/*.tf'
      - 'configurations/**/.terraform-docs.yml'
      - 'configurations/**/_header.md'
      - 'configurations/**/_footer.md'
  push:
    branches: [main]
    paths:
      - 'modules/**/*.tf'
      - 'modules/**/.terraform-docs.yml'
      - 'modules/**/_header.md'
      - 'modules/**/_footer.md'
      - 'configurations/**/*.tf'
      - 'configurations/**/.terraform-docs.yml'
      - 'configurations/**/_header.md'
      - 'configurations/**/_footer.md'
  workflow_dispatch:
    inputs:
      target_path:
        description: 'Specific path to generate docs for (e.g., configurations/01-dlp-policies). Leave empty to process all changed or all paths.'
        required: false
        type: string
      force_all:
        description: 'Force processing all configurations and modules (ignore change detection)'
        required: false
        default: false
        type: boolean

# Dynamic run name that shows what triggered the documentation generation
run-name: ðŸ“š Generate Terraform Docs${{ github.event.inputs.target_path && format(' for {0}', github.event.inputs.target_path) || (github.event.inputs.force_all == 'true' && ' for ALL paths' || ' for changed paths') }} by @${{ github.actor }}

# Required permissions for committing documentation updates
permissions:
  contents: write     # Required for repository checkout and committing generated docs
  pull-requests: write # Required for commenting on PRs with documentation status

# No workflow-level environment variables needed - this is a documentation-only workflow

jobs:
  # Job 1: Detect Changes - Only process what actually changed
  detect-changes:
    name: ðŸ” Detect Documentation Changes
    runs-on: ubuntu-latest
    outputs:
      configurations: ${{ steps.changes.outputs.configurations }}
      modules: ${{ steps.changes.outputs.modules }}
      any-docs-changed: ${{ steps.changes.outputs.configurations == 'true' || steps.changes.outputs.modules == 'true' }}
      changed-paths: ${{ steps.scan-changed.outputs.changed-paths }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history for change detection

      - name: Detect File Changes
        id: changes
        uses: dorny/paths-filter@v2
        with:
          filters: |
            configurations:
              - 'configurations/**/*.tf'
              - 'configurations/**/.terraform-docs.yml'
              - 'configurations/**/.terraform-docs.yaml'
              - 'configurations/**/_header.md'
              - 'configurations/**/_footer.md'
            modules:
              - 'modules/**/*.tf'
              - 'modules/**/.terraform-docs.yml'
              - 'modules/**/.terraform-docs.yaml'
              - 'modules/**/_header.md'
              - 'modules/**/_footer.md'

      - name: Scan Changed Paths
        id: scan-changed
        if: steps.changes.outputs.configurations == 'true' || steps.changes.outputs.modules == 'true' || github.event_name == 'workflow_dispatch'
        run: |
          echo "::notice title=Scanning Changes::Identifying specific changed paths..."
          
          # Handle manual dispatch scenarios
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # Check for specific target path
            if [ -n "${{ github.event.inputs.target_path }}" ]; then
              target_path="${{ github.event.inputs.target_path }}"
              echo "::notice title=Manual Target::Processing specific path: $target_path"
              
              if [ ! -d "$target_path" ]; then
                echo "::error title=Target Path Not Found::Specified path '$target_path' does not exist"
                exit 1
              fi
              
              # Validate target path has required files
              if ([ -f "$target_path/.terraform-docs.yml" ] || [ -f "$target_path/.terraform-docs.yaml" ]) && \
                 find "$target_path" -maxdepth 1 -name "*.tf" -type f | grep -q .; then
                echo "changed-paths=$target_path" >> $GITHUB_OUTPUT
                echo "::notice title=Manual Target Set::Documentation will be generated for: $target_path"
                exit 0
              else
                echo "::error title=Invalid Target::Path '$target_path' missing .terraform-docs.yml or .tf files"
                exit 1
              fi
            fi
            
            # Check for force all flag
            if [ "${{ github.event.inputs.force_all }}" = "true" ]; then
              echo "::notice title=Force All::Processing all configurations and modules"
              
              # Scan all paths
              paths_to_process=()
              
              # Scan configurations
              if [ -d "configurations" ]; then
                for config_dir in configurations/*/; do
                  dir=${config_dir%/}
                  if [ -d "$dir" ] && \
                     ([ -f "$dir/.terraform-docs.yml" ] || [ -f "$dir/.terraform-docs.yaml" ]) && \
                     find "$dir" -maxdepth 1 -name "*.tf" -type f | grep -q .; then
                    paths_to_process+=("$dir")
                    echo "::notice title=Configuration Found::$dir"
                  fi
                done
              fi
              
              # Scan modules
              if [ -d "modules" ]; then
                for module_dir in modules/*/; do
                  dir=${module_dir%/}
                  if [ -d "$dir" ] && \
                     ([ -f "$dir/.terraform-docs.yml" ] || [ -f "$dir/.terraform-docs.yaml" ]) && \
                     find "$dir" -maxdepth 1 -name "*.tf" -type f | grep -q .; then
                    paths_to_process+=("$dir")
                    echo "::notice title=Module Found::$dir"
                  fi
                done
              fi
              
              if [ ${#paths_to_process[@]} -eq 0 ]; then
                echo "::warning title=No Paths Found::No valid paths found for documentation generation"
                echo "changed-paths=" >> $GITHUB_OUTPUT
              else
                printf -v joined '%s\n' "${paths_to_process[@]}"
                {
                  echo "changed-paths<<PATHS_EOF"
                  echo "$joined"
                  echo "PATHS_EOF"
                } >> $GITHUB_OUTPUT
                echo "::notice title=Force All Complete::Will process ${#paths_to_process[@]} path(s)"
              fi
              exit 0
            fi
            
            # If no specific inputs for manual dispatch, fall through to change detection
            echo "::notice title=Manual Dispatch::No specific inputs, detecting changes..."
          fi
          
          # Get list of changed files (for pull requests and pushes)
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            changed_files=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)
          elif [ "${{ github.event_name }}" = "push" ]; then
            changed_files=$(git diff --name-only HEAD~1 HEAD)
          else
            # For workflow_dispatch without specific inputs, check recent changes
            changed_files=$(git diff --name-only HEAD~1 HEAD)
          fi
          
          echo "::group::Changed Files"
          echo "$changed_files"
          echo "::endgroup::"
          
          # Function to check if directory has terraform-docs config and tf files
          should_process_path() {
            local dir="$1"
            [ -d "$dir" ] && \
            ([ -f "$dir/.terraform-docs.yml" ] || [ -f "$dir/.terraform-docs.yaml" ]) && \
            find "$dir" -maxdepth 1 -name "*.tf" -type f | grep -q .
          }
          
          # Identify unique parent directories that need documentation updates
          paths_to_process=()
          
          # Process each changed file
          while IFS= read -r file; do
            # Skip empty lines
            [ -z "$file" ] && continue
            
            # Extract directory path
            if [[ "$file" =~ ^(configurations|modules)/[^/]+/ ]]; then
              # Extract the configuration/module directory (e.g., configurations/01-dlp-policies/)
              dir=$(echo "$file" | grep -oE '^(configurations|modules)/[^/]+/')
              dir=${dir%/}  # Remove trailing slash
              
              # Check if this path should be processed and isn't already in our list
              if should_process_path "$dir" && [[ ! " ${paths_to_process[@]} " =~ " ${dir} " ]]; then
                paths_to_process+=("$dir")
                echo "::notice title=Path Added::Will process documentation for: $dir"
              fi
            fi
          done <<< "$changed_files"
          
          if [ ${#paths_to_process[@]} -eq 0 ]; then
            echo "::notice title=No Paths::No paths require documentation updates"
            echo "changed-paths=" >> $GITHUB_OUTPUT
          else
            # Join array elements with newline for multiline output
            printf -v joined '%s\n' "${paths_to_process[@]}"
            {
              echo "changed-paths<<PATHS_EOF"
              echo "$joined"
              echo "PATHS_EOF"
            } >> $GITHUB_OUTPUT
            echo "::notice title=Paths Identified::Will process ${#paths_to_process[@]} path(s): ${paths_to_process[*]}"
          fi

  # Job 2: Generate Documentation - Only for changed paths
  terraform-docs:
    name: ðŸ“š Generate terraform-docs
    runs-on: ubuntu-latest
    needs: detect-changes
    if: (needs.detect-changes.outputs.any-docs-changed == 'true' && needs.detect-changes.outputs.changed-paths != '') || (github.event_name == 'workflow_dispatch' && needs.detect-changes.outputs.changed-paths != '')

    steps:
    # Step 1: Checkout repository code
    - name: Checkout Repository for Documentation
      uses: actions/checkout@v4
      with:
        # For pull requests, checkout the head branch to enable commits
        ref: ${{ github.event.pull_request.head.ref || github.ref }}
        # Use a token that can push to protected branches
        token: ${{ secrets.GITHUB_TOKEN }}

    # Step 2: Generate documentation only for changed paths
    - name: Generate Documentation for Changed Configurations
      run: |
        echo "::notice title=Documentation Generation::Starting terraform-docs generation for changed paths only..."
        
        # Track generation results
        generated_count=0
        failed_count=0
        
        # Get the changed paths from the detect-changes job
        paths_input="${{ needs.detect-changes.outputs.changed-paths }}"
        
        # Convert to array
        if [ -n "$paths_input" ]; then
          readarray -t paths <<< "$paths_input"
        else
          echo "::warning title=No Paths::No changed paths to process"
          exit 0
        fi
        
        # Process each changed path
        for target_path in "${paths[@]}"; do
          # Skip empty lines
          [ -z "$target_path" ] && continue
          
          echo "::notice title=Processing Changed Path::Generating documentation for: $target_path"
          
          # Verify path exists and has required files
          if [ ! -d "$target_path" ]; then
            echo "::error title=Path Not Found::Directory does not exist: $target_path"
            failed_count=$((failed_count + 1))
            continue
          fi
          
          # Determine configuration file
          config_file=""
          if [ -f "$target_path/.terraform-docs.yml" ]; then
            config_file=".terraform-docs.yml"
          elif [ -f "$target_path/.terraform-docs.yaml" ]; then
            config_file=".terraform-docs.yaml"
          else
            echo "::warning title=No Config::No terraform-docs configuration found in $target_path, skipping"
            continue
          fi
          
          # Check for Terraform files
          if ! find "$target_path" -maxdepth 1 -name "*.tf" -type f | grep -q .; then
            echo "::warning title=No TF Files::No Terraform files found in $target_path, skipping"
            continue
          fi
          
          # Generate documentation using terraform-docs Docker
          echo "::notice title=Generating Docs::Running terraform-docs for $target_path..."
          
          if docker run --rm \
            --volume "$(pwd):/terraform-docs" \
            --workdir "/terraform-docs/$target_path" \
            quay.io/terraform-docs/terraform-docs:0.20.0 \
            -c "$config_file" .; then
            
            echo "::notice title=Generation Success::âœ… Documentation generated successfully for $target_path"
            generated_count=$((generated_count + 1))
          else
            echo "::error title=Generation Failed::âŒ terraform-docs failed for $target_path"
            failed_count=$((failed_count + 1))
          fi
        done
        
        # Report results
        echo "::notice title=Generation Complete::ðŸ“Š Generated: $generated_count, Failed: $failed_count"
        
        if [ $failed_count -gt 0 ]; then
          echo "::error title=Generation Failures::Some documentation generation failed. Check logs above."
          exit 1
        fi
        
        # Store results for summary
        echo "generated_count=$generated_count" >> $GITHUB_OUTPUT
        echo "failed_count=$failed_count" >> $GITHUB_OUTPUT

    # Step 4: Check for documentation changes and commit if necessary
    - name: Check for Documentation Changes
      id: changes
      run: |
        echo "::notice title=Change Detection::Checking for documentation changes..."
        
        # Configure git for the action
        git config user.name "github-actions[bot]"
        git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
        
        # Check if there are any changes
        if git diff --quiet; then
          echo "::notice title=No Changes::No documentation changes detected"
          echo "has_changes=false" >> $GITHUB_OUTPUT
        else
          echo "::notice title=Changes Detected::Documentation changes found"
          echo "has_changes=true" >> $GITHUB_OUTPUT
          
          # Show what files changed
          echo "::group::Changed Files"
          git diff --name-only
          echo "::endgroup::"
        fi

    # Step 5: Commit documentation changes
    - name: Commit Documentation Updates
      if: steps.changes.outputs.has_changes == 'true'
      run: |
        echo "::notice title=Committing Changes::Committing updated documentation..."
        
        # Add all changes
        git add -A
        
        # Create detailed commit message
        changed_paths="${{ needs.detect-changes.outputs.changed-paths }}"
        readarray -t paths <<< "$changed_paths"
        
        commit_message="docs: update terraform documentation
        
        Auto-generated by terraform-docs GitHub Action
        
        Updated documentation for changed paths:
        $(printf '%s\n' "${paths[@]}" | sed 's/^/- /')
        
        Files updated:
        $(git diff --cached --name-only | sed 's/^/- /')
        
        Workflow: ${{ github.workflow }}
        Run: ${{ github.run_number }}
        Triggered by: ${{ github.actor }}
        Event: ${{ github.event_name }}"
        
        # Commit changes
        git commit -m "$commit_message"
        
        # Push changes back to the branch
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          # For pull requests, push to the head branch
          git push origin "${{ github.event.pull_request.head.ref }}"
          echo "::notice title=Pushed to PR::âœ… Documentation committed to pull request branch"
        else
          # For push events, push to the current branch
          git push origin "${{ github.ref_name }}"
          echo "::notice title=Pushed to Branch::âœ… Documentation committed to branch ${{ github.ref_name }}"
        fi

    # Step 6: Add PR comment with documentation status (for pull requests only)
    - name: Comment on Pull Request
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const hasChanges = '${{ steps.changes.outputs.has_changes }}' === 'true';
          const changedPaths = `${{ needs.detect-changes.outputs.changed-paths }}`.split('\n').filter(p => p.trim());
          
          let commentBody;
          if (hasChanges) {
            const pathsList = changedPaths.map(path => `- \`${path}\``).join('\n');
            commentBody = `## ðŸ“š Terraform Documentation Updated
            
            The terraform-docs workflow has automatically updated documentation for the following changed paths:
            
            ### Updated Paths
            ${pathsList}
            
            ### Changes Made
            - Documentation regenerated using terraform-docs v0.20.0
            - README files updated with latest Terraform configuration details
            - Changes committed automatically to this PR branch
            
            ### Next Steps
            Please review the documentation changes in the **Files changed** tab to ensure they look correct.
            
            ---
            *This comment was generated automatically by the terraform-docs workflow.*`;
          } else {
            commentBody = `## ðŸ“š Terraform Documentation Status
            
            The terraform-docs workflow has completed successfully with no changes needed.
            
            ### Status
            âœ… All documentation is up-to-date for changed paths
            
            ### Processed Paths
            ${changedPaths.map(path => `- \`${path}\``).join('\n')}
            
            ---
            *This comment was generated automatically by the terraform-docs workflow.*`;
          }
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: commentBody
          });

    # Step 7: Generate workflow summary
    - name: Generate Workflow Summary
      if: always()
      run: |
        # Generate comprehensive workflow summary
        echo "## ðŸ“š Terraform Documentation Generation Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Execution Details" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Parameter | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| Trigger | ${{ github.event_name }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Optimization | **Changed paths only** âš¡ |" >> $GITHUB_STEP_SUMMARY
        echo "| Processed Paths | ${{ needs.detect-changes.outputs.changed-paths != '' && 'âœ… Detected changes' || 'ðŸ” No changes detected' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Timestamp | $(date +%Y-%m-%d\ %H:%M:%S) |" >> $GITHUB_STEP_SUMMARY
        echo "| Executed by | @${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Workflow run | [${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Efficiency report
        changed_paths="${{ needs.detect-changes.outputs.changed-paths }}"
        if [ -n "$changed_paths" ]; then
          readarray -t paths <<< "$changed_paths"
          path_count=${#paths[@]}
          
          echo "### âš¡ Efficiency Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Paths Processed** | $path_count (changed only) |" >> $GITHUB_STEP_SUMMARY
          echo "| **Optimization** | âœ… Smart change detection enabled |" >> $GITHUB_STEP_SUMMARY
          echo "| **Time Saved** | ~$(( (10 - $path_count) * 30 )) seconds (estimated) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸ“ Changed Paths Processed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          for path in "${paths[@]}"; do
            [ -n "$path" ] && echo "- \`$path\`" >> $GITHUB_STEP_SUMMARY
          done
        else
          echo "### âš¡ Efficiency Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Paths Processed** | 0 (no relevant changes detected) |" >> $GITHUB_STEP_SUMMARY
          echo "| **Optimization** | âœ… Workflow skipped unnecessary processing |" >> $GITHUB_STEP_SUMMARY
          echo "| **Time Saved** | ~5 minutes (full scan avoided) |" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Status section
        has_changes="${{ steps.changes.outputs.has_changes }}"
        if [ "$has_changes" = "true" ]; then
          echo "### âœ… Documentation Updated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Detail | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Status** | Documentation Changes Committed |" >> $GITHUB_STEP_SUMMARY
          echo "| **Action Taken** | README files updated and committed |" >> $GITHUB_STEP_SUMMARY
          echo "| **terraform-docs Version** | 0.20.0 |" >> $GITHUB_STEP_SUMMARY
        else
          echo "### ðŸ†— Documentation Current" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Detail | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Status** | No Changes Needed |" >> $GITHUB_STEP_SUMMARY
          echo "| **Current State** | All documentation is up-to-date |" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Next steps
        echo "### ðŸ“‹ Next Steps" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ "$has_changes" = "true" ]; then
          echo "1. **Review Changes**: Check the committed documentation updates" >> $GITHUB_STEP_SUMMARY
          echo "2. **Verify Content**: Ensure generated content is accurate and complete" >> $GITHUB_STEP_SUMMARY
          echo "3. **Continue Development**: Documentation is now current for your changes" >> $GITHUB_STEP_SUMMARY
        else
          echo "1. **No Action Required**: Documentation is current and consistent" >> $GITHUB_STEP_SUMMARY
          echo "2. **Continue Development**: All documentation requirements are met" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Important notes
        echo "### ðŸ“Œ Important Notes" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **âš¡ Smart Processing**: Only processes changed configurations/modules" >> $GITHUB_STEP_SUMMARY
        echo "- **ðŸš€ Performance**: Significantly faster than full repository scan" >> $GITHUB_STEP_SUMMARY
        echo "- **ðŸŽ¯ Precision**: Targets exactly what needs updating" >> $GITHUB_STEP_SUMMARY
        echo "- **â™»ï¸ Resource Efficient**: Saves CI/CD minutes and reduces carbon footprint" >> $GITHUB_STEP_SUMMARY
        echo "- **AVM Compliance**: Documentation follows Azure Verified Module standards" >> $GITHUB_STEP_SUMMARY
        echo "- **Configuration**: Each path uses its own .terraform-docs.yml configuration" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
