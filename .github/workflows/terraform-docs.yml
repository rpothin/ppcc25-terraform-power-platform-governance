---
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# TERRAFORM DOCUMENTATION WORKFLOW FOR POWER PLATFORM GOVERNANCE
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# Automatically generates and maintains up-to-date Terraform documentation using terraform-docs
# for all configurations and modules, ensuring governance compliance and developer productivity.
#
# üéØ WHY THIS EXISTS:
# - Documentation governance requirement for Infrastructure as Code transparency
# - Eliminates manual documentation updates that become stale and inaccurate
# - Ensures consistent documentation format across all Terraform configurations
# - Supports audit trails and compliance through automated documentation generation
#
# üîí SECURITY DECISIONS:
# - Uses GITHUB_TOKEN for repository access with minimal required permissions
# - No external secrets required - documentation generation is read-only operation
# - Smart change detection prevents unnecessary processing of unmodified paths
#
# ‚öôÔ∏è OPERATIONAL CONTEXT:
# - Cancellation allowed because documentation generation is idempotent
# - Processes only changed paths for efficiency and reduced resource usage
# - Commits documentation updates automatically to maintain consistency
#
# üìã INTEGRATION REQUIREMENTS:
# - Depends on .terraform-docs.yml configuration in each Terraform directory
# - Uses terraform-docs v0.20.0 for consistent formatting standards
# - Follows Azure Verified Module (AVM) documentation patterns
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

name: Terraform Docs

# === CONCURRENCY PROTECTION ===
# Allow safe cancellation because documentation generation is idempotent
# No risk of state corruption since this only updates documentation files
concurrency:
  group: terraform-docs-${{ github.ref }}
  cancel-in-progress: true

# === TRIGGER CONFIGURATION ===
# Simplified trigger pattern leverages reusable workflow's intelligent filtering
# Manual dispatch supports ad-hoc generation for specific paths
on:
  pull_request:
    types: [opened, synchronize, ready_for_review]  # Skip draft PRs for optimization
    paths:
      # Include Terraform files and documentation configs
      - 'configurations/**/*.tf'
      - 'configurations/**/*.tfvars'
      - 'configurations/**/.terraform-docs.yml'
      - 'configurations/**/.terraform-docs.yaml'
      - 'configurations/**/*_header.md'
      - 'configurations/**/*_footer.md'
      # Exclude documentation files to prevent recursive runs
      - '!**/README.md'
      - '!docs/**'
      - '!plans/**'
  push:
    branches: [main]
    paths:
      # Include Terraform files and documentation configs
      - 'configurations/**/*.tf'
      - 'configurations/**/*.tfvars'
      - 'configurations/**/.terraform-docs.yml'
      - 'configurations/**/.terraform-docs.yaml'
      - 'configurations/**/*_header.md'
      - 'configurations/**/*_footer.md'
      # Exclude documentation files to prevent recursive runs
      - '!**/README.md'
      - '!docs/**'
      - '!plans/**'
  workflow_dispatch:
    inputs:
      target_path:
        description: >-
          Specific path to generate docs for (e.g., configurations/utl-export-dlp-policies).
          Leave empty to process all changed or all paths.
        required: false
        type: string
        # WHY: Allows targeted documentation generation for specific configurations
        # GOVERNANCE: Enables focused updates without processing entire repository
        # EFFICIENCY: Reduces processing time for large repositories with many configurations
        # VALIDATION: Must exist in configurations/ or modules/ directory structure
        # EXAMPLES: 'configurations/utl-export-dlp-policies', 'modules/power-platform-dlp'

      force_all:
        description: >-
          Force processing all configurations and modules (ignore change detection)
        required: false
        default: false
        type: boolean
        # WHY: Override for scenarios where change detection may miss important updates
        # USE CASE: Repository restructuring, configuration file changes, or manual refresh
        # SAFETY: Default false prevents accidental full repository processing
        # GOVERNANCE: Provides escape hatch for comprehensive documentation refresh

# === DYNAMIC RUN NAMING ===
# Provides clear identification of what documentation generation covers
run-name: >-
  üìö Generate Terraform Docs${{
    github.event.inputs.target_path && format(' for {0}', github.event.inputs.target_path) ||
    (github.event.inputs.force_all == 'true' && ' for ALL paths' || ' for changed paths')
  }} by @${{ github.actor }}

# === MINIMAL PERMISSIONS ===
# Documentation workflow requires only specific repository access
permissions:
  contents: write      # Required for repository checkout and committing generated docs
  pull-requests: write  # Required for commenting on PRs with documentation status
  actions: read        # Required for reusable execution summary workflow to access job metadata

jobs:
  # === REUSABLE CHANGE DETECTION ===
  # Leverages standardized change detection workflow for consistency and efficiency
  # Replaces inline change detection logic with proven, centralized implementation
  detect-changes:
    name: üîç Detect Documentation Changes
    uses: ./.github/workflows/reusable-change-detection.yml
    with:
      # === PASS-THROUGH WORKFLOW INPUTS ===
      # Maintains seamless user experience by forwarding all manual dispatch inputs
      # Provides defaults for non-manual triggers (push, pull_request)
      target-path: ${{ github.event.inputs.target_path || '' }}
      force-all: ${{ github.event.inputs.force_all == 'true' || false }}

      # === TERRAFORM-DOCS SPECIFIC CONFIGURATION ===
      # Include both configurations and modules for comprehensive documentation coverage
      include-configs: true
      include-modules: true

      # === DOCUMENTATION-SPECIFIC PATH FILTERING ===
      # Filter for files that affect terraform-docs generation
      # Includes: .tf files, terraform-docs configs, header/footer markdown files
      path-filter: '\.(tf|terraform-docs\.ya?ml|_header\.md|_footer\.md)$'

  # === DOCUMENTATION GENERATION JOB ===
  # Generates terraform-docs only for paths with detected changes
  # Maintains documentation consistency and compliance with AVM standards
  terraform-docs:
    name: üìö Generate terraform-docs
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: detect-changes
    # Only execute if changes detected - prevents unnecessary workflow runs and resource usage
    # Skips documentation generation when no Terraform files have been modified
    if: needs.detect-changes.outputs.has-changes == 'true'

    # === JOB OUTPUT DECLARATIONS ===
    # Export key processing results for use by subsequent jobs
    outputs:
      output-files: ${{ steps.generate-docs.outputs.output_files }}
      generated-count: ${{ steps.generate-docs.outputs.generated_count }}
      failed-count: ${{ steps.generate-docs.outputs.failed_count }}

    steps:
      # === REPOSITORY CHECKOUT ===
      # For pull requests, checkout head branch to enable documentation commits
      # Uses GITHUB_TOKEN with write permissions for automated documentation updates
      - name: Checkout Repository for Documentation
        uses: actions/checkout@v4
        with:
          # Pull request events need head branch for commits, push events use current ref
          ref: ${{ github.event.pull_request.head.ref || github.ref }}
          token: ${{ secrets.GITHUB_TOKEN }}

      # === TERRAFORM DOCUMENTATION GENERATION ===
      # Processes only changed paths for efficiency and resource optimization
      # Uses terraform-docs Docker container for consistent execution environment
      - name: Generate Documentation for Changed Configurations
        id: generate-docs
        run: |
          echo "::notice title=Documentation Generation::Starting terraform-docs" \
               "generation for changed paths only..."

          # Initialize counters for execution reporting
          generated_count=0
          failed_count=0
          output_files=()

          # Retrieve changed paths from reusable change detection workflow
          paths_input="${{ needs.detect-changes.outputs.changed-paths }}"

          # Convert multi-line string to array for processing
          if [ -n "$paths_input" ]; then
            readarray -t paths <<< "$paths_input"
          else
            echo "::warning title=No Paths::No changed paths to process"
            exit 0
          fi

          # Process each detected change path individually
          for target_path in "${paths[@]}"; do
            # Skip empty lines from array conversion
            [ -z "$target_path" ] && continue

            echo "::notice title=Processing Changed Path::Generating documentation for: $target_path"

            # Validate path exists before attempting documentation generation
            if [ ! -d "$target_path" ]; then
              echo "::error title=Path Not Found::Directory does not exist: $target_path"
              # WHY: Continue processing other paths despite individual failures
              failed_count=$((failed_count + 1))
              continue
            fi

            # Locate terraform-docs configuration file with fallback support
            config_file=""
            if [ -f "$target_path/.terraform-docs.yml" ]; then
              config_file=".terraform-docs.yml"
            elif [ -f "$target_path/.terraform-docs.yaml" ]; then
              config_file=".terraform-docs.yaml"
            else
              echo "::warning title=No Config::No terraform-docs configuration found in" \
                   "$target_path, skipping"
              continue
            fi

            # Verify Terraform files exist before processing
            if ! find "$target_path" -maxdepth 1 -name "*.tf" -type f | grep -q .; then
              echo "::warning title=No TF Files::No Terraform files found in $target_path, skipping"
              continue
            fi

            # Execute terraform-docs using pinned Docker image for consistency
            echo "::notice title=Generating Docs::Running terraform-docs for $target_path..."

            if docker run --rm \
              --volume "$(pwd):/terraform-docs" \
              --workdir "/terraform-docs/$target_path" \
              quay.io/terraform-docs/terraform-docs:0.20.0 \
              -c "$config_file" .; then

              echo "::notice title=Generation Success::‚úÖ Documentation generated" \
                   "successfully for $target_path"
              generated_count=$((generated_count + 1))

              # Determine output filename from terraform-docs config (typically README.md)
              output_file="$target_path/README.md"
              if [ -f "$output_file" ]; then
                output_files+=("$output_file")
                echo "::notice title=Output File::üìÑ Generated: $output_file"
              fi
            else
              echo "::error title=Generation Failed::‚ùå terraform-docs failed for $target_path"
              failed_count=$((failed_count + 1))
            fi
          done

          # Report execution summary for transparency
          echo "::notice title=Generation Complete::üìä Generated: $generated_count," \
               "Failed: $failed_count"

          # Fail workflow if any documentation generation failed
          if [ $failed_count -gt 0 ]; then
            echo "::error title=Generation Failures::Some documentation generation failed." \
                 "Check logs above."
            exit 1
          fi

          # Store results for downstream job usage
          echo "generated_count=$generated_count" >> $GITHUB_OUTPUT
          echo "failed_count=$failed_count" >> $GITHUB_OUTPUT

          # Format output files as comma-separated list for execution summary
          if [ ${#output_files[@]} -gt 0 ]; then
            output_files_list=$(printf "%s," "${output_files[@]}")
            output_files_list="${output_files_list%,}"  # Remove trailing comma
            echo "output_files=$output_files_list" >> $GITHUB_OUTPUT
            echo "::notice title=Output Files::üìã Generated files: $output_files_list"
          else
            echo "output_files=" >> $GITHUB_OUTPUT
          fi

      # === CHANGE DETECTION AND GIT CONFIGURATION ===
      # Detects documentation changes and prepares for automated commits
      # Configures git identity for consistent commit attribution
      - name: Check for Documentation Changes
        id: changes
        run: |
          echo "::notice title=Change Detection::Checking for documentation changes..."

          # Configure git identity for automated commits
          # Uses GitHub Actions bot identity for traceability
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Detect if documentation generation created any file changes
          if git diff --quiet && [ -z "$(git ls-files --others --exclude-standard)" ]; then
            echo "::notice title=No Changes::No documentation changes detected"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "::notice title=Changes Detected::Documentation changes found"
            echo "has_changes=true" >> $GITHUB_OUTPUT

            # Display changed files for transparency and debugging
            echo "::group::Changed Files"
            # Show both modified tracked files and new untracked files
            echo "Modified files:"
            git diff --name-only
            echo "New files:"
            git ls-files --others --exclude-standard
            echo "::endgroup::"
          fi

      # === AUTOMATED DOCUMENTATION COMMIT ===
      # Commits generated documentation with detailed metadata for audit trails
      # Only executes when documentation changes are detected
      - name: Commit Documentation Updates
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          echo "::notice title=Committing Changes::Committing updated documentation..."

          # Stage all documentation changes for commit
          git add -A

          # Build comprehensive commit message with change context
          changed_paths="${{ needs.detect-changes.outputs.changed-paths }}"
          readarray -t paths <<< "$changed_paths"

          commit_message="docs: update terraform documentation

          Auto-generated by terraform-docs GitHub Action

          Updated documentation for changed paths:
          $(printf '%s\n' "${paths[@]}" | sed 's/^/- /')

          Files updated:
          $(git diff --cached --name-only | sed 's/^/- /')

          Workflow: ${{ github.workflow }}
          Run: ${{ github.run_number }}
          Triggered by: ${{ github.actor }}
          Event: ${{ github.event_name }}"

          # Execute commit with detailed message
          git commit -m "$commit_message"

          # Push changes with appropriate branch handling
          # Pull request events require pushing to head branch
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            git push origin "${{ github.event.pull_request.head.ref }}"
            echo "::notice title=Pushed to PR::‚úÖ Documentation committed to pull request branch"
          else
            # Push events use current branch reference
            git push origin "${{ github.ref_name }}"
            echo "::notice title=Pushed to Branch::‚úÖ Documentation committed to" \
                 "branch ${{ github.ref_name }}"
          fi

      # === PULL REQUEST NOTIFICATION ===
      # Provides feedback on documentation changes for pull request reviews
      # Only executes for pull request events to avoid unnecessary comments
      - name: Comment on Pull Request
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const hasChanges = '${{ steps.changes.outputs.has_changes }}' === 'true';
            const changedPaths = `${{ needs.detect-changes.outputs.changed-paths }}`.split('\n').filter(p => p.trim());

            let commentBody;
            if (hasChanges) {
              const pathsList = changedPaths.map(path => `- \`${path}\``).join('\n');
              commentBody = `## üìö Terraform Documentation Updated

              The terraform-docs workflow has automatically updated documentation ` +
              `for the following changed paths:

              ### Updated Paths
              ${pathsList}

              ### Changes Made
              - Documentation regenerated using terraform-docs v0.20.0
              - README files updated with latest Terraform configuration details
              - Changes committed automatically to this PR branch

              ### Next Steps
              Please review the documentation changes in the **Files changed** ` +
              `tab to ensure they look correct.

              ---
              *This comment was generated automatically by the terraform-docs workflow.*`;
            } else {
              commentBody = `## üìö Terraform Documentation Status

              The terraform-docs workflow has completed successfully with no changes needed.

              ### Status
              ‚úÖ All documentation is up-to-date for changed paths

              ### Processed Paths
              ${changedPaths.map(path => `- \`${path}\``).join('\n')}

              ---
              *This comment was generated automatically by the terraform-docs workflow.*`;
            }

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: commentBody
            });
