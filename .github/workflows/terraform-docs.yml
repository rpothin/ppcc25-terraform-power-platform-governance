# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# TERRAFORM DOCUMENTATION WORKFLOW FOR POWER PLATFORM GOVERNANCE
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Automatically generates and maintains up-to-date Terraform documentation using terraform-docs
# for all configurations and modules, ensuring governance compliance and developer productivity.
#
# ğŸ¯ WHY THIS EXISTS:
# - Documentation governance requirement for Infrastructure as Code transparency
# - Eliminates manual documentation updates that become stale and inaccurate
# - Ensures consistent documentation format across all Terraform configurations
# - Supports audit trails and compliance through automated documentation generation
#
# ğŸ”’ SECURITY DECISIONS:
# - Uses GITHUB_TOKEN for repository access with minimal required permissions
# - No external secrets required - documentation generation is read-only operation
# - Smart change detection prevents unnecessary processing of unmodified paths
#
# âš™ï¸ OPERATIONAL CONTEXT:
# - Cancellation allowed because documentation generation is idempotent
# - Processes only changed paths for efficiency and reduced resource usage
# - Commits documentation updates automatically to maintain consistency
#
# ğŸ“‹ INTEGRATION REQUIREMENTS:
# - Depends on .terraform-docs.yml configuration in each Terraform directory
# - Uses terraform-docs v0.20.0 for consistent formatting standards
# - Follows Azure Verified Module (AVM) documentation patterns
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: Terraform Docs

# === CONCURRENCY PROTECTION ===
# Allow safe cancellation because documentation generation is idempotent
# No risk of state corruption since this only updates documentation files
concurrency:
  group: terraform-docs-${{ github.ref }}
  cancel-in-progress: true

# === TRIGGER CONFIGURATION ===
# Smart trigger pattern focuses on files that affect documentation generation
# Manual dispatch supports ad-hoc generation for specific paths or full repository
on:
  pull_request:
    paths:
      - 'modules/**/*.tf'
      - 'modules/**/.terraform-docs.yml'
      - 'modules/**/_header.md'
      - 'modules/**/_footer.md'
      - 'configurations/**/*.tf'
      - 'configurations/**/.terraform-docs.yml'
      - 'configurations/**/_header.md'
      - 'configurations/**/_footer.md'
  push:
    branches: [main]
    paths:
      - 'modules/**/*.tf'
      - 'modules/**/.terraform-docs.yml'
      - 'modules/**/_header.md'
      - 'modules/**/_footer.md'
      - 'configurations/**/*.tf'
      - 'configurations/**/.terraform-docs.yml'
      - 'configurations/**/_header.md'
      - 'configurations/**/_footer.md'
  workflow_dispatch:
    inputs:
      target_path:
        description: 'Specific path to generate docs for (e.g., configurations/01-dlp-policies). Leave empty to process all changed or all paths.'
        required: false
        type: string
        # WHY: Allows targeted documentation generation for specific configurations
        # GOVERNANCE: Enables focused updates without processing entire repository
        # EFFICIENCY: Reduces processing time for large repositories with many configurations
        
      force_all:
        description: 'Force processing all configurations and modules (ignore change detection)'
        required: false
        default: false
        type: boolean
        # WHY: Override for scenarios where change detection may miss important updates
        # USE CASE: Repository restructuring, configuration file changes, or manual refresh
        # SAFETY: Default false prevents accidental full repository processing

# === DYNAMIC RUN NAMING ===
# Provides clear identification of what documentation generation covers
run-name: ğŸ“š Generate Terraform Docs${{ github.event.inputs.target_path && format(' for {0}', github.event.inputs.target_path) || (github.event.inputs.force_all == 'true' && ' for ALL paths' || ' for changed paths') }} by @${{ github.actor }}

# === MINIMAL PERMISSIONS ===
# Documentation workflow requires only specific repository access
permissions:
  contents: write     # Required for repository checkout and committing generated docs
  pull-requests: write # Required for commenting on PRs with documentation status

jobs:
  # === CHANGE DETECTION JOB ===
  # Optimizes workflow execution by processing only modified Terraform configurations
  # Prevents unnecessary documentation generation and reduces CI/CD resource usage
  detect-changes:
    name: ğŸ” Detect Changes
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      configurations: ${{ steps.detect.outputs.has-changes }}
      modules: ${{ steps.detect.outputs.has-changes }}
      any-docs-changed: ${{ steps.detect.outputs.has-changes }}
      changed-paths: ${{ steps.detect.outputs.changed-paths }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history required for accurate change detection between commits

      - name: Detect Changes
        id: detect
        uses: ./.github/actions/detect-terraform-changes
        with:
          target-path: ${{ github.event.inputs.target_path }}
          force-all: ${{ github.event.inputs.force_all }}
          include-configs: 'true'
          include-modules: 'true'

  # === DOCUMENTATION GENERATION JOB ===
  # Generates terraform-docs only for paths with detected changes
  # Maintains documentation consistency and compliance with AVM standards
  terraform-docs:
    name: ğŸ“š Generate terraform-docs
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: detect-changes
    # Only execute if changes detected - prevents unnecessary workflow runs
    if: needs.detect-changes.outputs.has-changes == 'true'

    steps:
    # === REPOSITORY CHECKOUT ===
    # For pull requests, checkout head branch to enable documentation commits
    # Uses GITHUB_TOKEN with write permissions for automated documentation updates
    - name: Checkout Repository for Documentation
      uses: actions/checkout@v4
      with:
        # Pull request events need head branch for commits, push events use current ref
        ref: ${{ github.event.pull_request.head.ref || github.ref }}
        token: ${{ secrets.GITHUB_TOKEN }}

    # === TERRAFORM DOCUMENTATION GENERATION ===
    # Processes only changed paths for efficiency and resource optimization
    # Uses terraform-docs Docker container for consistent execution environment
    - name: Generate Documentation for Changed Configurations
      run: |
        echo "::notice title=Documentation Generation::Starting terraform-docs generation for changed paths only..."
        
        # Initialize counters for execution reporting
        generated_count=0
        failed_count=0
        
        # Retrieve changed paths from change detection job
        paths_input="${{ needs.detect-changes.outputs.changed-paths }}"
        
        # Convert multi-line string to array for processing
        if [ -n "$paths_input" ]; then
          readarray -t paths <<< "$paths_input"
        else
          echo "::warning title=No Paths::No changed paths to process"
          exit 0
        fi
        
        # Process each detected change path individually
        for target_path in "${paths[@]}"; do
          # Skip empty lines from array conversion
          [ -z "$target_path" ] && continue
          
          echo "::notice title=Processing Changed Path::Generating documentation for: $target_path"
          
          # Validate path exists before attempting documentation generation
          if [ ! -d "$target_path" ]; then
            echo "::error title=Path Not Found::Directory does not exist: $target_path"
            # WHY: Continue processing other paths despite individual failures
            failed_count=$((failed_count + 1))
            continue
          fi
          
          # Locate terraform-docs configuration file with fallback support
          config_file=""
          if [ -f "$target_path/.terraform-docs.yml" ]; then
            config_file=".terraform-docs.yml"
          elif [ -f "$target_path/.terraform-docs.yaml" ]; then
            config_file=".terraform-docs.yaml"
          else
            echo "::warning title=No Config::No terraform-docs configuration found in $target_path, skipping"
            continue
          fi
          
          # Verify Terraform files exist before processing
          if ! find "$target_path" -maxdepth 1 -name "*.tf" -type f | grep -q .; then
            echo "::warning title=No TF Files::No Terraform files found in $target_path, skipping"
            continue
          fi
          
          # Execute terraform-docs using pinned Docker image for consistency
          echo "::notice title=Generating Docs::Running terraform-docs for $target_path..."
          
          if docker run --rm \
            --volume "$(pwd):/terraform-docs" \
            --workdir "/terraform-docs/$target_path" \
            quay.io/terraform-docs/terraform-docs:0.20.0 \
            -c "$config_file" .; then
            
            echo "::notice title=Generation Success::âœ… Documentation generated successfully for $target_path"
            generated_count=$((generated_count + 1))
          else
            echo "::error title=Generation Failed::âŒ terraform-docs failed for $target_path"
            failed_count=$((failed_count + 1))
          fi
        done
        
        # Report execution summary for transparency
        echo "::notice title=Generation Complete::ğŸ“Š Generated: $generated_count, Failed: $failed_count"
        
        # Fail workflow if any documentation generation failed
        if [ $failed_count -gt 0 ]; then
          echo "::error title=Generation Failures::Some documentation generation failed. Check logs above."
          exit 1
        fi
        
        # Store results for downstream job usage
        echo "generated_count=$generated_count" >> $GITHUB_OUTPUT
        echo "failed_count=$failed_count" >> $GITHUB_OUTPUT

    # === CHANGE DETECTION AND GIT CONFIGURATION ===
    # Detects documentation changes and prepares for automated commits
    # Configures git identity for consistent commit attribution
    - name: Check for Documentation Changes
      id: changes
      run: |
        echo "::notice title=Change Detection::Checking for documentation changes..."
        
        # Configure git identity for automated commits
        # Uses GitHub Actions bot identity for traceability
        git config user.name "github-actions[bot]"
        git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
        
        # Detect if documentation generation created any file changes
        if git diff --quiet; then
          echo "::notice title=No Changes::No documentation changes detected"
          echo "has_changes=false" >> $GITHUB_OUTPUT
        else
          echo "::notice title=Changes Detected::Documentation changes found"
          echo "has_changes=true" >> $GITHUB_OUTPUT
          
          # Display changed files for transparency and debugging
          echo "::group::Changed Files"
          git diff --name-only
          echo "::endgroup::"
        fi

    # === AUTOMATED DOCUMENTATION COMMIT ===
    # Commits generated documentation with detailed metadata for audit trails
    # Only executes when documentation changes are detected
    - name: Commit Documentation Updates
      if: steps.changes.outputs.has_changes == 'true'
      run: |
        echo "::notice title=Committing Changes::Committing updated documentation..."
        
        # Stage all documentation changes for commit
        git add -A
        
        # Build comprehensive commit message with change context
        changed_paths="${{ needs.detect-changes.outputs.changed-paths }}"
        readarray -t paths <<< "$changed_paths"
        
        commit_message="docs: update terraform documentation
        
        Auto-generated by terraform-docs GitHub Action
        
        Updated documentation for changed paths:
        $(printf '%s\n' "${paths[@]}" | sed 's/^/- /')
        
        Files updated:
        $(git diff --cached --name-only | sed 's/^/- /')
        
        Workflow: ${{ github.workflow }}
        Run: ${{ github.run_number }}
        Triggered by: ${{ github.actor }}
        Event: ${{ github.event_name }}"
        
        # Execute commit with detailed message
        git commit -m "$commit_message"
        
        # Push changes with appropriate branch handling
        # Pull request events require pushing to head branch
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          git push origin "${{ github.event.pull_request.head.ref }}"
          echo "::notice title=Pushed to PR::âœ… Documentation committed to pull request branch"
        else
          # Push events use current branch reference
          git push origin "${{ github.ref_name }}"
          echo "::notice title=Pushed to Branch::âœ… Documentation committed to branch ${{ github.ref_name }}"
        fi

    # === PULL REQUEST NOTIFICATION ===
    # Provides feedback on documentation changes for pull request reviews
    # Only executes for pull request events to avoid unnecessary comments
    - name: Comment on Pull Request
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const hasChanges = '${{ steps.changes.outputs.has_changes }}' === 'true';
          const changedPaths = `${{ needs.detect-changes.outputs.changed-paths }}`.split('\n').filter(p => p.trim());
          
          let commentBody;
          if (hasChanges) {
            const pathsList = changedPaths.map(path => `- \`${path}\``).join('\n');
            commentBody = `## ğŸ“š Terraform Documentation Updated
            
            The terraform-docs workflow has automatically updated documentation for the following changed paths:
            
            ### Updated Paths
            ${pathsList}
            
            ### Changes Made
            - Documentation regenerated using terraform-docs v0.20.0
            - README files updated with latest Terraform configuration details
            - Changes committed automatically to this PR branch
            
            ### Next Steps
            Please review the documentation changes in the **Files changed** tab to ensure they look correct.
            
            ---
            *This comment was generated automatically by the terraform-docs workflow.*`;
          } else {
            commentBody = `## ğŸ“š Terraform Documentation Status
            
            The terraform-docs workflow has completed successfully with no changes needed.
            
            ### Status
            âœ… All documentation is up-to-date for changed paths
            
            ### Processed Paths
            ${changedPaths.map(path => `- \`${path}\``).join('\n')}
            
            ---
            *This comment was generated automatically by the terraform-docs workflow.*`;
          }
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: commentBody
          });

    # === COMPREHENSIVE WORKFLOW SUMMARY ===
    # Generates detailed execution report for transparency and troubleshooting
    # Always executes to provide feedback regardless of success or failure
    - name: Generate Workflow Summary
      if: always()
      run: |
        # Build comprehensive workflow summary for GitHub UI
        echo "## ğŸ“š Terraform Documentation Generation Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Execution Details" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Parameter | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| Trigger | ${{ github.event_name }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Optimization | **Changed paths only** âš¡ |" >> $GITHUB_STEP_SUMMARY
        echo "| Processed Paths | ${{ needs.detect-changes.outputs.changed-paths != '' && 'âœ… Detected changes' || 'ğŸ” No changes detected' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Timestamp | $(date +%Y-%m-%d\ %H:%M:%S) |" >> $GITHUB_STEP_SUMMARY
        echo "| Executed by | @${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Workflow run | [${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Calculate and report efficiency metrics
        changed_paths="${{ needs.detect-changes.outputs.changed-paths }}"
        if [ -n "$changed_paths" ]; then
          readarray -t paths <<< "$changed_paths"
          path_count=${#paths[@]}
          
          echo "### âš¡ Efficiency Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Paths Processed** | $path_count (changed only) |" >> $GITHUB_STEP_SUMMARY
          echo "| **Optimization** | âœ… Smart change detection enabled |" >> $GITHUB_STEP_SUMMARY
          echo "| **Time Saved** | ~$(( (10 - $path_count) * 30 )) seconds (estimated) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ğŸ“ Changed Paths Processed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          for path in "${paths[@]}"; do
            [ -n "$path" ] && echo "- \`$path\`" >> $GITHUB_STEP_SUMMARY
          done
        else
          echo "### âš¡ Efficiency Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Paths Processed** | 0 (no relevant changes detected) |" >> $GITHUB_STEP_SUMMARY
          echo "| **Optimization** | âœ… Workflow skipped unnecessary processing |" >> $GITHUB_STEP_SUMMARY
          echo "| **Time Saved** | ~5 minutes (full scan avoided) |" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Document execution status and results
        has_changes="${{ steps.changes.outputs.has_changes }}"
        if [ "$has_changes" = "true" ]; then
          echo "### âœ… Documentation Updated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Detail | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Status** | Documentation Changes Committed |" >> $GITHUB_STEP_SUMMARY
          echo "| **Action Taken** | README files updated and committed |" >> $GITHUB_STEP_SUMMARY
          echo "| **terraform-docs Version** | 0.20.0 |" >> $GITHUB_STEP_SUMMARY
        else
          echo "### ğŸ†— Documentation Current" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Detail | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Status** | No Changes Needed |" >> $GITHUB_STEP_SUMMARY
          echo "| **Current State** | All documentation is up-to-date |" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Provide actionable next steps
        echo "### ğŸ“‹ Next Steps" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ "$has_changes" = "true" ]; then
          echo "1. **Review Changes**: Check the committed documentation updates" >> $GITHUB_STEP_SUMMARY
          echo "2. **Verify Content**: Ensure generated content is accurate and complete" >> $GITHUB_STEP_SUMMARY
          echo "3. **Continue Development**: Documentation is now current for your changes" >> $GITHUB_STEP_SUMMARY
        else
          echo "1. **No Action Required**: Documentation is current and consistent" >> $GITHUB_STEP_SUMMARY
          echo "2. **Continue Development**: All documentation requirements are met" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Include important operational context
        echo "### ğŸ“Œ Important Notes" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **âš¡ Smart Processing**: Only processes changed configurations/modules" >> $GITHUB_STEP_SUMMARY
        echo "- **ğŸš€ Performance**: Significantly faster than full repository scan" >> $GITHUB_STEP_SUMMARY
        echo "- **ğŸ¯ Precision**: Targets exactly what needs updating" >> $GITHUB_STEP_SUMMARY
        echo "- **â™»ï¸ Resource Efficient**: Saves CI/CD minutes and reduces carbon footprint" >> $GITHUB_STEP_SUMMARY
        echo "- **AVM Compliance**: Documentation follows Azure Verified Module standards" >> $GITHUB_STEP_SUMMARY
        echo "- **Configuration**: Each path uses its own .terraform-docs.yml configuration" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
