---
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# TERRAFORM ARTIFACT MANAGEMENT WORKFLOW FOR POWER PLATFORM GOVERNANCE
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# Provides standardized artifact upload capabilities with configurable retention policies, consistent
# naming conventions, and comprehensive metadata handling for all terraform workflows.
#
# üéØ WHY THIS EXISTS:
# - Governance requirement: Audit trails for all infrastructure changes and deployments
# - Business problem: Manual artifact management leads to inconsistent retention and naming
# - Operational benefit: Centralized artifact handling reduces duplication across workflows
#
# üîí SECURITY DECISIONS:
# - Limited permissions to read contents and actions only for artifact operations
# - No sensitive data exposure through artifact names or metadata
# - Retention policies prevent indefinite storage of potentially sensitive outputs
#
# ‚öôÔ∏è OPERATIONAL CONTEXT:
# - No concurrency controls needed as artifact uploads are independent operations
# - Short timeout prevents hanging uploads from blocking other workflows
# - Multiple trigger patterns support both reusable calls and manual testing
#
# üìã INTEGRATION REQUIREMENTS:
# - Used by terraform-plan-apply.yml for plan file and output management
# - Integrates with GitHub Actions artifact storage with automatic cleanup
# - Standardized naming prevents artifact conflicts across configurations
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

name: ‚ôªÔ∏è Artifact Management

on:
  workflow_call:
    inputs:
      # === CORE ARTIFACT CONFIGURATION ===
      artifact-name:
        description: >-
          Unique name for the artifact (without automatic suffixes)
        required: true
        type: string
        # WHY: Base name enables consistent identification across workflows
        # VALIDATION: Must be non-empty and valid for GitHub artifact naming
        # EXAMPLES: 'terraform-plan', 'terraform-output', 'security-scan-results'

      artifact-path:
        description: >-
          Path or paths to files/directories to include in artifact
          (supports multi-line patterns)
        required: true
        type: string
        # WHY: Flexible path specification supports both single files and directory patterns
        # VALIDATION: Paths must exist relative to repository root
        # EXAMPLES: '*.tfplan', 'outputs-*.json', 'configurations/*/README.md'

      # === RETENTION AND LIFECYCLE MANAGEMENT ===
      retention-days:
        description: >-
          Artifact retention period in days (1-400, defaults based on
          artifact type)
        required: false
        type: number
        default: 14
        # WHY: Configurable retention balances storage costs with audit requirements
        # GOVERNANCE: Minimum retention supports compliance and troubleshooting needs
        # LIMITS: GitHub Actions maximum retention is 400 days

      # === NAMING AND IDENTIFICATION ===
      include-run-number:
        description: >-
          Include GitHub run number in artifact name for uniqueness
        required: false
        type: boolean
        default: true
        # WHY: Run numbers ensure unique artifact names across workflow executions
        # GOVERNANCE: Supports audit trails by linking artifacts to specific runs
        # DEFAULT: True because most use cases benefit from unique naming

      include-configuration:
        description: >-
          Include configuration name in artifact name
          (requires configuration-name)
        required: false
        type: boolean
        default: false
        # WHY: Configuration names enable filtering artifacts by infrastructure scope
        # GOVERNANCE: Essential for multi-configuration deployments
        # DEPENDENCY: Requires configuration-name parameter when enabled

      configuration-name:
        description: 'Configuration name to include in artifact name'
        required: false
        type: string
        default: ''
        # WHY: Identifies specific configuration for scope-based artifact management
        # VALIDATION: Must match existing configuration directory when used
        # EXAMPLES: '01-dlp-policies', '02-dlp-policy', '03-environment'

      include-tfvars-file:
        description: >-
          Include tfvars file identifier in artifact name
          (requires tfvars-file)
        required: false
        type: boolean
        default: false
        # WHY: Environment-specific naming supports parallel deployments
        # GOVERNANCE: Prevents artifact conflicts between environments
        # DEPENDENCY: Requires tfvars-file parameter when enabled

      tfvars-file:
        description: 'Tfvars file identifier to include in artifact name'
        required: false
        type: string
        default: 'default'
        # WHY: Environment identification enables environment-specific artifact tracking
        # VALIDATION: Should match tfvars file naming convention
        # EXAMPLES: 'dev', 'prod', 'dlp-finance', 'env-development'

      # === METADATA AND DOCUMENTATION ===
      artifact-description:
        description: >-
          Human-readable description of artifact contents and purpose
        required: false
        type: string
        default: ''
        # WHY: Improves artifact discoverability and understanding
        # GOVERNANCE: Supports documentation requirements for audit trails
        # FALLBACK: Auto-generated description when not provided

      # === EXECUTION CONTROL ===
      continue-on-error:
        description: >-
          Continue workflow execution even if artifact upload fails
        required: false
        type: boolean
        default: true
        # WHY: Artifact upload failures shouldn't block critical deployment operations
        # OPERATIONAL: Allows infrastructure operations to complete despite storage issues
        # SECURITY: Default true prevents deployment interruptions from storage problems

      upload-condition:
        description: >-
          Condition for when to upload artifact (always, success, failure)
        required: false
        type: string
        default: 'always'
        # WHY: Flexible upload conditions support debugging and audit requirements
        # GOVERNANCE: 'always' ensures artifacts available for failure analysis
        # OPTIONS: 'always', 'success', 'failure' for different use cases

  workflow_dispatch:
    inputs:
      # === MANUAL TESTING CONFIGURATION ===
      artifact-name:
        description: 'Test artifact name'
        required: true
        type: string
        default: 'test-artifact'
        # WHY: Manual testing requires simple, predictable naming

      artifact-path:
        description: 'Test artifact path (use README.md for testing)'
        required: true
        type: string
        default: 'README.md'
        # WHY: README.md provides reliable test file that always exists

      retention-days:
        description: 'Test retention period'
        required: false
        type: number
        default: 1
        # WHY: Short retention for testing minimizes storage usage

      include-run-number:
        description: 'Include run number in name'
        required: false
        type: boolean
        default: true
        # WHY: Maintains consistency with reusable workflow defaults

# === SECURITY AND PERMISSIONS ===
# Limited permissions following principle of least privilege
# Only artifact and content operations needed for upload functionality
permissions:
  contents: read              # Read repository contents
  actions: read              # Read workflow artifacts

# === WORKFLOW EXECUTION ===
jobs:
  # ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
  # ‚ïë                           ARTIFACT UPLOAD JOB                           ‚ïë
  # ‚ïë                     Standardized Artifact Management                    ‚ïë
  # ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

  upload-artifact:
    name: üì¶ Upload Artifact
    runs-on: ubuntu-latest
    timeout-minutes: 10
    # WHY: Short timeout prevents hanging uploads from affecting other workflows

    steps:
      # === ARTIFACT NAME GENERATION ===
      # Build standardized artifact name based on configuration inputs
      - name: Generate Artifact Name
        id: artifact-name
        run: |
          # === ARTIFACT NAME CONSTRUCTION LOGIC ===
          # Build standardized artifact name based on configuration inputs
          echo "::group::üè∑Ô∏è Artifact Name Construction"

          # Start with base name
          ARTIFACT_NAME="${{ inputs.artifact-name }}"
          echo "Base name: $ARTIFACT_NAME"

          # Add configuration name if requested
          if [[ "${{ inputs.include-configuration }}" == "true" && \
                -n "${{ inputs.configuration-name }}" ]]; then
            ARTIFACT_NAME="${ARTIFACT_NAME}-${{ inputs.configuration-name }}"
            echo "Added configuration: $ARTIFACT_NAME"
          fi

          # Add tfvars file identifier if requested
          if [[ "${{ inputs.include-tfvars-file }}" == "true" && \
                -n "${{ inputs.tfvars-file }}" ]]; then
            ARTIFACT_NAME="${ARTIFACT_NAME}-${{ inputs.tfvars-file }}"
            echo "Added tfvars file: $ARTIFACT_NAME"
          fi

          # Add run number if requested (default behavior)
          if [[ "${{ inputs.include-run-number }}" == "true" ]]; then
            ARTIFACT_NAME="${ARTIFACT_NAME}-${{ github.run_number }}"
            echo "Added run number: $ARTIFACT_NAME"
          fi

          # Validate and sanitize artifact name
          ARTIFACT_NAME=$(echo "$ARTIFACT_NAME" | sed 's/[^a-zA-Z0-9._-]/-/g')
          echo "Sanitized name: $ARTIFACT_NAME"

          # Set output for use in upload step
          echo "name=$ARTIFACT_NAME" >> $GITHUB_OUTPUT

          echo "::notice title=Artifact Name::üì¶ Generated artifact name: $ARTIFACT_NAME"
          echo "::endgroup::"

      # === ARTIFACT VALIDATION AND PREPARATION ===
      # Validates configuration parameters before upload to prevent failures
      - name: Validate Artifact Configuration
        run: |
          echo "::group::üîç Artifact Configuration Validation"

          # === CONFIGURATION VALIDATION ===
          echo "üìã Validating artifact configuration parameters..."

          # Validate retention period
          RETENTION_DAYS=${{ inputs.retention-days }}
          if [[ $RETENTION_DAYS -lt 1 || $RETENTION_DAYS -gt 400 ]]; then
            echo "::error title=Invalid Retention::‚ùå Retention days must be between 1 and 400 (got: $RETENTION_DAYS)"
            exit 1
          fi
          echo "‚úÖ Retention period valid: $RETENTION_DAYS days"

          # Validate upload condition
          UPLOAD_CONDITION="${{ inputs.upload-condition }}"
          if [[ ! "$UPLOAD_CONDITION" =~ ^(always|success|failure)$ ]]; then
            echo "::error title=Invalid Condition::‚ùå Upload condition must be 'always', 'success', or 'failure' (got: $UPLOAD_CONDITION)"
            exit 1
          fi
          echo "‚úÖ Upload condition valid: $UPLOAD_CONDITION"

          # Check for required configuration dependencies
          if [[ "${{ inputs.include-configuration }}" == "true" && \
                -z "${{ inputs.configuration-name }}" ]]; then
            echo "::error title=Missing Configuration::‚ùå Configuration name required when include-configuration is true"
            exit 1
          fi

          if [[ "${{ inputs.include-tfvars-file }}" == "true" && \
                -z "${{ inputs.tfvars-file }}" ]]; then
            echo "::error title=Missing Tfvars::‚ùå Tfvars file required when include-tfvars-file is true"
            exit 1
          fi

          echo "::notice title=Validation Complete::‚úÖ All artifact configuration parameters validated successfully"
          echo "::endgroup::"

      # === STANDARDIZED ARTIFACT UPLOAD ===
      # Upload artifact with comprehensive metadata and flexible condition handling
      - name: Upload Artifact
        if: >-
          ${{ inputs.upload-condition == 'always' ||
              (inputs.upload-condition == 'success' && success()) ||
              (inputs.upload-condition == 'failure' && failure()) }}
        uses: actions/upload-artifact@v4
        with:
          # === STANDARDIZED ARTIFACT CONFIGURATION ===
          name: ${{ steps.artifact-name.outputs.name }}
          path: ${{ inputs.artifact-path }}
          retention-days: ${{ inputs.retention-days }}
          if-no-files-found: warn
          compression-level: 6    # Balanced compression for reasonable times

          # === ENHANCED DESCRIPTION WITH METADATA ===
          description: |
            ${{ inputs.artifact-description != '' && inputs.artifact-description || format('Artifact uploaded from workflow {0} (run #{1})', github.workflow, github.run_number) }}

            üìã Artifact Metadata:
            ‚Ä¢ Workflow: ${{ github.workflow }}
            ‚Ä¢ Run Number: ${{ github.run_number }}
            ‚Ä¢ Configuration: ${{ inputs.configuration-name || 'N/A' }}
            ‚Ä¢ Tfvars File: ${{ inputs.tfvars-file || 'N/A' }}
            ‚Ä¢ Retention: ${{ inputs.retention-days }} days
            ‚Ä¢ Upload Time: ${{ github.run_id }}
            ‚Ä¢ Repository: ${{ github.repository }}
            ‚Ä¢ Branch/Tag: ${{ github.ref_name }}
            ‚Ä¢ Commit SHA: ${{ github.sha }}
        continue-on-error: ${{ inputs.continue-on-error }}

      # === UPLOAD SUMMARY AND REPORTING ===
      # Provides comprehensive summary regardless of upload success/failure
      - name: Artifact Upload Summary
        if: always()
        run: |
          echo "::group::üìä Artifact Upload Summary"

          # === UPLOAD RESULTS SUMMARY ===
          echo "üì¶ **Artifact Upload Summary**"
          echo "‚Ä¢ Artifact Name: ${{ steps.artifact-name.outputs.name }}"
          echo "‚Ä¢ Retention Period: ${{ inputs.retention-days }} days"
          echo "‚Ä¢ Upload Condition: ${{ inputs.upload-condition }}"
          echo "‚Ä¢ Continue on Error: ${{ inputs.continue-on-error }}"
          echo "‚Ä¢ Configuration: ${{ inputs.configuration-name || 'Not specified' }}"
          echo "‚Ä¢ Tfvars File: ${{ inputs.tfvars-file || 'Not specified' }}"

          # === PATH INFORMATION ===
          echo ""
          echo "üìÅ **Artifact Paths:**"
          echo "${{ inputs.artifact-path }}" | while IFS= read -r path; do
            if [[ -n "$path" ]]; then
              echo "‚Ä¢ $path"
            fi
          done

          # === METADATA SUMMARY ===
          echo ""
          echo "üè∑Ô∏è **Workflow Context:**"
          echo "‚Ä¢ Repository: ${{ github.repository }}"
          echo "‚Ä¢ Workflow: ${{ github.workflow }}"
          echo "‚Ä¢ Run Number: ${{ github.run_number }}"
          echo "‚Ä¢ Branch/Tag: ${{ github.ref_name }}"
          echo "‚Ä¢ Actor: ${{ github.actor }}"

          echo "::notice title=Upload Complete::üì¶ Artifact upload process completed - check workflow artifacts for results"
          echo "::endgroup::"
