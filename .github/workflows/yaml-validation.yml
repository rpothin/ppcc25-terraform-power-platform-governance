---
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# YAML VALIDATION WORKFLOW FOR POWER PLATFORM GOVERNANCE
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Validates YAML syntax and style for all GitHub Actions files to prevent
# runtime failures and ensure consistent code quality.
#
# ðŸŽ¯ WHY THIS EXISTS:
# - Prevents malformed workflows from breaking CI/CD automation
# - Enforces consistent YAML style across Power Platform governance automation
# - Provides early feedback on pull requests before merge
#
# ðŸ”’ SECURITY DECISIONS:
# - Read-only permissions minimize attack surface
# - Uses only open-source validation tools, no secrets required
#
# âš™ï¸ OPERATIONAL CONTEXT:
# - Runs on YAML file changes to optimize resource usage
# - Cancellation enabled for rapid iteration workflows
# - Uses project-specific .yamllint rules for consistency
#
# ðŸ“‹ INTEGRATION REQUIREMENTS:
# - Project validation script: scripts/utils/validate-yaml.sh
# - Project yamllint config: .yamllint
# - Tools: yamllint, actionlint, Python YAML
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: "ðŸ› ï¸ Validate YAML Files"

concurrency:
  group: yaml-validation-${{ github.ref }}
  cancel-in-progress: true

on:
  pull_request:
    branches: main
    paths:
      - '.github/**/*.yml'
      - '.github/**/*.yaml'
      - '.yamllint'
      - 'scripts/utils/validate-yaml.sh'
  push:
    branches: main
    paths:
      - '.github/**/*.yml'
      - '.github/**/*.yaml'
      - '.yamllint'
  workflow_dispatch:

run-name: "ðŸ› ï¸ YAML validation for ${{ github.event_name }} by @${{ github.actor }}"

permissions:
  contents: write
  actions: write

jobs:
  validate-yaml:
    name: "Validate YAML Syntax and Style"
    runs-on: ubuntu-latest

    steps:
      - name: "Checkout Repository"
        uses: actions/checkout@v4
        with:
          # Fetch full history for comprehensive validation
          fetch-depth: 0
          token: ${{ secrets.YAML_VALIDATION_AUTOFIX_PAT }}

      # === PYTHON ENVIRONMENT SETUP ===
      # Python 3.11 provides stable foundation for YAML processing libraries
      # No pip cache needed since tools are installed via shell scripts
      - name: "Setup Python Environment"
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # === YAML VALIDATION TOOLS INSTALLATION ===
      # Use modular installation library for consistent tool setup across environments
      # Leverages yaml-tools-installer.sh for reusable installation patterns
      - name: "Install YAML Validation Tools"
        run: |
          # Source the installation library and install all validation tools
          source scripts/utils/yaml-tools-installer.sh
          install_all_yaml_tools

          # Ensure PATH includes user-installed packages for subsequent steps
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      # === SMART AUTO-FIX STRATEGY WITH LOOP PREVENTION ===
      # Controls auto-fix behavior with default-on approach and intelligent loop prevention
      - name: "Determine Auto-Fix Strategy"
        id: autofix-strategy
        run: |
          echo "ðŸ” Analyzing commit context for auto-fix strategy..."

          # Get the latest commit message for analysis
          LATEST_COMMIT_MSG="${{ github.event.head_commit.message }}"
          echo "ðŸ“ Latest commit: $LATEST_COMMIT_MSG"

          # Check for auto-fix skip indicators (prevents infinite loops)
          if [[ "$LATEST_COMMIT_MSG" =~ \[skip-autofix\] ]] || \
             [[ "$LATEST_COMMIT_MSG" =~ \[no-autofix\] ]] || \
             [[ "$LATEST_COMMIT_MSG" =~ "ðŸ¤– Auto-fix YAML" ]]; then
            echo "mode=detect-only" >> $GITHUB_OUTPUT
            echo "ðŸš« Auto-fix DISABLED: Skip flag detected or previous auto-fix commit"
            echo "reason=skip-requested" >> $GITHUB_OUTPUT
          # Check for explicit disable requests
          elif [[ "$LATEST_COMMIT_MSG" =~ \[disable-autofix\] ]]; then
            echo "mode=detect-only" >> $GITHUB_OUTPUT
            echo "ðŸš« Auto-fix DISABLED: Explicitly disabled via commit message"
            echo "reason=explicit-disable" >> $GITHUB_OUTPUT
          # Default behavior: auto-fix enabled
          else
            echo "mode=enabled" >> $GITHUB_OUTPUT
            echo "ðŸ› ï¸ Auto-fix ENABLED: Default behavior (use [skip-autofix] to disable)"
            echo "reason=default-enabled" >> $GITHUB_OUTPUT
          fi

          # Additional context logging
          echo "Event type: ${{ github.event_name }}"
          echo "Branch: ${{ github.ref_name }}"

      # === ENHANCED YAML VALIDATION WITH DEFAULT AUTO-FIX ===
      - name: "Validate YAML Files with Default Auto-Fix"
        id: yaml-validation
        run: |
          echo "ðŸ” Starting YAML validation with default auto-fix..."
          echo "ðŸ“‚ Current working directory: $(pwd)"
          echo "ðŸ“ Repository contents:"
          ls -la
          echo "ðŸ“ .github directory:"
          ls -la .github/ || echo "No .github directory found"

          # Run validation based on auto-fix strategy
          if [[ "${{ steps.autofix-strategy.outputs.mode }}" == "enabled" ]]; then
            echo "ðŸ› ï¸ Running validation with AUTO-FIX ENABLED (default behavior)..."
            echo "ðŸ’¡ Tip: Use [skip-autofix] in commit message to disable auto-fix"

            if ./scripts/utils/validate-yaml.sh --autofix --all-github; then
              echo "validation-result=success" >> $GITHUB_OUTPUT

              # Check if any files were modified by auto-fix
              if ! git diff --quiet; then
                echo "autofix-applied=true" >> $GITHUB_OUTPUT
                echo "âœ¨ Auto-fixes were applied to YAML files"
                echo ""
                echo "ðŸ“Š Changes summary:"
                git diff --stat
                echo ""
                echo "ðŸ” Detailed changes:"
                git diff --name-only
              else
                echo "autofix-applied=false" >> $GITHUB_OUTPUT
                echo "âœ… No auto-fixes needed - all files already compliant"
              fi
            else
              echo "validation-result=failed" >> $GITHUB_OUTPUT
              echo "âŒ Validation failed even with auto-fix enabled"
              echo "ðŸ”§ Some issues may require manual intervention"
            fi
          else
            echo "ðŸ” Running validation in DETECTION-ONLY mode..."
            echo "ðŸ“‹ Reason: ${{ steps.autofix-strategy.outputs.reason }}"

            if ./scripts/utils/validate-yaml.sh --all-github; then
              echo "validation-result=success" >> $GITHUB_OUTPUT
              echo "autofix-applied=false" >> $GITHUB_OUTPUT
              echo "âœ… Validation passed in detection-only mode"
            else
              echo "validation-result=failed" >> $GITHUB_OUTPUT
              echo "autofix-applied=false" >> $GITHUB_OUTPUT
              echo ""
              echo "âŒ Validation failed in detection-only mode"
              echo "ðŸ’¡ To enable auto-fix for next run, commit without [skip-autofix] flag"
            fi
          fi

      # === SMART AUTO-COMMIT WITH LOOP PREVENTION ===
      - name: "Commit Auto-Fix Changes with Loop Prevention"
        if: steps.yaml-validation.outputs.autofix-applied == 'true'
        uses: stefanzweifel/git-auto-commit-action@v6
        with:
          commit_message: |
            ðŸ¤– Auto-fix YAML formatting and compliance issues [skip-autofix]

            Applied automatic fixes for:
            - Document start markers (---)
            - Indentation and spacing
            - Trailing whitespace
            - File ending newlines
            - Style consistency improvements

            Triggered by: ${{ github.event_name }}
            Auto-fix reason: ${{ steps.autofix-strategy.outputs.reason }}
            Commit SHA: ${{ github.sha }}

            [skip-autofix] prevents infinite auto-fix loops
            Remove [skip-autofix] from future commits to re-enable auto-fix
          file_pattern: ".github/**/*.yml"
          commit_user_name: "github-actions"
          commit_user_email: "github-actions@github.com"

      # === ENHANCED VALIDATION REPORTING WITH AUTO-FIX STATUS ===
      - name: "Generate Comprehensive Validation Report"
        if: always()
        run: |
          echo "## ðŸ“‹ YAML Validation Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Validation results with enhanced context
          if [[ "${{ steps.yaml-validation.outputs.validation-result }}" == "success" ]]; then
            echo "âœ… **Validation Result**: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Validation Result**: FAILED" >> $GITHUB_STEP_SUMMARY
          fi

          # Auto-fix strategy and results
          echo "ðŸ› ï¸ **Auto-fix Mode**: ${{ steps.autofix-strategy.outputs.mode }}" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“‹ **Strategy Reason**: ${{ steps.autofix-strategy.outputs.reason }}" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ steps.yaml-validation.outputs.autofix-applied }}" == "true" ]]; then
            echo "âœ¨ **Auto-fixes Applied**: YES" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ”„ **Next Run**: Auto-fix will be skipped (loop prevention)" >> $GITHUB_STEP_SUMMARY
          else
            echo "ðŸ” **Auto-fixes Applied**: NO" >> $GITHUB_STEP_SUMMARY
            if [[ "${{ steps.autofix-strategy.outputs.mode }}" == "enabled" ]]; then
              echo "âœ… **Reason**: No fixes needed" >> $GITHUB_STEP_SUMMARY
            else
              echo "ðŸš« **Reason**: Auto-fix was disabled" >> $GITHUB_STEP_SUMMARY
            fi
          fi

          # File processing summary
          yaml_count=$(find .github -name "*.yml" -o -name "*.yaml" | wc -l)
          echo "- **Files validated:** ${yaml_count}" >> $GITHUB_STEP_SUMMARY
          echo "- **Validation scope:** GitHub Actions workflows and composite actions" >> $GITHUB_STEP_SUMMARY
          echo "- **Tools used:** yamllint, actionlint, Python YAML, yamlfixer" >> $GITHUB_STEP_SUMMARY
          echo "- **Configuration:** Project-specific .yamllint rules" >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸš€ Auto-Fix Control Guide" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Default Behavior**: Auto-fix is ENABLED by default" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**To disable auto-fix for next commit:**" >> $GITHUB_STEP_SUMMARY
          echo "- Add \`[skip-autofix]\` to your commit message" >> $GITHUB_STEP_SUMMARY
          echo "- Add \`[no-autofix]\` to your commit message" >> $GITHUB_STEP_SUMMARY
          echo "- Add \`[disable-autofix]\` for explicit disable" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**To re-enable auto-fix:**" >> $GITHUB_STEP_SUMMARY
          echo "- Simply commit without any skip flags" >> $GITHUB_STEP_SUMMARY
          echo "- Auto-fix will resume on the next workflow run" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Local testing:**" >> $GITHUB_STEP_SUMMARY
          echo "- Run \`./scripts/utils/validate-yaml.sh --autofix --all-github\` locally" >> $GITHUB_STEP_SUMMARY
          echo "- Test changes before committing" >> $GITHUB_STEP_SUMMARY
